<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis | Ovesh's home</title><meta name="keywords" content="Redis"><meta name="author" content="Ovesh"><meta name="copyright" content="Ovesh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis Redis设计与实现   第一部分  数据结构与对象Chapter 2    简单动态字符串2.0 redis 的简单动态字符串 SDS（simple dynamic string） 当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。 set msg &quot;helloworld&quot;  12345- ### key是 msg ，SDS，value是 ”he">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2022/10/15/Redis/index.html">
<meta property="og:site_name" content="Ovesh&#39;s home">
<meta property="og:description" content="Redis Redis设计与实现   第一部分  数据结构与对象Chapter 2    简单动态字符串2.0 redis 的简单动态字符串 SDS（simple dynamic string） 当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。 set msg &quot;helloworld&quot;  12345- ### key是 msg ，SDS，value是 ”he">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/suzy.jpg">
<meta property="article:published_time" content="2022-10-15T07:16:14.000Z">
<meta property="article:modified_time" content="2022-10-16T02:25:34.427Z">
<meta property="article:author" content="Ovesh">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/suzy.jpg"><link rel="shortcut icon" href="/image/suzy.jpg"><link rel="canonical" href="http://example.com/2022/10/15/Redis/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/Ovesh's%20Home" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-16 10:25:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/background.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/suzy.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ovesh's home</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments-o"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-15T07:16:14.000Z" title="发表于 2022-10-15 15:16:14">2022-10-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-16T02:25:34.427Z" title="更新于 2022-10-16 10:25:34">2022-10-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis%E5%AD%A6%E4%B9%A0/">Redis学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><ul>
<li><h3 id="Redis设计与实现"><a href="#Redis设计与实现" class="headerlink" title="Redis设计与实现"></a>Redis设计与实现</h3></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220718234113983.png" alt="image-20220718234113983"></p>
<h2 id="第一部分-数据结构与对象"><a href="#第一部分-数据结构与对象" class="headerlink" title="第一部分  数据结构与对象"></a>第一部分  数据结构与对象</h2><h2 id="Chapter-2-简单动态字符串"><a href="#Chapter-2-简单动态字符串" class="headerlink" title="Chapter 2    简单动态字符串"></a>Chapter 2    简单动态字符串</h2><h3 id="2-0-redis-的简单动态字符串"><a href="#2-0-redis-的简单动态字符串" class="headerlink" title="2.0 redis 的简单动态字符串"></a>2.0 redis 的简单动态字符串</h3><ul>
<li><h3 id="SDS（simple-dynamic-string）"><a href="#SDS（simple-dynamic-string）" class="headerlink" title="SDS（simple dynamic string）"></a>SDS（simple dynamic string）</h3><ul>
<li><h4 id="当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。"><a href="#当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。" class="headerlink" title="当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。"></a>当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。</h4></li>
<li><pre><code class="redis">set msg &quot;helloworld&quot; 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>- ### key是 msg ，SDS，value是 ”helloworld“ SDS。<br><br>- ~~~redis<br>  RPUSH  fruits &quot;aaple&quot; &quot; bannana	&quot; &quot; cherry  &quot;<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
<li><h4 id="key-是fruits-SDS-，-value-是列表对象，即上面的三种水果。"><a href="#key-是fruits-SDS-，-value-是列表对象，即上面的三种水果。" class="headerlink" title="key 是fruits  SDS  ， value 是列表对象，即上面的三种水果。"></a>key 是fruits  SDS  ， value 是列表对象，即上面的三种水果。</h4></li>
</ul>
</li>
<li><h4 id="SDS还被用作缓冲区（buffer）：AOF模块中的-x3D-x3D-AOF缓冲区-x3D-x3D-，以及客户端状态中的-x3D-x3D-输入缓冲区-x3D-x3D-，都是由SDS实现的。-AOF持久化，客户端状态再展开。"><a href="#SDS还被用作缓冲区（buffer）：AOF模块中的-x3D-x3D-AOF缓冲区-x3D-x3D-，以及客户端状态中的-x3D-x3D-输入缓冲区-x3D-x3D-，都是由SDS实现的。-AOF持久化，客户端状态再展开。" class="headerlink" title="SDS还被用作缓冲区（buffer）：AOF模块中的&#x3D;&#x3D;AOF缓冲区&#x3D;&#x3D;，以及客户端状态中的&#x3D;&#x3D;输入缓冲区&#x3D;&#x3D;，都是由SDS实现的。  AOF持久化，客户端状态再展开。"></a>SDS还被用作缓冲区（buffer）：AOF模块中的&#x3D;&#x3D;AOF缓冲区&#x3D;&#x3D;，以及客户端状态中的&#x3D;&#x3D;输入缓冲区&#x3D;&#x3D;，都是由SDS实现的。  AOF持久化，客户端状态再展开。</h4></li>
</ul>
<h3 id="2-1-SDS-的定义"><a href="#2-1-SDS-的定义" class="headerlink" title="2.1   SDS 的定义"></a>2.1   SDS 的定义</h3><ul>
<li><h4 id="每个sds-h-x2F-sdshadr-结构表示一个sds值。"><a href="#每个sds-h-x2F-sdshadr-结构表示一个sds值。" class="headerlink" title="每个sds.h&#x2F;sdshadr 结构表示一个sds值。"></a>每个sds.h&#x2F;sdshadr 结构表示一个sds值。</h4></li>
<li><p>~~~C<br>struct sdshdr{<br>int len ;<br>int free;<br><br>char buf[];<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>- <br><br><br><br>![image-20220719113053601](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719113053601.png)<br><br><br><br>- #### SDS 遵循了C字符串以空字符结尾的惯例，保存空字符的1字节空间不计算在SDS的len属性里面。==分配1字节和添加空字符到字符串末尾等操作都是由SDS函数自动完成。==<br><br><br><br>- #### 带有未使用空间的SDS示例<br><br><br><br>![image-20220719113448009](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719113448009.png)<br><br><br><br><br><br><br><br>### 2.2  SDS与C语言包字符串的区别<br><br><br><br>1. #### ==C语言使用长度为N+1的字符数组来表示长度为N的字符串，并且字符串最后一个元素总是‘\0’。==<br><br>2. ![image-20220719113649144](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719113649144.png)<br><br>###  <br><br>#### 2.2.1  常数复杂度获取字符串长度。<br><br><br><br>1. #### 因为C语言并不记录自身的长度信息，所以为了获取C字符串的长度必须遍历整个字符串，==知道遇到空字符‘\0==’，时间复杂度==O(n);==<br><br>2. ![image-20220719114447797](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719114447797.png)<br><br><br><br>1. ### 和C字符串不同，SDS在len属性中记录了SDS本身的长度，==所以获取SDS长度的时间复杂度仅为O(1)==<br><br>2. #### ==设置和更新SDS长度的工作由SDS的API在执行时自动完成的==，使用SDS无须进行任何手动修改长度的工作。<br><br><br><br>- #### 通过使用SDS而不是C字符串，Redis 将获取字符串长度所需的复杂度降低到了O(1)，确保了获取字符串长度的工作不会称为Redis的性能瓶颈。<br><br><br><br><br><br>![image-20220719115903576](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719115903576.png)<br><br><br><br><br><br><br><br>#### 2.2.2  杜绝缓冲区溢出<br><br><br><br>1. #### 除了获取字符串长度复杂度高之外，C字符串不记录自身长度带来的另一个问题就是==容易造成缓冲区溢出==（buffer overflow） 。	<br><br>   1. #### 在拼接字符串时就会产生缓冲区溢出。<br><br><br><br><br><br>![image-20220719120931050](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719120931050.png)<br><br><br><br><br><br><br><br>- #### 与C字符串不同，SDS的==空间分配策略==完全杜绝了发生缓冲溢出区的可能性：当SDS的API需要对SDS进行修改时，API会先检查SDS的空间是否满足所需的要求，==如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小。==然后才执行实际的修改操作，所以==使用SDS既不需要手动修改SDS空间的大小，也不会出现前面说的缓冲区溢出问题。==<br><br><br><br><br><br>- ### 例子：<br><br>![image-20220719130035150](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719130035150.png)<br><br><br><br>- #### 注意，SDS，sdscat不仅对这个SDS进行了拼接操作，他还为SDS分配了13字节未使用空间，并且拼接之后的字符串也正好是13字节长，这种现象既不是bug也不是巧合，他和SDS的空间分配策略有关。<br><br><br><br><br><br>#### 2.2.3   减少修改字符串时带来的内存重分配次数。<br><br><br><br>- ### C的重分配例子<br><br>  <br><br>![image-20220719132057121](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719132057121.png)<br><br><br><br><br><br>- #### SDS 重分配例子<br><br>  <br><br>![image-20220719132333976](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719132333976.png)<br><br><br><br>- #### SDS实现了空间预分配和惰性空间释放两种优化策略。<br><br><br><br><br><br>1. #### 空间预分配  <br><br>- #### 空间预分配用于优化SDS的字符串增长操作，当SDS的API对一个SDS进行修改，并且需要对SDS进行空间扩展时，程序不仅会为SDS分配修改所需要的空间，还会为SDS分配额外的未使用空间。<br><br><br><br><br><br>![image-20220719135235769](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719135235769.png)<br><br><br><br><br><br>![image-20220719135305537](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719135305537.png)<br><br>![image-20220719135313995](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719135313995.png)<br><br><br><br><br><br>2. ### 惰性空间释放<br><br><br><br>- #### 惰性空间释放用于优化SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用。<br><br>- #### 举个例子<br><br><br><br>![image-20220719141523550](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719141523550.png)<br><br>![image-20220719141537220](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719141537220.png)<br><br><br><br>![image-20220719141609313](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719141609313.png)<br><br><br><br><br><br><br><br><br><br>#### 2.2.4   二进制安全 <br><br><br><br>C字符串中的字符串必须采用某种编码，并且除了末尾外，字符串里面不能包含空字符串，否则最先被程序读入的空字符串被误认为是字符串结尾，这些限制C字符串只能保存文本数据，而不能保存图片，音频，视频，压缩文件等。这样的二进制数据，<br><br><br><br>- #### 因此，为了确保Redis可以适用于各种不同的场景，==SDS的API都是二进制安全的（binary-safe），==<br><br>- #### 通过使用二进制安全的SDS，而不是C字符串，==使得Redis不仅可以保存文本数据，还可以保存任意格式的二进制数据==。<br><br>  <br><br><br><br>![image-20220719143554737](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719143554737.png)<br><br><br><br><br><br>#### 2.2.5  兼容部分 C字符串函数 <br><br><br><br>- #### 虽然SDS的API是二进制安全的，但==它们一样遵循C字符串以空字符串结尾的惯例==，这些API总会将SDS保存的数据的末尾设置为空字符串，并且总会在buf数组分配空间时多分配一个字节来容纳这个空字符，<br><br><br><br>![image-20220719145737081](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719145737081.png)<br><br><br><br><br><br>![image-20220719145749094](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719145749094.png)<br><br><br><br><br><br><br><br>#### 2.2.6   总结 <br><br><br><br>![image-20220719145807252](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719145807252.png)<br><br><br><br><br><br><br><br><br><br>### 2.3   SDS API  <br><br><br><br>- ### SDS API  中的方法<br><br><br><br>![image-20220719172321593](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719172321593.png)<br><br>![image-20220719172332780](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719172332780.png)<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>## Chapter 3     链表<br><br><br><br><br><br>![image-20220719173825996](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719173825996.png)<br><br><br><br><br><br>![image-20220719173833679](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719173833679.png)<br><br><br><br>### 3.1   链表和链表节点的实现 <br><br><br><br><br><br><br><br>![image-20220719180734478](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180734478.png)<br><br><br><br><br><br>![image-20220719180744228](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180744228.png)<br><br><br><br><br><br>![image-20220719180757535](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180757535.png)<br><br><br><br><br><br><br><br>### 3.2     链表和链表节点的API<br><br><br><br><br><br>![image-20220719180853746](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180853746.png)<br><br><br><br><br><br>![image-20220719180909055](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180909055.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 3.3    重点回顾 <br><br><br><br><br><br>![image-20220719180938120](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719180938120.png)<br><br><br><br><br><br><br><br><br><br>## Chapter 4    字典  <br><br><br><br><br><br>![image-20220719181454795](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719181454795.png)<br><br><br><br>- #### 字典：  key， value  <br><br>  - #### 每个key都是独一无二的<br><br>  - #### 可以。通过key来查找value，也可以通过value来更新更新key。又或者根据key来删除整个键值对。<br><br>- #### C语言并没有字典，Redis 自己创建了字典实现。<br><br>- #### redis 的数据库就是使用字典来作为底层实现的，对数据库中的增删改查，操作也是建立在字典操作之上的。<br><br>- #### 除了用来表示数据库之外，字典还是哈希键的底层实现之一，当一个哈希健包含的键值对比较多又或者键值对中的元素都是比较长的字符串时，Redis就会使用字典作为哈希建的底层实现。<br><br><br><br>- ### 例如：<br><br>![image-20220719182001370](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719182001370.png)<br><br>![image-20220719182118795](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719182118795.png)<br><br><br><br><br><br><br><br><br><br>### 4.1   字典的实现 <br><br><br><br>- ### Redis字典所使用的哈希表由dict.h/dictht  结构定义：<br><br>~~~c<br>typedef struct dictht&#123;<br>    //哈希表数组<br>    dictEntry **table ; <br>    //哈希表大小<br>    unsigned long size ;<br>    //哈希表大小掩码，用于计算索引值，总是等于size-1<br>    unsigned long sizemask;<br>    // 该哈希表已有的节点的数量<br>    unsigned long used;<br>    <br>&#125;dictht;<br><br><br></code></pre></td></tr></table></figure></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719183756075.png" alt="image-20220719183756075"></p>
<h3 id="4-1-2-哈希表节点"><a href="#4-1-2-哈希表节点" class="headerlink" title="4.1.2   哈希表节点"></a>4.1.2   哈希表节点</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719184835864.png" alt="image-20220719184835864"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719184849227.png" alt="image-20220719184849227"></p>
<h3 id="4-1-3-字典"><a href="#4-1-3-字典" class="headerlink" title="4.1.3 字典"></a>4.1.3 字典</h3><ul>
<li><h3 id="Redis-中的字典结构："><a href="#Redis-中的字典结构：" class="headerlink" title="Redis 中的字典结构："></a>Redis 中的字典结构：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dict</span>&#123;</span><br>    dictType *type ;<br>    <br>    <span class="hljs-type">void</span>  *private ;<br>    <br>    dictht ht[<span class="hljs-number">2</span>]; <br>    <br>    <span class="hljs-type">int</span> trehashidx; <br>&#125;dict;<br><br></code></pre></td></tr></table></figure></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719194915084.png" alt="image-20220719194915084"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719195634297.png" alt="image-20220719195634297"></p>
<ul>
<li><h4 id="普通状态下的字典-（没有进行rehash）"><a href="#普通状态下的字典-（没有进行rehash）" class="headerlink" title="普通状态下的字典 （没有进行rehash）"></a>普通状态下的字典 （没有进行rehash）</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719194926747.png" alt="image-20220719194926747"></p>
<h3 id="4-2-哈希算法"><a href="#4-2-哈希算法" class="headerlink" title="4.2  哈希算法"></a>4.2  哈希算法</h3><ul>
<li><h4 id="当需要一个新的键值对添加到字典里面时，-x3D-x3D-程序需要先根据键值对的建计算出哈希值和索引值-x3D-x3D-，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组指定的索引上面。"><a href="#当需要一个新的键值对添加到字典里面时，-x3D-x3D-程序需要先根据键值对的建计算出哈希值和索引值-x3D-x3D-，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组指定的索引上面。" class="headerlink" title="当需要一个新的键值对添加到字典里面时，&#x3D;&#x3D;程序需要先根据键值对的建计算出哈希值和索引值&#x3D;&#x3D;，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组指定的索引上面。"></a>当需要一个新的键值对添加到字典里面时，&#x3D;&#x3D;程序需要先根据键值对的建计算出哈希值和索引值&#x3D;&#x3D;，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组指定的索引上面。</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs redis">hash = dict -&gt; type -&gt;hashFunction(key);<br><br>index = hash &amp; dict -&gt;ht[x].sizemask;<br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719200721220.png" alt="image-20220719200721220"></p>
<ul>
<li><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719200807185.png" alt="image-20220719200807185"></p>
<ol>
<li><h4 id="当字典被用作数据库的底层实现，或者哈希键的底层实现时，-x3D-x3D-Redis使用MurmurHash2算法来计算键的哈希值-x3D-x3D-。"><a href="#当字典被用作数据库的底层实现，或者哈希键的底层实现时，-x3D-x3D-Redis使用MurmurHash2算法来计算键的哈希值-x3D-x3D-。" class="headerlink" title="当字典被用作数据库的底层实现，或者哈希键的底层实现时，&#x3D;&#x3D;Redis使用MurmurHash2算法来计算键的哈希值&#x3D;&#x3D;。"></a>当字典被用作数据库的底层实现，或者哈希键的底层实现时，&#x3D;&#x3D;Redis使用MurmurHash2算法来计算键的哈希值&#x3D;&#x3D;。</h4></li>
<li><h4 id="MurmurHash2算法详情百度或google。"><a href="#MurmurHash2算法详情百度或google。" class="headerlink" title="MurmurHash2算法详情百度或google。"></a>MurmurHash2算法详情百度或google。</h4></li>
</ol>
<h3 id="4-3-解决键冲突"><a href="#4-3-解决键冲突" class="headerlink" title="4.3   解决键冲突"></a>4.3   解决键冲突</h3><ol>
<li><h4 id="x3D-x3D-当有两个或以上数量的键被分配到了哈希表数组的同一个索引上面时，我们称这些键发生了冲突。-x3D-x3D"><a href="#x3D-x3D-当有两个或以上数量的键被分配到了哈希表数组的同一个索引上面时，我们称这些键发生了冲突。-x3D-x3D" class="headerlink" title="&#x3D;&#x3D;当有两个或以上数量的键被分配到了哈希表数组的同一个索引上面时，我们称这些键发生了冲突。&#x3D;&#x3D;"></a>&#x3D;&#x3D;当有两个或以上数量的键被分配到了哈希表数组的同一个索引上面时，我们称这些键发生了冲突。&#x3D;&#x3D;</h4></li>
</ol>
<ul>
<li><h4 id="Redis的哈希表-x3D-x3D-使用链地址法-x3D-x3D-来解决键冲突，每个哈希表节点都没有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。"><a href="#Redis的哈希表-x3D-x3D-使用链地址法-x3D-x3D-来解决键冲突，每个哈希表节点都没有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。" class="headerlink" title="Redis的哈希表&#x3D;&#x3D;使用链地址法&#x3D;&#x3D;来解决键冲突，每个哈希表节点都没有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。"></a>Redis的哈希表&#x3D;&#x3D;使用链地址法&#x3D;&#x3D;来解决键冲突，每个哈希表节点都没有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。</h4></li>
<li><h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719202651939.png" alt="image-20220719202651939"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719202700708.png" alt="image-20220719202700708"></p>
<h3 id="4-4-rehash"><a href="#4-4-rehash" class="headerlink" title="4.4    rehash"></a>4.4    rehash</h3><ol>
<li><h4 id="为了让哈希表的负载因子（load-factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展和收缩。"><a href="#为了让哈希表的负载因子（load-factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展和收缩。" class="headerlink" title="为了让哈希表的负载因子（load factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展和收缩。"></a>为了让哈希表的负载因子（load factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展和收缩。</h4></li>
<li><h4 id="扩展和收缩哈希表的工作可以-x3D-x3D-通过rehash（重新散列）操作-x3D-x3D-来完成，Redis对字典的哈希表执行rehash的步骤如下："><a href="#扩展和收缩哈希表的工作可以-x3D-x3D-通过rehash（重新散列）操作-x3D-x3D-来完成，Redis对字典的哈希表执行rehash的步骤如下：" class="headerlink" title="扩展和收缩哈希表的工作可以&#x3D;&#x3D;通过rehash（重新散列）操作&#x3D;&#x3D;来完成，Redis对字典的哈希表执行rehash的步骤如下："></a>扩展和收缩哈希表的工作可以&#x3D;&#x3D;通过rehash（重新散列）操作&#x3D;&#x3D;来完成，Redis对字典的哈希表执行rehash的步骤如下：</h4><ol>
<li><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719204231115.png" alt="image-20220719204231115"></li>
</ol>
</li>
</ol>
<ul>
<li><h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719205907156.png" alt="image-20220719205907156"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719205917489.png" alt="image-20220719205917489"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719205924774.png" alt="image-20220719205924774"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719205932410.png" alt="image-20220719205932410"></p>
<h3 id="哈希表的扩展与收缩"><a href="#哈希表的扩展与收缩" class="headerlink" title="哈希表的扩展与收缩"></a>哈希表的扩展与收缩</h3><ol>
<li><h4 id="当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作："><a href="#当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作：" class="headerlink" title="当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作："></a>当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作：</h4><ol>
<li><h4 id="服务器目前没有在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于1。"><a href="#服务器目前没有在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于1。" class="headerlink" title="服务器目前没有在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于1。"></a>服务器目前没有在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于1。</h4></li>
<li><h4 id="服务器目前正在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于5。"><a href="#服务器目前正在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于5。" class="headerlink" title="服务器目前正在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于5。"></a>服务器目前正在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于5。</h4></li>
<li><p>~~~redis<br>负载因子 &#x3D; 哈希表已保存的节点数量&#x2F;哈希表大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>   4. <br><br>![image-20220719211609337](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220719211609337.png)<br><br><br><br><br><br>1. #### 根据BGSAVE命令或BGREWRITEAOF命令是否正在执行，服务器进行扩展操作所需的负载因子并不相同，这是因为在执行BGSAVE命令或BGREWRITEAOF命令的过程中，Redis需要创建当前服务器进程的子效率，进而大多数操作系统都采用==写时复制技术==来优化子进程的使用效率。<br><br>2. #### 所以在子进程存在期间，服务器会提高执行扩展操作所需的负载因子，从而尽可能地避免在子进程存在期间进行哈希表扩展操作，这可以避免不要的内存写入操作，最大限度地节约内存。<br><br>3. #### 另一方面，==当哈希表地负载因子小于0.1时，程序自动开始对哈希表执行收缩操作。==<br><br><br><br><br><br><br><br><br><br>### 4.5   渐进式 rehash <br><br><br><br><br><br>![image-20220720093618710](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093618710.png)<br><br>![image-20220720093625250](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093625250.png)<br><br>![image-20220720093636084](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093636084.png)<br><br>![image-20220720093642733](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093642733.png)<br><br>![image-20220720093650158](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093650158.png)<br><br>![image-20220720093657083](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093657083.png)<br><br>![image-20220720093704611](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093704611.png)<br><br><br><br>![image-20220720093711131](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720093711131.png)<br><br><br><br><br><br><br><br><br><br>### 渐进式rehash 执行期间的哈希表操作<br><br><br><br><br><br>1. #### 因为在进行渐进式hash的过程中，字典会同时使用ht[0]和ht[1]两个哈希表，所以在渐进式rehash期间，字典的删除，查找，更新，会在两个哈希表上进行。例如，要在字典里查找一个键的话，程序会现在ht[0]里面查找，如果没找到的话，就会继续道ht[1]里面进行查找，诸如此类。<br><br>2. #### 另外，在渐进式rehash执行期间，新添加到字典的键值对一律会保存到ht[1]里面，而ht[0]则不再进行任何添加操作，这一措施保证了ht[0]包含的键值对数量会只减少不增加，并随着rehash操作的执行而最终变成空表。<br><br><br><br><br><br>### 4.6  字典API<br><br><br><br><br><br>![image-20220720094825588](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720094825588.png)<br><br>![image-20220720094833281](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720094833281.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 4.7  重点回顾<br><br><br><br><br><br><br><br>![image-20220720094846213](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720094846213.png)<br><br>1. #### 字典被广泛用于实现Redis的各种功能，其中包括数据库和哈希键<br><br>2. #### Redis中的字典使用哈希表作为底层实现，每个字典带有两个哈希表，一个平时使用，另一个仅在进行rehash时使用<br><br>3. #### 当字典被用作数据库的底层实现，或者哈希键的底层实现，Redis使用MurmurHash2算法来计算键的哈希值<br><br>4. #### 哈希表使用链地址法来解决冲突，被分配到同一个索引上的多个键值对会连接成一个单向链表<br><br>5. #### 在对哈希表进行扩展或者收缩操作时，程序需要将现有的哈希表包含的所有键值对rehash到新哈希表里面，并且这个rehash过程并不是一次性地完成的，而是渐进式地完成。<br><br><br><br><br><br><br><br><br><br><br><br>## Chapter 5    跳跃表 <br><br><br><br>1. #### 跳跃表是一种有序数据结构，他通过在每个节点维持多个指向其他节点的指针，从而达到快速访问节点的目的。<br><br>2. #### 跳跃表支持平均O(logN),最坏O(N)复杂度的节点查找，还可以通过顺序性操作来批量处理节点。<br><br>3. #### 在大部分情况下，跳跃表的效率可以和平衡树相媲美，并且因为跳跃表的实现比平衡树来得更为简单，所以不少程序都是用跳跃表来代替平衡树。<br><br>4. #### Redis==使用跳跃表作为有序集合键的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中元素的成员是比较长的字符串时，Redis就会使用跳跃表来作为有序集合键的底层实现。<br><br><br><br>- ### 例子<br><br><br><br>![image-20220720134211562](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720134211562.png)<br><br>1. #### Redis只在两个地方用到了跳跃表，一个是实现有序集合键，另一个是在集群节点中用作内部数据结构，除此之外，跳跃表在Redis里面没有其他用途。<br><br><br><br><br><br>### 5.1  跳跃表的实现<br><br><br><br>![image-20220720134452961](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720134452961.png)<br><br><br><br>1. ### header：指向跳跃表的表头节点<br><br>2. ### tail：指向跳跃表的表为节点<br><br>3. ### level：记录目前跳跃表内，层数最大的那个节点的层数（表头节点的层数不计在内）<br><br>4. ### length：记录跳跃表的长度，也即是，跳跃表目前包含节点的数量（表头节点不计在内）。<br><br>![image-20220720134710190](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720134710190.png)<br><br>![image-20220720134714469](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720134714469.png)<br><br><br><br><br><br><br><br>#### 5.1.1   跳跃表的节点<br><br><br><br><br><br>![image-20220720135557350](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135557350.png)<br><br>![image-20220720135605404](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135605404.png)<br><br>![image-20220720135617248](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135617248.png)<br><br><br><br>![image-20220720135626549](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135626549.png)<br><br>![image-20220720135642211](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135642211.png)<br><br><br><br>![image-20220720135650430](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135650430.png)<br><br>![image-20220720135705745](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135705745.png)<br><br><br><br>![image-20220720135714213](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135714213.png)<br><br><br><br>![image-20220720135725067](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135725067.png)<br><br>![image-20220720135736998](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135736998.png)<br><br><br><br><br><br>![image-20220720135744934](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135744934.png)<br><br><br><br><br><br>### 5.2  跳跃表API<br><br><br><br><br><br>![image-20220720135852895](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135852895.png)<br><br>![image-20220720135903029](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720135903029.png)<br><br><br><br><br><br><br><br><br><br>### 5.3    重点回顾 <br><br><br><br>1. #### 跳跃表是有序集合的底层实现之一<br><br>2. #### Redis的跳跃表实现由zskiplist和zskiplistNode 两个结构组成，其中zskiplist用于跳跃表信息，而zskiplistNode则用于表示跳跃表的节点<br><br>3. #### 每个跳跃表节点的层高都是1~32之间的随机数<br><br>4. #### 在同一个跳跃表中，多个节点可以包含相同的分值，但每个节点的成员对象必须是唯一的<br><br>5. #### 跳跃表中的节点按照分值大小进行排序，当分值相同时，节点按照成员对象的大小进行排序。<br><br><br><br><br><br><br><br>## Chapter 6   整数集合<br><br><br><br><br><br>1. #### 整数集合(inset)是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合键的底层实现。<br><br><br><br>- ### 例子<br><br>  <br><br>![image-20220720141925889](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720141925889.png)<br><br><br><br><br><br>### 6.1    整数集合的实现<br><br><br><br>1. ### 整数集合是Redis用于保存整数值的集合抽象数据结构，它可以保存类型为 int 16_t, int32_t 或者 int 64_t 的整数值，并且保证集合中不会出现重复元素。<br><br>2. ~~~c<br>   typedef struct intset&#123;<br>       <br>   &#125;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720143828417.png" alt="image-20220720143828417"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720143839627.png" alt="image-20220720143839627"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720143847027.png" alt="image-20220720143847027"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720143853556.png" alt="image-20220720143853556"></p>
<h3 id="6-2-升级"><a href="#6-2-升级" class="headerlink" title="6.2 升级"></a>6.2 升级</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144217056.png" alt="image-20220720144217056"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144248694.png" alt="image-20220720144248694"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144301391.png" alt="image-20220720144301391"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144320128.png" alt="image-20220720144320128"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144327430.png" alt="image-20220720144327430"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720144347076.png" alt="image-20220720144347076"></p>
<h3 id="6-3-升级的好处"><a href="#6-3-升级的好处" class="headerlink" title="6.3  升级的好处"></a>6.3  升级的好处</h3><ul>
<li><h3 id="整数集合的升级策略有两个策略，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。"><a href="#整数集合的升级策略有两个策略，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。" class="headerlink" title="整数集合的升级策略有两个策略，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。"></a>整数集合的升级策略有两个策略，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。</h3></li>
</ul>
<h4 id="6-3-1-提升灵活性"><a href="#6-3-1-提升灵活性" class="headerlink" title="6.3.1   提升灵活性"></a>6.3.1   提升灵活性</h4><ol>
<li><h4 id="因为C语言是静态语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。"><a href="#因为C语言是静态语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。" class="headerlink" title="因为C语言是静态语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。"></a>因为C语言是静态语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。</h4><ol>
<li><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720180513062.png" alt="image-20220720180513062"></li>
</ol>
</li>
</ol>
<h4 id="6-3-2-节约内存"><a href="#6-3-2-节约内存" class="headerlink" title="6.3.2   节约内存"></a>6.3.2   节约内存</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720180653392.png" alt="image-20220720180653392"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720180701394.png" alt="image-20220720180701394"></p>
<h3 id="6-4-降级"><a href="#6-4-降级" class="headerlink" title="6.4  降级"></a>6.4  降级</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720180843745.png" alt="image-20220720180843745"></p>
<h3 id="6-5-整数集合API"><a href="#6-5-整数集合API" class="headerlink" title="6.5    整数集合API"></a>6.5    整数集合API</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720181335090.png" alt="image-20220720181335090"></p>
<h3 id="6-6-重点回顾"><a href="#6-6-重点回顾" class="headerlink" title="6.6    重点回顾"></a>6.6    重点回顾</h3><ol>
<li><h4 id="整数集合是集合键的底层实现之一"><a href="#整数集合是集合键的底层实现之一" class="headerlink" title="整数集合是集合键的底层实现之一"></a>整数集合是集合键的底层实现之一</h4></li>
<li><h4 id="整数集合的底层实现为数组，这个数组以有序，无重复的方式保存集合元素，在有需要时，程序会根据新添加的元素的类型，改变这个数组的类型"><a href="#整数集合的底层实现为数组，这个数组以有序，无重复的方式保存集合元素，在有需要时，程序会根据新添加的元素的类型，改变这个数组的类型" class="headerlink" title="整数集合的底层实现为数组，这个数组以有序，无重复的方式保存集合元素，在有需要时，程序会根据新添加的元素的类型，改变这个数组的类型"></a>整数集合的底层实现为数组，这个数组以有序，无重复的方式保存集合元素，在有需要时，程序会根据新添加的元素的类型，改变这个数组的类型</h4></li>
<li><h4 id="升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存"><a href="#升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存" class="headerlink" title="升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存"></a>升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存</h4></li>
<li><h4 id="整数集合只支持升级操作，不支持降级操作。"><a href="#整数集合只支持升级操作，不支持降级操作。" class="headerlink" title="整数集合只支持升级操作，不支持降级操作。"></a>整数集合只支持升级操作，不支持降级操作。</h4></li>
</ol>
<h2 id="Chapter-7-压缩列表"><a href="#Chapter-7-压缩列表" class="headerlink" title="Chapter 7    压缩列表"></a>Chapter 7    压缩列表</h2><ol>
<li><h4 id="压缩列表是列表键和哈希键的底层实现之一。当一个列标键只包含少量列表项，并且每个列表项要么就是最小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来坐列标键的底层实现。"><a href="#压缩列表是列表键和哈希键的底层实现之一。当一个列标键只包含少量列表项，并且每个列表项要么就是最小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来坐列标键的底层实现。" class="headerlink" title="压缩列表是列表键和哈希键的底层实现之一。当一个列标键只包含少量列表项，并且每个列表项要么就是最小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来坐列标键的底层实现。"></a>压缩列表是列表键和哈希键的底层实现之一。当一个列标键只包含少量列表项，并且每个列表项要么就是最小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来坐列标键的底层实现。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720183339311.png" alt="image-20220720183339311"></p>
<ul>
<li><h4 id="另外，当一个哈希键只包含少量键值对，并且每个键值对的键和值要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列标来做哈希键的底层实现，"><a href="#另外，当一个哈希键只包含少量键值对，并且每个键值对的键和值要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列标来做哈希键的底层实现，" class="headerlink" title="另外，当一个哈希键只包含少量键值对，并且每个键值对的键和值要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列标来做哈希键的底层实现，"></a>另外，当一个哈希键只包含少量键值对，并且每个键值对的键和值要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列标来做哈希键的底层实现，</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720184605273.png" alt="image-20220720184605273"></p>
<h3 id="7-1-压缩列表的构成"><a href="#7-1-压缩列表的构成" class="headerlink" title="7.1   压缩列表的构成"></a>7.1   压缩列表的构成</h3><ol>
<li><h4 id="压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的连续内存组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。"><a href="#压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的连续内存组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。" class="headerlink" title="压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的连续内存组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。"></a>压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的连续内存组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720185208190.png" alt="image-20220720185208190"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720185228226.png" alt="image-20220720185228226"></p>
<h3 id="7-2-压缩列表节点的构成"><a href="#7-2-压缩列表节点的构成" class="headerlink" title="7.2   压缩列表节点的构成"></a>7.2   压缩列表节点的构成</h3><ol>
<li><h4 id="每个压缩列表节点可以保存一个字节数组或者一个整数值，其中，字节数组可以是一下三种长度的其中一种："><a href="#每个压缩列表节点可以保存一个字节数组或者一个整数值，其中，字节数组可以是一下三种长度的其中一种：" class="headerlink" title="每个压缩列表节点可以保存一个字节数组或者一个整数值，其中，字节数组可以是一下三种长度的其中一种："></a>每个压缩列表节点可以保存一个字节数组或者一个整数值，其中，字节数组可以是一下三种长度的其中一种：</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720185623101.png" alt="image-20220720185623101"></p>
<h4 id="7-2-1-previous-entry-length"><a href="#7-2-1-previous-entry-length" class="headerlink" title="7.2.1    previous_entry_length"></a>7.2.1    previous_entry_length</h4><ol>
<li><h4 id="节点的previous-entry-length-属性以字节为单位，记录了压缩列表中前一个节点的长度。"><a href="#节点的previous-entry-length-属性以字节为单位，记录了压缩列表中前一个节点的长度。" class="headerlink" title="节点的previous_entry_length 属性以字节为单位，记录了压缩列表中前一个节点的长度。"></a>节点的previous_entry_length 属性以字节为单位，记录了压缩列表中前一个节点的长度。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220720190049645.png" alt="image-20220720190049645"></p>
<h4 id="7-2-2-encoding"><a href="#7-2-2-encoding" class="headerlink" title="7.2.2  encoding"></a>7.2.2  encoding</h4><h4 id="7-2-3-content"><a href="#7-2-3-content" class="headerlink" title="7.2.3  content"></a>7.2.3  content</h4><h3 id="7-3-连锁更新"><a href="#7-3-连锁更新" class="headerlink" title="7.3   连锁更新"></a>7.3   连锁更新</h3><h3 id="7-4-压缩列表API"><a href="#7-4-压缩列表API" class="headerlink" title="7.4  压缩列表API"></a>7.4  压缩列表API</h3><h3 id="7-5-重点回顾"><a href="#7-5-重点回顾" class="headerlink" title="7.5 重点回顾"></a>7.5 重点回顾</h3><ol>
<li><h4 id="压缩列表是一种为了节约内存而开发的顺序型数据结构"><a href="#压缩列表是一种为了节约内存而开发的顺序型数据结构" class="headerlink" title="压缩列表是一种为了节约内存而开发的顺序型数据结构"></a>压缩列表是一种为了节约内存而开发的顺序型数据结构</h4></li>
<li><h4 id="压缩列表被用作列表键和哈希键的底层实现之一"><a href="#压缩列表被用作列表键和哈希键的底层实现之一" class="headerlink" title="压缩列表被用作列表键和哈希键的底层实现之一"></a>压缩列表被用作列表键和哈希键的底层实现之一</h4></li>
<li><h4 id="压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值"><a href="#压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值" class="headerlink" title="压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值"></a>压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值</h4></li>
<li><h4 id="添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引起连锁更新操作，但这种操作出现的几率并不高。"><a href="#添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引起连锁更新操作，但这种操作出现的几率并不高。" class="headerlink" title="添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引起连锁更新操作，但这种操作出现的几率并不高。"></a>添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引起连锁更新操作，但这种操作出现的几率并不高。</h4></li>
</ol>
<h2 id="Chapter-8-对象"><a href="#Chapter-8-对象" class="headerlink" title="Chapter  8     对象"></a>Chapter  8     对象</h2><ol>
<li><h4 id="前面了解了Redis用到的所有主要数据结构，比如简单字符串（SDS），双端链表，字典，压缩列表，整数集合等等"><a href="#前面了解了Redis用到的所有主要数据结构，比如简单字符串（SDS），双端链表，字典，压缩列表，整数集合等等" class="headerlink" title="前面了解了Redis用到的所有主要数据结构，比如简单字符串（SDS），双端链表，字典，压缩列表，整数集合等等"></a>前面了解了Redis用到的所有主要数据结构，比如简单字符串（SDS），双端链表，字典，压缩列表，整数集合等等</h4></li>
<li><h4 id="Redis对象系统：-字符串对象，列表对象，哈希对象，集合对象，和有序集合对象-五种不同类型的对象"><a href="#Redis对象系统：-字符串对象，列表对象，哈希对象，集合对象，和有序集合对象-五种不同类型的对象" class="headerlink" title="Redis对象系统： 字符串对象，列表对象，哈希对象，集合对象，和有序集合对象 五种不同类型的对象"></a>Redis对象系统： 字符串对象，列表对象，哈希对象，集合对象，和有序集合对象 五种不同类型的对象</h4></li>
<li><h4 id="Redis在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令，使用对象的另一个好处就是，我们可以针对不同的使用场景为对象设置不同的数据结构实现，从而优化对象在不同场景下的使用效率"><a href="#Redis在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令，使用对象的另一个好处就是，我们可以针对不同的使用场景为对象设置不同的数据结构实现，从而优化对象在不同场景下的使用效率" class="headerlink" title="Redis在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令，使用对象的另一个好处就是，我们可以针对不同的使用场景为对象设置不同的数据结构实现，从而优化对象在不同场景下的使用效率"></a>Redis在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令，使用对象的另一个好处就是，我们可以针对不同的使用场景为对象设置不同的数据结构实现，从而优化对象在不同场景下的使用效率</h4></li>
<li><h4 id="初次之外，Redis对象系统还实现了-x3D-x3D-基于引用计数技术的内存回收机制，当场景不在使用某个对象时，这个对象所占有的内存就会被自动释放。"><a href="#初次之外，Redis对象系统还实现了-x3D-x3D-基于引用计数技术的内存回收机制，当场景不在使用某个对象时，这个对象所占有的内存就会被自动释放。" class="headerlink" title="初次之外，Redis对象系统还实现了&#x3D;&#x3D;基于引用计数技术的内存回收机制，当场景不在使用某个对象时，这个对象所占有的内存就会被自动释放。"></a>初次之外，Redis对象系统还实现了&#x3D;&#x3D;基于引用计数技术的内存回收机制，当场景不在使用某个对象时，这个对象所占有的内存就会被自动释放。</h4></li>
<li><h4 id="另外Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库共享同一个对象来节约内存。"><a href="#另外Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库共享同一个对象来节约内存。" class="headerlink" title="另外Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库共享同一个对象来节约内存。"></a>另外Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库共享同一个对象来节约内存。</h4></li>
<li><h4 id="最后Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。"><a href="#最后Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。" class="headerlink" title="最后Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。"></a>最后Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。</h4></li>
</ol>
<h3 id="8-1-对象的类型与编码"><a href="#8-1-对象的类型与编码" class="headerlink" title="8.1  对象的类型与编码"></a>8.1  对象的类型与编码</h3><ol>
<li><h4 id="Redis-使用对象来表示数据库中的键值对，当在数据库中创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键，key对象，另一个对象用作键值对的值，值对象。"><a href="#Redis-使用对象来表示数据库中的键值对，当在数据库中创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键，key对象，另一个对象用作键值对的值，值对象。" class="headerlink" title="Redis 使用对象来表示数据库中的键值对，当在数据库中创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键，key对象，另一个对象用作键值对的值，值对象。"></a>Redis 使用对象来表示数据库中的键值对，当在数据库中创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键，key对象，另一个对象用作键值对的值，值对象。</h4></li>
<li><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721102331098.png" alt="image-20220721102331098"></p>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721102339218.png" alt="image-20220721102339218"></p>
<h4 id="8-1-1-类型"><a href="#8-1-1-类型" class="headerlink" title="8.1.1   类型"></a>8.1.1   类型</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721102514528.png" alt="image-20220721102514528"></p>
<ul>
<li><h3 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h3></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103229490.png" alt="image-20220721103229490"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103244361.png" alt="image-20220721103244361"></p>
<h4 id="8-1-2-编码和底层实现"><a href="#8-1-2-编码和底层实现" class="headerlink" title="8.1.2   编码和底层实现"></a>8.1.2   编码和底层实现</h4><ol>
<li><h4 id="对象的ptr-指针指向对象的底层实现数据结构，而这些数据结构由对象的encoding属性决定。"><a href="#对象的ptr-指针指向对象的底层实现数据结构，而这些数据结构由对象的encoding属性决定。" class="headerlink" title="对象的ptr 指针指向对象的底层实现数据结构，而这些数据结构由对象的encoding属性决定。"></a>对象的ptr 指针指向对象的底层实现数据结构，而这些数据结构由对象的encoding属性决定。</h4></li>
<li><h4 id="。"><a href="#。" class="headerlink" title="。"></a><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103724846.png" alt="image-20220721103724846">。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103825377.png" alt="image-20220721103825377"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103839424.png" alt="image-20220721103839424"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721103847381.png" alt="image-20220721103847381"></p>
<h3 id="8-2-字符串对象"><a href="#8-2-字符串对象" class="headerlink" title="8.2  字符串对象"></a>8.2  字符串对象</h3><ol>
<li><h4 id="字符串对象的编码可以是int，raw，或者embstr"><a href="#字符串对象的编码可以是int，raw，或者embstr" class="headerlink" title="字符串对象的编码可以是int，raw，或者embstr"></a>字符串对象的编码可以是int，raw，或者embstr</h4></li>
<li><h4 id="如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void-换成long），并将字符串对象的编码设置为int"><a href="#如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void-换成long），并将字符串对象的编码设置为int" class="headerlink" title="如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void * 换成long），并将字符串对象的编码设置为int"></a>如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void * 换成long），并将字符串对象的编码设置为int</h4></li>
<li><h4 id="如果字符串值得长度大于32字节，编码将会是raw，如果小于等于32字节，那么将会使用embstr编码来保存这个字符串值。"><a href="#如果字符串值得长度大于32字节，编码将会是raw，如果小于等于32字节，那么将会使用embstr编码来保存这个字符串值。" class="headerlink" title="如果字符串值得长度大于32字节，编码将会是raw，如果小于等于32字节，那么将会使用embstr编码来保存这个字符串值。"></a>如果字符串值得长度大于32字节，编码将会是raw，如果小于等于32字节，那么将会使用embstr编码来保存这个字符串值。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104411292.png" alt="image-20220721104411292"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104422667.png" alt="image-20220721104422667"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104433994.png" alt="image-20220721104433994"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104441013.png" alt="image-20220721104441013"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104447492.png" alt="image-20220721104447492"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104459154.png" alt="image-20220721104459154"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721104506055.png" alt="image-20220721104506055"></p>
<h4 id="8-2-1-编码的转换"><a href="#8-2-1-编码的转换" class="headerlink" title="8.2.1      编码的转换"></a>8.2.1      编码的转换</h4><ol>
<li><h4 id="int-编码的字符串对象和embstr编码的字符串对象在条件满足的情况下，会被转换为raw编码的字符串对象"><a href="#int-编码的字符串对象和embstr编码的字符串对象在条件满足的情况下，会被转换为raw编码的字符串对象" class="headerlink" title="int 编码的字符串对象和embstr编码的字符串对象在条件满足的情况下，会被转换为raw编码的字符串对象"></a>int 编码的字符串对象和embstr编码的字符串对象在条件满足的情况下，会被转换为raw编码的字符串对象</h4></li>
<li><h4 id="。-1"><a href="#。-1" class="headerlink" title="。"></a><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721123726455.png" alt="image-20220721123726455">。</h4></li>
<li></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721123737192.png" alt="image-20220721123737192"></p>
<h4 id="8-2-2-字符串命令的实现"><a href="#8-2-2-字符串命令的实现" class="headerlink" title="8.2.2   字符串命令的实现"></a>8.2.2   字符串命令的实现</h4><ol>
<li><h4 id="因为字符串键的值为字符串对象，所以用于字符串键的所有命令"><a href="#因为字符串键的值为字符串对象，所以用于字符串键的所有命令" class="headerlink" title="因为字符串键的值为字符串对象，所以用于字符串键的所有命令"></a>因为字符串键的值为字符串对象，所以用于字符串键的所有命令</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721163233735.png" alt="image-20220721163233735"></p>
<h3 id="8-3-列表对象"><a href="#8-3-列表对象" class="headerlink" title="8.3    列表对象"></a>8.3    列表对象</h3><ol>
<li><h4 id="列表对象的编码可以是ziplist或者linkedlist"><a href="#列表对象的编码可以是ziplist或者linkedlist" class="headerlink" title="列表对象的编码可以是ziplist或者linkedlist"></a>列表对象的编码可以是ziplist或者linkedlist</h4></li>
<li><h4 id="ziplist编码的列表对象使用-x3D-x3D-压缩列表作为底层实现-x3D-x3D-，每个压缩列表节点保存了一个列表元素，。、"><a href="#ziplist编码的列表对象使用-x3D-x3D-压缩列表作为底层实现-x3D-x3D-，每个压缩列表节点保存了一个列表元素，。、" class="headerlink" title="ziplist编码的列表对象使用&#x3D;&#x3D;压缩列表作为底层实现&#x3D;&#x3D;，每个压缩列表节点保存了一个列表元素，。、"></a>ziplist编码的列表对象使用&#x3D;&#x3D;压缩列表作为底层实现&#x3D;&#x3D;，每个压缩列表节点保存了一个列表元素，。、</h4></li>
<li><p>~~~redis<br>RPUSH numbers 1 “three” 5  (integer) 3 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>4. #### 如果numbers键的对象使用的是ziplist编码，这个价值对象将会是图8-5所展示ide样子。<br><br>![image-20220721164721742](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721164721742.png)<br><br><br><br>1. #### linkedlist 编码的列表对象使用双端列表作为底层实现，每个双端链表节点node都保存了一个字符串对象，而每个字符串对象都保存了一个列表元素。<br><br>2. #### 例：<br><br>![image-20220721164850980](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721164850980.png)<br><br><br><br>- #### 注意，linkedlist编码的列表对象在底层的双端链表结构中包含了许多个字符串对象，这种嵌套字符串对象在哈希对象，集合对象，有序集合对象都会出现。==字符串对象是Redis五种类型的对象中唯一一种会被其他四种类型对象嵌套的对象==。<br><br><br><br>![image-20220721165205327](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721165205327.png)<br><br><br><br><br><br><br><br><br><br><br><br>#### 8.3.1   编码转换 <br><br><br><br>1. #### 当列表对象可以同时满足一下两个条件时，列表对象使用ziplist编码：<br><br>   1. #### 列表对象保存的所有字符串元素的长度都小于64字节<br><br>   2. #### 列表对象保存的元素数量小于512个；不能满足这两个条件的列表对象需要使用linkedlist编码。<br><br><br><br>![image-20220721170034264](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721170034264.png)<br><br><br><br>1. #### 对于使用ziplist编码的列表对象来说，当使用ziplist编码所需的两个条件的任意一个不满足时，对象的编码转换操作就会被执行，原本保存在压缩列表里的所有列表元素都会被转移并保存到双端链表里面，对象的编码也会从ziplist变为linkedlist。<br><br><br><br>![image-20220721170610104](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721170610104.png)<br><br><br><br>![image-20220721170823367](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721170823367.png)<br><br><br><br><br><br>#### 8.3.2   列表命令的实现 <br><br><br><br>1. #### 因为列表键的值为列表对象，所以用于列表键的所有命令都是针对列表对象来构建的。<br><br><br><br>![image-20220721172414371](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721172414371.png)<br><br><br><br>![image-20220721172423309](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721172423309.png)<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>### 8.4    哈希对象 <br><br><br><br>1. #### 哈希对象的编码可以是==ziplist或者hashtable== 。<br><br>2. #### ziplist 编码的哈希对象使用压缩列表作为底层实现，每当有新的键值对要加入到哈希对象时，程序会先将保存了键的压缩列表节点推入到压缩列表表尾，然后再将保存了值的压缩列表节点推入到压缩列表表尾。<br><br>   1. #### 保存了同一键值对的两个节点总是紧挨在一起保存键的节点在前，保存值的节点在后<br><br>   2. #### 先添加到哈希对象中的键值对会被放在压缩列表的表头方向，而后来添加到哈希表对象中的键值对会被放在压缩列表的表尾方向。<br><br><br><br><br><br>![image-20220721174813475](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721174813475.png)<br><br><br><br>![image-20220721174820931](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721174820931.png)<br><br><br><br>![image-20220721175352541](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721175352541.png)<br><br><br><br><br><br><br><br><br><br>#### 8.4.1    编码转换<br><br><br><br>1. #### 当哈希对象可以同时满足以下两个条件是，哈希对象使用ziplist编码：<br><br>   - #### 当哈希对象保存的所有键值对的键和值的字符串长度小于64字节；<br><br>   - #### 哈希对象保存的键值对数量小于512个；<br><br>   - #### 不能满足这两个条件的哈希对象需要使用hashtable编码。<br><br><br><br><br><br>![image-20220721181759018](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721181759018.png)<br><br><br><br><br><br>![image-20220721181818265](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721181818265.png)<br><br><br><br>![image-20220721181835794](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721181835794.png)<br><br><br><br><br><br>![image-20220721182037363](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721182037363.png)<br><br><br><br><br><br><br><br>#### 8.4.2  哈希命令的实现<br><br><br><br><br><br>![image-20220721202800495](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721202800495.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 8.5    集合对象  <br><br><br><br>1. #### 集合对象的编码可以是intset或者是hashtable<br><br>2. #### intset编码的集合对象使用整数集合作为底层实现，集合对象包含的苏所有元素都被保存在整数集合里面。<br><br><br><br>~~~redis<br>SADD numbers 1 3 5 (Integer)  3<br></code></pre></td></tr></table></figure></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721211741201.png" alt="image-20220721211741201"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721211749030.png" alt="image-20220721211749030"></p>
<h4 id="8-5-1-编码的转换"><a href="#8-5-1-编码的转换" class="headerlink" title="8.5.1     编码的转换"></a>8.5.1     编码的转换</h4><ol>
<li><h4 id="当集合对象可以同时满足以下两个条件时，对象使用intset编码："><a href="#当集合对象可以同时满足以下两个条件时，对象使用intset编码：" class="headerlink" title="当集合对象可以同时满足以下两个条件时，对象使用intset编码："></a>当集合对象可以同时满足以下两个条件时，对象使用intset编码：</h4><ol>
<li><h4 id="集合对象保存的所有元素都是整数值"><a href="#集合对象保存的所有元素都是整数值" class="headerlink" title="集合对象保存的所有元素都是整数值"></a>集合对象保存的所有元素都是整数值</h4></li>
<li><h4 id="集合对象保存的元素不超过512个。"><a href="#集合对象保存的元素不超过512个。" class="headerlink" title="集合对象保存的元素不超过512个。"></a>集合对象保存的元素不超过512个。</h4></li>
<li><h4 id="不能满足这两个条件的集合对象需要使用hashtable编码"><a href="#不能满足这两个条件的集合对象需要使用hashtable编码" class="headerlink" title="不能满足这两个条件的集合对象需要使用hashtable编码"></a>不能满足这两个条件的集合对象需要使用hashtable编码</h4></li>
</ol>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721212231896.png" alt="image-20220721212231896"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220721213024699.png" alt="image-20220721213024699"></p>
<h3 id="8-6-有序集合对象"><a href="#8-6-有序集合对象" class="headerlink" title="8.6    有序集合对象"></a>8.6    有序集合对象</h3><h3 id="8-7-类型检查与命令多态"><a href="#8-7-类型检查与命令多态" class="headerlink" title="8.7        类型检查与命令多态"></a>8.7        类型检查与命令多态</h3><ol>
<li><h4 id="Redis-中用于操作键的命令基本上可以分为两种类型"><a href="#Redis-中用于操作键的命令基本上可以分为两种类型" class="headerlink" title="Redis 中用于操作键的命令基本上可以分为两种类型:"></a>Redis 中用于操作键的命令基本上可以分为两种类型:</h4><ol>
<li><h4 id="其中一种命令可以对任何类型的键执行-x3D-x3D-比如说-DEL命令-EXPIRE命令-rename命令-type命令-object-命令。"><a href="#其中一种命令可以对任何类型的键执行-x3D-x3D-比如说-DEL命令-EXPIRE命令-rename命令-type命令-object-命令。" class="headerlink" title="其中一种命令可以对任何类型的键执行:  &#x3D;&#x3D;比如说 DEL命令,EXPIRE命令,rename命令,type命令,object 命令。"></a>其中一种命令可以对任何类型的键执行:  &#x3D;&#x3D;比如说 DEL命令,EXPIRE命令,rename命令,type命令,object 命令。</h4></li>
</ol>
</li>
<li><h4 id="FOR-example"><a href="#FOR-example" class="headerlink" title="FOR example"></a>FOR example</h4></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs redis">set msg &quot;hello&quot;	 <br><br>rpush numbers 1 2 3 <br><br>sadd fruits apple banana cherry<br><br>del msg<br>del numbers<br>del fruits<br><br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725201932392.png" alt="image-20220725201932392"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725201946359.png" alt="image-20220725201946359"></p>
<h4 id="8-7-1-类型检查的实现"><a href="#8-7-1-类型检查的实现" class="headerlink" title="8.7.1   类型检查的实现"></a>8.7.1   类型检查的实现</h4><ol>
<li><h4 id="在执行一个类型特定命令之前，Redis-会先-检查插入键的类型是否正确，然后再决定是否执行给定的命令。"><a href="#在执行一个类型特定命令之前，Redis-会先-检查插入键的类型是否正确，然后再决定是否执行给定的命令。" class="headerlink" title="在执行一个类型特定命令之前，Redis 会先 检查插入键的类型是否正确，然后再决定是否执行给定的命令。"></a>在执行一个类型特定命令之前，Redis 会先 检查插入键的类型是否正确，然后再决定是否执行给定的命令。</h4><ul>
<li><h4 id="类型特定命令所进行的类型检查是通过redisObject-结构的type实行来实现的："><a href="#类型特定命令所进行的类型检查是通过redisObject-结构的type实行来实现的：" class="headerlink" title="类型特定命令所进行的类型检查是通过redisObject 结构的type实行来实现的："></a>类型特定命令所进行的类型检查是通过redisObject 结构的type实行来实现的：</h4><ul>
<li><h4 id=""><a href="#" class="headerlink" title="."></a>.</h4></li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725202416976.png"></p>
<h4 id="8-7-2-多态命令的实现"><a href="#8-7-2-多态命令的实现" class="headerlink" title="8.7.2     多态命令的实现"></a>8.7.2     多态命令的实现</h4><ol>
<li><h4 id="Redis-除了会根据对像的类型来判断键是否能够执行指定命令之外，还会根据对象的编码方式，选择正确的命令实现代码来执行命令。"><a href="#Redis-除了会根据对像的类型来判断键是否能够执行指定命令之外，还会根据对象的编码方式，选择正确的命令实现代码来执行命令。" class="headerlink" title="Redis 除了会根据对像的类型来判断键是否能够执行指定命令之外，还会根据对象的编码方式，选择正确的命令实现代码来执行命令。"></a>Redis 除了会根据对像的类型来判断键是否能够执行指定命令之外，还会根据对象的编码方式，选择正确的命令实现代码来执行命令。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725202932886.png" alt="image-20220725202932886"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725202958378.png" alt="image-20220725202958378"></p>
<h3 id="8-8-内存回收"><a href="#8-8-内存回收" class="headerlink" title="8.8     内存回收"></a>8.8     内存回收</h3><ol>
<li><h4 id="因为C语言并不具备自动内存回收功能，所以-x3D-x3D-Redis-在自己的对象系统中构建了一个计数技术实现的内存回收机制-x3D-x3D-，通过这一机制，程序可以通过跟踪对象的引用技术信息，在适当的时候自动释放对象，并进行内存回收。"><a href="#因为C语言并不具备自动内存回收功能，所以-x3D-x3D-Redis-在自己的对象系统中构建了一个计数技术实现的内存回收机制-x3D-x3D-，通过这一机制，程序可以通过跟踪对象的引用技术信息，在适当的时候自动释放对象，并进行内存回收。" class="headerlink" title="因为C语言并不具备自动内存回收功能，所以&#x3D;&#x3D;Redis 在自己的对象系统中构建了一个计数技术实现的内存回收机制&#x3D;&#x3D;，通过这一机制，程序可以通过跟踪对象的引用技术信息，在适当的时候自动释放对象，并进行内存回收。"></a>因为C语言并不具备自动内存回收功能，所以&#x3D;&#x3D;Redis 在自己的对象系统中构建了一个计数技术实现的内存回收机制&#x3D;&#x3D;，通过这一机制，程序可以通过跟踪对象的引用技术信息，在适当的时候自动释放对象，并进行内存回收。</h4></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisObjct</span>&#123;</span><br>    <span class="hljs-type">int</span> refcount ;<br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725203650345.png" alt="image-20220725203650345"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725203658927.png" alt="image-20220725203658927"></p>
<h3 id="8-9-对象共享"><a href="#8-9-对象共享" class="headerlink" title="8.9    对象共享"></a>8.9    对象共享</h3><ol>
<li><h4 id="除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用。"><a href="#除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用。" class="headerlink" title="除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用。"></a>除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725204242430.png" alt="image-20220725204242430"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725204252310.png" alt="image-20220725204252310"></p>
<ol>
<li><h5 id="例如，假设数据库中中保存了整数值100的键不只是键A和键B两个，而是100个，那么服务器只需要用一个字符串对象的内存就可以保存原本需要使用一百个字符串对象的内存才能保存数据"><a href="#例如，假设数据库中中保存了整数值100的键不只是键A和键B两个，而是100个，那么服务器只需要用一个字符串对象的内存就可以保存原本需要使用一百个字符串对象的内存才能保存数据" class="headerlink" title="例如，假设数据库中中保存了整数值100的键不只是键A和键B两个，而是100个，那么服务器只需要用一个字符串对象的内存就可以保存原本需要使用一百个字符串对象的内存才能保存数据"></a>例如，假设数据库中中保存了整数值100的键不只是键A和键B两个，而是100个，那么服务器只需要用一个字符串对象的内存就可以保存原本需要使用一百个字符串对象的内存才能保存数据</h5></li>
<li><h5 id="目前来说-Redis会在初始化服务器时-创建一万个字符串对象-这些对象包含了默认从0-9999-的所有整数值-当服务器需要用到值为-0-9999-的字符串对象时-服务器就会使用这些共享对象-而不是新创建对象"><a href="#目前来说-Redis会在初始化服务器时-创建一万个字符串对象-这些对象包含了默认从0-9999-的所有整数值-当服务器需要用到值为-0-9999-的字符串对象时-服务器就会使用这些共享对象-而不是新创建对象" class="headerlink" title="目前来说,Redis会在初始化服务器时,创建一万个字符串对象,这些对象包含了默认从0-9999 的所有整数值,当服务器需要用到值为 0 -9999 的字符串对象时,服务器就会使用这些共享对象, 而不是新创建对象."></a>目前来说,Redis会在初始化服务器时,创建一万个字符串对象,这些对象包含了默认从0-9999 的所有整数值,当服务器需要用到值为 0 -9999 的字符串对象时,服务器就会使用这些共享对象, 而不是新创建对象.</h5></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs redis">set a  100  <br><br>object refcount a  <br><br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725205810285.png" alt="image-20220725205810285"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725210605389.png" alt="image-20220725210605389"></p>
<h3 id="8-10-对象的空转时长"><a href="#8-10-对象的空转时长" class="headerlink" title="8.10     对象的空转时长"></a>8.10     对象的空转时长</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs redis">object idletime msg  <br><br>object idletime msg  <br><br>get msg  <br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725210936547.png" alt="image-20220725210936547"></p>
<h3 id="8-11-重点回顾"><a href="#8-11-重点回顾" class="headerlink" title="8.11  重点回顾"></a>8.11  重点回顾</h3><ul>
<li><h4 id="Redis数据库中的每个键值对的键和值都是一个对象"><a href="#Redis数据库中的每个键值对的键和值都是一个对象" class="headerlink" title="Redis数据库中的每个键值对的键和值都是一个对象"></a>Redis数据库中的每个键值对的键和值都是一个对象</h4></li>
<li><h4 id="Redis共有字符串-列表-哈希-集合-有序集合五种类型对象-每种类型的对象至少都有两种或以上的编码方式-不同的编码方式可以在不同的使用场景上优化对象的使用效率"><a href="#Redis共有字符串-列表-哈希-集合-有序集合五种类型对象-每种类型的对象至少都有两种或以上的编码方式-不同的编码方式可以在不同的使用场景上优化对象的使用效率" class="headerlink" title="Redis共有字符串,列表,哈希,集合,有序集合五种类型对象,每种类型的对象至少都有两种或以上的编码方式,不同的编码方式可以在不同的使用场景上优化对象的使用效率"></a>Redis共有字符串,列表,哈希,集合,有序集合五种类型对象,每种类型的对象至少都有两种或以上的编码方式,不同的编码方式可以在不同的使用场景上优化对象的使用效率</h4></li>
<li><h4 id="服务器在执行某些命令之前-会先检查给定键的类型能否执行指定的命令-而检查一个键的类型就是检查键的值对象类型"><a href="#服务器在执行某些命令之前-会先检查给定键的类型能否执行指定的命令-而检查一个键的类型就是检查键的值对象类型" class="headerlink" title="服务器在执行某些命令之前,会先检查给定键的类型能否执行指定的命令,而检查一个键的类型就是检查键的值对象类型."></a>服务器在执行某些命令之前,会先检查给定键的类型能否执行指定的命令,而检查一个键的类型就是检查键的值对象类型.</h4></li>
<li><h4 id="Redis的的对象带有引用计数实现的内存回收机制-当一个对象不再被使用时-该对象所占用的内存就会被自动释放"><a href="#Redis的的对象带有引用计数实现的内存回收机制-当一个对象不再被使用时-该对象所占用的内存就会被自动释放" class="headerlink" title="Redis的的对象带有引用计数实现的内存回收机制,当一个对象不再被使用时,该对象所占用的内存就会被自动释放."></a>Redis的的对象带有引用计数实现的内存回收机制,当一个对象不再被使用时,该对象所占用的内存就会被自动释放.</h4></li>
<li><h4 id="Redis-会共享值-为-0-9999-的字符串对象"><a href="#Redis-会共享值-为-0-9999-的字符串对象" class="headerlink" title="Redis 会共享值 为 0-9999 的字符串对象"></a>Redis 会共享值 为 0-9999 的字符串对象</h4></li>
<li><h4 id="对象会记录自己的最后一次被访问的时间-这个时间可以用于计算对象的空转时间"><a href="#对象会记录自己的最后一次被访问的时间-这个时间可以用于计算对象的空转时间" class="headerlink" title="对象会记录自己的最后一次被访问的时间,这个时间可以用于计算对象的空转时间."></a>对象会记录自己的最后一次被访问的时间,这个时间可以用于计算对象的空转时间.</h4></li>
</ul>
<h2 id="第二部分-单机数据库的实现"><a href="#第二部分-单机数据库的实现" class="headerlink" title="第二部分   单机数据库的实现"></a>第二部分   单机数据库的实现</h2><h2 id="Chapter-9-数据库"><a href="#Chapter-9-数据库" class="headerlink" title="Chapter  9    数据库"></a>Chapter  9    数据库</h2><h3 id="9-1-服务器中的数据库"><a href="#9-1-服务器中的数据库" class="headerlink" title="9.1 服务器中的数据库"></a>9.1 服务器中的数据库</h3><ol>
<li><h4 id="Redis-服务器将所有数据库都保存再服务器状态-redis-h-x2F-redisServer-结构的db数组中-db数组的每个项都是一个redis-h-x2F-redisDb结构"><a href="#Redis-服务器将所有数据库都保存再服务器状态-redis-h-x2F-redisServer-结构的db数组中-db数组的每个项都是一个redis-h-x2F-redisDb结构" class="headerlink" title="Redis 服务器将所有数据库都保存再服务器状态 redis.h&#x2F;redisServer 结构的db数组中,db数组的每个项都是一个redis.h&#x2F;redisDb结构"></a>Redis 服务器将所有数据库都保存再服务器状态 redis.h&#x2F;redisServer 结构的db数组中,db数组的每个项都是一个redis.h&#x2F;redisDb结构</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725212856145.png" alt="image-20220725212856145"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725212904303.png" alt="image-20220725212904303"></p>
<h3 id="9-2-切换数据库"><a href="#9-2-切换数据库" class="headerlink" title="9.2   切换数据库"></a>9.2   切换数据库</h3><ol>
<li><h4 id="每个Redis客户端-都有自己的目标数据库-每当客户端执行数据库写命令或者数据库读命令的时候-目标数据库就会成为这些命令的操作对象"><a href="#每个Redis客户端-都有自己的目标数据库-每当客户端执行数据库写命令或者数据库读命令的时候-目标数据库就会成为这些命令的操作对象" class="headerlink" title="每个Redis客户端 都有自己的目标数据库,每当客户端执行数据库写命令或者数据库读命令的时候,目标数据库就会成为这些命令的操作对象"></a>每个Redis客户端 都有自己的目标数据库,每当客户端执行数据库写命令或者数据库读命令的时候,目标数据库就会成为这些命令的操作对象</h4></li>
<li><h4 id="默认情况下-Redis客户端的目标数据库为0号数据库-但客户端可以通过select-命令来切换目标数据库"><a href="#默认情况下-Redis客户端的目标数据库为0号数据库-但客户端可以通过select-命令来切换目标数据库" class="headerlink" title="默认情况下,Redis客户端的目标数据库为0号数据库,但客户端可以通过select  命令来切换目标数据库."></a>默认情况下,Redis客户端的目标数据库为0号数据库,但客户端可以通过select  命令来切换目标数据库.</h4></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs redis">set msg  &quot;hello world &quot;<br><br>get msg <br><br>select 2 <br><br>set msg &quot;another hello world &quot;<br>get msg <br><br><br><br></code></pre></td></tr></table></figure>





<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725214926588.png" alt="image-20220725214926588"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725214938286.png" alt="image-20220725214938286"></p>
<ol>
<li><h4 id="谨慎处理多数据库程序"><a href="#谨慎处理多数据库程序" class="headerlink" title="谨慎处理多数据库程序"></a>谨慎处理多数据库程序</h4></li>
<li><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725215016320.png" alt="image-20220725215016320"></p>
</li>
</ol>
<h3 id="9-3-数据库键空间"><a href="#9-3-数据库键空间" class="headerlink" title="9.3  数据库键空间"></a>9.3  数据库键空间</h3><ol>
<li><h4 id="Redis-是一个键值对数据库服务器-服务器中的每个数据库都由一哥redis-h-x2F-redisDb-结构表示"><a href="#Redis-是一个键值对数据库服务器-服务器中的每个数据库都由一哥redis-h-x2F-redisDb-结构表示" class="headerlink" title="Redis 是一个键值对数据库服务器,服务器中的每个数据库都由一哥redis.h&#x2F;redisDb 结构表示,"></a>Redis 是一个键值对数据库服务器,服务器中的每个数据库都由一哥redis.h&#x2F;redisDb 结构表示,</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725222512461.png" alt="image-20220725222512461"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725222518420.png" alt="image-20220725222518420"></p>
<h4 id="9-3-1-添加新键"><a href="#9-3-1-添加新键" class="headerlink" title="9.3.1   添加新键"></a>9.3.1   添加新键</h4><ol>
<li><h4 id="添加一个新键值对到数据库，实际上就是将一个新键值对添加到键空间字典里面，其中键为字符串对象，而值则为人以一种类型的Redis对象。"><a href="#添加一个新键值对到数据库，实际上就是将一个新键值对添加到键空间字典里面，其中键为字符串对象，而值则为人以一种类型的Redis对象。" class="headerlink" title="添加一个新键值对到数据库，实际上就是将一个新键值对添加到键空间字典里面，其中键为字符串对象，而值则为人以一种类型的Redis对象。"></a>添加一个新键值对到数据库，实际上就是将一个新键值对添加到键空间字典里面，其中键为字符串对象，而值则为人以一种类型的Redis对象。</h4></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs redis">set date &quot;2013.12.1&quot;<br><br><br></code></pre></td></tr></table></figure>



<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725222804121.png" alt="image-20220725222804121"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725222815211.png" alt="image-20220725222815211"></p>
<h4 id="9-3-2-删除键"><a href="#9-3-2-删除键" class="headerlink" title="9.3.2  删除键"></a>9.3.2  删除键</h4><ol>
<li><h4 id="删除数据库中的一个键，实际上就是在键空间里面删除键对应的键值对对象、"><a href="#删除数据库中的一个键，实际上就是在键空间里面删除键对应的键值对对象、" class="headerlink" title="删除数据库中的一个键，实际上就是在键空间里面删除键对应的键值对对象、"></a>删除数据库中的一个键，实际上就是在键空间里面删除键对应的键值对对象、</h4></li>
<li><p>~~~redis<br>del book</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>3. ![image-20220725223213471](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725223213471.png)<br><br><br><br>#### 9.3.3   更新键<br><br><br><br>1. #### 对一个数据库进行更新，实际上就是对键空间里面键所对应的值对象进行更新，根据值对象的类型不同，更新的具体方法也会有所不同、。<br><br>~~~redis<br>set message &quot;blah blah&quot; <br><br></code></pre></td></tr></table></figure></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725224406521.png" alt="image-20220725224406521"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs redis">hset book page 320  <br><br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725224427574.png" alt="image-20220725224427574"></p>
<h4 id="9-3-4-对键取值"><a href="#9-3-4-对键取值" class="headerlink" title="9.3.4     对键取值"></a>9.3.4     对键取值</h4><ol>
<li><h4 id="对一个数据库进行取值，实际上就是在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。"><a href="#对一个数据库进行取值，实际上就是在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。" class="headerlink" title="对一个数据库进行取值，实际上就是在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。"></a>对一个数据库进行取值，实际上就是在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。</h4></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs redis">get message <br>&quot;hello world&quot;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725225033817.png" alt="image-20220725225033817"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs redis">lrange alphabet 0 -1 <br><br></code></pre></td></tr></table></figure>



<ol>
<li><h4 id="LRANGE-命令将首先在键空间中查找alphabet，找到键之后接着取得该键所对应的列表对象值，之后再返回列表对象中包含的三个字符串对象的值。"><a href="#LRANGE-命令将首先在键空间中查找alphabet，找到键之后接着取得该键所对应的列表对象值，之后再返回列表对象中包含的三个字符串对象的值。" class="headerlink" title="LRANGE 命令将首先在键空间中查找alphabet，找到键之后接着取得该键所对应的列表对象值，之后再返回列表对象中包含的三个字符串对象的值。"></a>LRANGE 命令将首先在键空间中查找alphabet，找到键之后接着取得该键所对应的列表对象值，之后再返回列表对象中包含的三个字符串对象的值。</h4></li>
<li><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725225212202.png" alt="image-20220725225212202"></p>
</li>
</ol>
<h4 id="9-3-5-其他键空间操作"><a href="#9-3-5-其他键空间操作" class="headerlink" title="9.3.5    其他键空间操作"></a>9.3.5    其他键空间操作</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725225430675.png" alt="image-20220725225430675"></p>
<h4 id="9-3-6-读写键空间时的维护操作"><a href="#9-3-6-读写键空间时的维护操作" class="headerlink" title="9.3.6    读写键空间时的维护操作"></a>9.3.6    读写键空间时的维护操作</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725225716555.png" alt="image-20220725225716555"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725225729292.png" alt="image-20220725225729292"></p>
<h3 id="9-4-设置键的生存时间或过期时间"><a href="#9-4-设置键的生存时间或过期时间" class="headerlink" title="9.4   设置键的生存时间或过期时间"></a>9.4   设置键的生存时间或过期时间</h3><ol>
<li><h4 id="通过expire命令或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间，在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。"><a href="#通过expire命令或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间，在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。" class="headerlink" title="通过expire命令或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间，在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。"></a>通过expire命令或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间，在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。</h4></li>
<li><p>~~~redis<br>set key value<br>expire key 5<br>get key</p>
<p>get key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>3. <br><br><br><br>![image-20220725233729046](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725233729046.png)<br><br>![image-20220725233741925](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220725233741925.png)<br><br><br><br><br><br><br><br><br><br>#### 9.4.1       设置过期时间<br><br><br><br>![image-20220726124550354](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124550354.png)<br><br>![image-20220726124605118](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124605118.png)<br><br>![image-20220726124612815](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124612815.png)<br><br><br><br><br><br>#### 9.4.2     保存过期时间<br><br><br><br>![image-20220726124730262](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124730262.png)<br><br>![image-20220726124741015](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124741015.png)<br><br><br><br><br><br><br><br>![image-20220726124758352](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726124758352.png)<br><br><br><br><br><br><br><br><br><br>#### 9.4.3       移除过期时间    <br><br><br><br>~~~redis<br>pexpireat message 13912344000000<br><br>TTL message <br><br>persist message  <br><br>ttl message  <br><br></code></pre></td></tr></table></figure></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726130524834.png" alt="image-20220726130524834"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726130535724.png" alt="image-20220726130535724"></p>
<h4 id="9-4-4-计算并返回剩余生存时间"><a href="#9-4-4-计算并返回剩余生存时间" class="headerlink" title="9.4.4      计算并返回剩余生存时间"></a>9.4.4      计算并返回剩余生存时间</h4><ol>
<li><h4 id="TTL命令以秒为单位返回键的剩余生存时间，而PTTL命令则以毫秒为单位返回键的剩余生存时间。"><a href="#TTL命令以秒为单位返回键的剩余生存时间，而PTTL命令则以毫秒为单位返回键的剩余生存时间。" class="headerlink" title="TTL命令以秒为单位返回键的剩余生存时间，而PTTL命令则以毫秒为单位返回键的剩余生存时间。"></a>TTL命令以秒为单位返回键的剩余生存时间，而PTTL命令则以毫秒为单位返回键的剩余生存时间。</h4></li>
<li><p>~~~redis<br>pexpireat w alphabet  13821309812038129031</p>
<p>TTL alphabet  </p>
<p>PTTL  alphabet </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br>3. ![image-20220726131204136](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726131204136.png)<br><br><br><br>![image-20220726131210347](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726131210347.png)<br><br><br><br><br><br>#### 9.4.5     过期键的判定<br><br><br><br>1. #### 通过过期字典，程序可以用以下步骤检查一个给定键是否过期：<br><br>   1. #### 检查给定键是否在于过期字典：如果存在，那么取得键的过期时间<br><br>   2. #### 检查当前UNIX时间戳是否大于键的过期时间：如果是的话，那么键已经过期，反之，键没有过期。<br><br><br><br>![image-20220726132505729](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726132505729.png)<br><br><br><br>![image-20220726132513445](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726132513445.png)<br><br>![image-20220726132518661](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726132518661.png)<br><br><br><br><br><br><br><br><br><br>### 9.5  过期键删除策略<br><br><br><br>1. #### 如果一个键过期了，那么它什么时候会被删除呢？<br><br>- #### 那个答案，代表了三种不同的策略：<br><br>  - #### 定时删除：在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作<br><br>  - #### 惰性删除：放任键过期不管，但是每次从键空间中获得键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，空就返回改键 <br><br>  - #### 定期删除： 每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键，至于要删除多少过期键，以及要检查多少个数据库，则有算法决定。<br><br>- #### 这三种策略中，第一种和第三种为主动删除策略，而第二种为被动删除策略。<br><br><br><br><br><br><br><br><br><br>#### 9.5.1    定时删除<br><br><br><br>1. #### 对内存是最友好的：通过使用定时器，定时删除策略可以保证过期键会尽可能地被删除，并释放过期键所占用地内存<br><br>2. #### 另一方面，定时删除策略地缺点是：他对CPU时间是最不友好的：在过期间键比较多的情况下，删除过期键这一行为可能会占用相当一部分CPU时间，在内存不紧张下但是CPU时间非常紧张的情况下，将CPU时间用在删除和当天任务无关的过期键上，无疑会对服务器的响应时间和吞吐量造成影响。<br><br>3. #### ![image-20220726161444517](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726161444517.png)。<br><br><br><br><br><br><br><br><br><br>#### 9.5.2   惰性删除 <br><br><br><br>1. #### 惰性删除策略对CPU时间来说是最友好的，程序只会在取出键时才对键进行过期检查，这可以保证删除过期键的操作只会在非做不可的情况下进行，并且删除的目标仅限于当前处理的键，这个策略不会在删除其他无关的过期键上花费任何CPU时间。<br><br>2. #### 惰性删除的缺点是：他对内存是最不友好的：如果一个键已经过期，而这个键又仍然保留在数据库中，那么只要这个过期键不被删除，它所占用的内存就不会被释放<br><br>3. #### 在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么他们也许永远也不会被删除（除非用户手动FLUSHDB），我们甚至可以将这种情况看成是一种内存泄漏----无用的垃圾数据占用了大量的内存，而服务器缺不会自己去释放他们，这对于运行状态非常依赖于内存的Redis服务器来说，肯定不是一个好消息。<br><br><br><br>![image-20220726162241408](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726162241408.png)<br><br><br><br><br><br>#### 9.5.3    定期删除  <br><br><br><br><br><br>![image-20220726162414560](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726162414560.png)<br><br><br><br>1. #### 如果采用定期删除策略的话，服务器必须根据情况，合理地设置删除操作的执行时长和执行频率。<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>### 9.6     Redis  的过期键删除策略<br><br><br><br>1. #### 对服务器中，惰性删除和定期删除的具体实现进行说明。<br><br><br><br><br><br><br><br>#### 9.6.1    惰性删除策略的实现<br><br><br><br><br><br>![image-20220726163509629](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163509629.png)<br><br><br><br><br><br>![image-20220726163520112](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163520112.png)<br><br><br><br><br><br><br><br><br><br><br><br>#### 9.6.2       定期删除策略的实现<br><br><br><br>![image-20220726163610498](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163610498.png)<br><br>![image-20220726163631865](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163631865.png)<br><br>![image-20220726163641353](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163641353.png)<br><br>![image-20220726163649908](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163649908.png)<br><br><br><br>![image-20220726163655310](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726163655310.png)<br><br><br><br><br><br><br><br><br><br>### 9.7  AOF ，  RDB 和 复制功能对过期键的处理<br><br><br><br>1. #### 探讨过期键对Redis 服务器其他模块的影响，看看RDB持久化功能，AOF持久化功能以及复制功能是如何处理数据库中的过期键的。<br><br><br><br><br><br><br><br>#### 9.7.1    生成 RDB文件<br><br><br><br>1. #### 在执行SAVE命令或者BGSAVE命令 创建一个新的RDB文件时，程序会对数据库中的键进行检查，已过期的键不会被保存到新创建的RDB文件中。<br><br>2. #### 例如： 如果数据库中 包含三个键 k1, k2 , k3, 并且k2已经到期，那么当执行SAVE命令或者BGSAVE命令时，程序只会将k1和k3的数据保存到RDB文件中，而K2则会被忽略<br><br>3. #### 因此，数据库中包含过期键不会对生成的RDB文件造成影响。、<br><br><br><br><br><br><br><br><br><br>#### 9.7.2     载入RDB文件<br><br><br><br>1. #### 在启动Redis服务器时，如果服务器开启了RDB功能，那么服务器将对RDB文件进行载入：<br><br>   1. #### 如果服务器以主服务器模式运行，那么在载入RDB文件时，程序会对文件保存的键进行检查，未过期的键会被载入到数据库中，而过期的键则会被忽略，所以过期键对载入RDB文件的主服务器不会造成影响<br><br>   2. #### 如果服务器以服务器模式运行，那么在载入RDB文件时，文件中所保存的所有键，不论是否过期，都会被载入到数据库中，不过，因为主从服务器在进行数据库同步的时候，从服务器的数据库就会被清空，所以一般来讲，==过期键对载入RDB文件的从服务器也不会造成影响==。<br><br>2. #### 举个例子 ， 如果数据库中包含三个键 k1, k2 ,k3,  并且k2已经过期，那么当服务器启动时：<br><br>   1. #### 如果服务器以主服务器模式运行，那么程序指挥将k1，和  k3，载入到数据库，k2会被忽略，<br><br>   2. #### 如果服务器以服务器模式运行，那么k1,k2,和 k3都会被载入到数据库中。<br><br><br><br><br><br><br><br><br><br>#### 9.7.3    AOF文件写入 <br><br><br><br>1. #### 当服务器以AOF持久化模式运行时，==如果数据库中的某个键已经过期，但它还没有惰性删除或者定期删除，那么AOF文件不会因为这个过期键而产生任何影响。==<br><br>2. #### 当过期键被惰性删除或者定期删除之后，程序会向AOF文件追加（append）一条DEL命令，来显示地记录该键已被删除<br><br>3. #### 举个例子，如果客户端使用GET message 命令，试图访问过期的message键，那么服务器将执行以下三个动作：<br><br>   1. #### 从数据库中删除message键<br><br>   2. #### 追加一条DEL messge 命令到AOF 文件<br><br>   3. #### 向执行get 命令地客户端返回空恢复。<br><br><br><br><br><br><br><br><br><br>#### 9.7.4    AOF 文件重写<br><br><br><br>1. #### 和生成的RDB文件时类似，==在执行AOF重写的过程中，程序会对数据库中的键进行检查，已过期的键不会被保存到重写后的AOF文件中。==<br><br>2. #### 举个例子：如果数据库中包含 三个键  k1, k2 , k3 并且 k2 已经过期，那么在进行重写工作时，程序只会对k1,和k3 进行重写，而k2则会忽略。<br><br>3. #### ==因此，数据库中包含过期键，不会对AOF重写造成影响.==<br><br><br><br><br><br><br><br><br><br><br><br><br><br>#### 9.7.5    复制  <br><br><br><br>1. #### 当服务器运行在复制模式下时,==从服务器的过程键删除动作由主服务器控制==<br><br>   1. #### 当服务器在删除一个过期键之后,会显示地向所有从服务器发送一个DEL命令,告诉从服务器删除这个过期键<br><br>   2. #### 从服务器在执行客户端发来的命令时,即使碰到过期键越不会将过期键删除,而是继续将处理未过期的键一样来处理过期键<br><br>   3. #### 从服务器只有在街道主服务器发来的DEL命令之后,才会删除过期键.<br><br><br><br><br><br>- #### ==通过由主服务器来控制从服务器统一地删除过期键,可以保证主从服务器数据地一致性==,也正是因为这个原因,当一个过期键仍然存在于主服务器地数据库时,这个过期键在从服务器里的复制品也会继续存在,<br><br>- <br><br>![image-20220726205820145](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726205820145.png)<br><br><br><br>- ### 例子<br><br><br><br>![image-20220726205847275](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726205847275.png)<br><br>![image-20220726205857513](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726205857513.png)<br><br>![image-20220726210008251](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726210008251.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 9.8   数据库通知<br><br><br><br>1. #### 数据库通知是Redis新增加的功能,这个功能可以让客户端通过订阅给定的频道或者模式,来获知数据库中键的变化,以及数据库中命令的执行情况。<br><br><br><br>![image-20220726213300069](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726213300069.png)<br><br>![image-20220726213307594](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726213307594.png)<br><br><br><br><br><br>1. #### 根据发回的通知显示，先后共有SET，EXPIRE（Redis Expire 命令用于设置 key 的过期时间，key 过期后将不再可用。单位以秒计） ,DEL   三个命令对键message 进行了操作。<br><br><br><br>![image-20220726213614709](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726213614709.png)<br><br>![image-20220726213638528](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726213638528.png)<br><br><br><br><br><br><br><br><br><br><br><br><br><br>#### 9.8.1    发送通知<br><br><br><br><br><br>![image-20220726214258878](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726214258878.png)<br><br><br><br>![image-20220726214310075](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726214310075.png)<br><br><br><br><br><br>![image-20220726214545543](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726214545543.png)<br><br>![image-20220726214553639](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726214553639.png)<br><br><br><br><br><br><br><br><br><br><br><br>#### 9.8.2   发送通知实现<br><br><br><br>1. #### notifykeysapceEvent 函数的伪代码实现：<br><br><br><br>![image-20220726215443912](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726215443912.png)<br><br><br><br><br><br>![image-20220726215521045](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220726215521045.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 9.9  重点回顾 <br><br><br><br>1. #### Redis服务器的所有数据都保存在redisServer.db 数组中，而数据库的数量则由redisServer.dbnum 属性保存<br><br>2. #### 客户端通过修改目标数据库指针，让它指向redisServer.db 数组中不同元素来切换不同数据库<br><br>3. #### 数据库主要由dict和expires两个字典构成，其中dict字典负责保存键值对，而expires字典则负责保存键的过期时间<br><br>4. #### 因为数据库由字典构成，所以对数据库的操作都是建立在字典操作之上的<br><br>5. #### 数据库的键总是一个字符串对象，而值则可以是任意一种Redis对象类型，包括字符串对象，哈希表对象，集合对象，列表对象，和有序集合对象，分别对应字符串键，哈希表键，集合键，列标键，和有序集合键<br><br>6. #### expires 字典的键指向数据库中的某个键，而值则记录了数据库键的过期时间，过期时间是一个以毫秒为单位的unix时间戳<br><br>7. #### Redis使用惰性删除和定期删除两种策略来删除过期键：惰性删除策略只在碰到过期键时才进行删除操作，定期删除策略则每隔一段时间，主动查找并删除过期键<br><br>8. #### 执行SAVE命令或者BGSAVE命令所产生的新RDB文件不会包含已经过期的键<br><br>9. #### 当一个过期被删除后，服务器会追加一条DEL命令到现有的AOF文件末尾，显示地删除过期键<br><br>10. #### 当主服务器删除一个过期键之后，它会向所有从服务器发送一条DEL命令，显式地删除过期键<br><br>11. #### 从服务器即使发现过期键也不会自作主张地删除它，而是等待主节点发来DEL命令，这种统一，中性化的过期键删除策略可以保证主从服务器数据的一致性<br><br>12. #### 当Redis命令对数据库进行修改之后，服务器会根据配置向客户端发送数据库通知。<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>## Chapter 10      RDB 持久化<br><br><br><br>- #### 数据库状态：==服务器中的非空数据库以及他们的键值对状态统称为数据库状态。==<br><br><br><br>1. #### 为了解决服务器进程退出，服务器中数据库进程状态也会消失不见得的问题，Redis提供了RDB持久化功能.这个功能可以将Redis在内存中的数据库状态保存到磁盘里面，避免数据意外丢失<br><br>2. #### RDB持久化即可以手动执行，也可以根据服务器配置选项定期执行，该功能能将某个时间点上的数据库状态保存到一个RDB文件中<br><br>3. #### ![image-20220802132025394](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802132025394.png)。<br><br><br><br><br><br><br><br>1. #### 因为RDB文件是保存在硬盘里面的，所以即使redis服务器进程退出，甚至运行redis服务器的计算机停机，但只要RDB文件存在，Redis服务器就能用它来还原数据库服务器状态。<br><br><br><br><br><br><br><br><br><br>### 10.1   RDB文件的创建和载入<br><br><br><br>1. #### 有两个命令可用于RDB文件的生成，SAVE 和  BGSAVE。	<br><br>2. #### SAVE命令会==阻塞Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程阻塞期间，服务器不能处理任何命令。==<br><br>3. #### BGSAVE命令则是会派生出一个子进程，然后由子进程负责创建RDB文件，服务器进程（父进程）继续处理命令请求。<br><br><br><br>- #### 利用save和bgsave 命令创建RDB文件不同，RDB文件的载入工作是在服务器启动时自动执行的，所以Redis并没有专门用于载入RDB文件的命令，只要Redis服务器在启动时检测到RDB文件存在，他就会自动载入RDB文件。<br><br><br><br>1. #### 因为AOF文件的更新频率通常比RDB文件的更新频率更高，所以：<br><br>   1. #### 如果服务器开启了AOF持久化，那么服务器会优先使用AOF文件来还原数据库状态<br><br>   2. #### 只有在AOF持久化功能处于关闭状态，服务器才会使用RDB文件来还原数据库状态，服务器判断该用哪个文件来还原数据库状态的流程如下<br><br>   3. #### ![image-20220802133805932](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802133805932.png)。<br><br><br><br><br><br>![image-20220802133857633](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802133857633.png)<br><br><br><br><br><br><br><br>![image-20220802133908139](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802133908139.png)<br><br><br><br>![image-20220802133918809](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802133918809.png)<br><br><br><br><br><br>1. #### save命令时所有命令都不能被接收<br><br>2. #### BGSAVE命令时，SAVE，BGSAVE，BGREWRITEAOF也会被拒绝、<br><br><br><br><br><br><br><br>#### 10.1.3  RDB文件载入时的服务器状态<br><br><br><br>1. #### 服务器在载入RDB文件期间，会一直处于阻塞状态，知道载入工作完成。<br><br><br><br><br><br><br><br><br><br>### 10.2   自动间隔性保存<br><br><br><br>1. #### 因为BGSAVE命令可以在不阻塞服务器进程情况下进行，所以Redis允许用户通过设置服务器配置的save选项，让服务器每隔一段时间自动执行一次BGSAVE命令。<br><br>2. #### 用户可以通过SAVE选项设置多个保存条件，但只要其中任意一个条件被满足，服务器就会执行BGSAVE命令。<br><br><br><br><br><br>![image-20220802135536967](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802135536967.png)<br><br>![image-20220802135546347](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802135546347.png)<br><br><br><br>![image-20220802135849450](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802135849450.png)<br><br><br><br>![image-20220802135657716](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802135657716.png)<br><br><br><br><br><br><br><br><br><br>#### 10.2.2   dirty 计数器和lastsave属性<br><br><br><br>1. #### 除了saveparams 数组之外，服务器状态还维持着一个dirty计数器，以及一个lastsave属性：<br><br>   1. #### dirty计数器记录距离上一次成功执行save命令或者bgsave命令之后，服务器对数据库状态（服务器中的所有数据库）进行了多少次修改（包括==写入，删除，更新等操作==）<br><br>   2. #### lastsave 属性是一个unix时间戳，记录了服务器上一次成功执行save命令或者bgsave命令的时间。<br><br>   3. #### 。<br><br><br><br>![image-20220802140625273](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802140625273.png)<br><br>![image-20220802140629844](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802140629844.png)<br><br><br><br><br><br><br><br><br><br>#### 10.2.3     检查保存条件是否满足<br><br><br><br><br><br>1. #### Redis的服务器周期性操作函数serverCron默认每隔100ms就会执行一次，该函数用于对正在运行的服务器进行维护，他的其中一项工作就是检查save选项所设置的保存条件是否已经满足，如果满足就会执行BGSAVE命令。<br><br><br><br>![image-20220802140959037](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802140959037.png)<br><br><br><br>![image-20220802141011618](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802141011618.png)<br><br><br><br><br><br>![image-20220802141027675](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802141027675.png)<br><br><br><br>![image-20220802141036886](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802141036886.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 10.3   RDB文件结构<br><br><br><br><br><br>![image-20220802141844009](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802141844009.png)<br><br><br><br><br><br>1. #### RDB文件最开头是==REDIS==部分，这个部分的长度是5字节，保存着REDIS五个字符，通过这五个字符，程序可以在载入文件时，快速检查所载入的文件是否含有RDB文件。<br><br>####  <br><br>![image-20220802142116194](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142116194.png)<br><br><br><br>![](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142239909.png)<br><br>![image-20220802142253003](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142253003.png)<br><br>![image-20220802142303778](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142303778.png)<br><br><br><br><br><br><br><br>#### 10.3.1   database 部分<br><br><br><br>1. #### 一个RDB文件的database部分可以保存任意多个非空数据库。<br><br>2. #### 如：<br><br>![image-20220802142449870](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142449870.png)<br><br><br><br>![image-20220802142547556](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142547556.png)<br><br>![image-20220802142710468](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802142710468.png)<br><br><br><br><br><br><br><br>#### 10.3.2   key_value_pairs 部分 <br><br><br><br><br><br>![image-20220802143030398](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802143030398.png)<br><br>![image-20220802143038327](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802143038327.png)<br><br>![image-20220802143049304](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802143049304.png)<br><br><br><br><br><br><br><br>#### 10.3.3     value的编码<br><br><br><br>1. #### 字符串对象<br><br>![image-20220802144218764](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144218764.png)<br><br>![image-20220802144233052](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144233052.png)	<br><br>![image-20220802144244037](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144244037.png)<br><br>![image-20220802144251180](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144251180.png)<br><br><br><br><br><br><br><br><br><br>1. #### 列表对象<br><br><br><br><br><br>![image-20220802144505239](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144505239.png)<br><br><br><br><br><br>1. #### 集合对象<br><br>![image-20220802144529319](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144529319.png)<br><br>![image-20220802144640316](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802144640316.png)<br><br><br><br><br><br><br><br>1. #### 哈希表对象<br><br><br><br>![image-20220802145426848](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145426848.png)<br><br><br><br>![image-20220802145444015](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145444015.png)<br><br>1. #### 有序集合对象<br><br><br><br>![image-20220802145621514](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145621514.png)<br><br>![image-20220802145630308](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145630308.png)<br><br><br><br><br><br>1. #### intset编码的集合<br><br><br><br>![image-20220802145800735](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145800735.png)<br><br><br><br><br><br>1. #### ziplist  编码的列表，哈希集合或者有序集合<br><br><br><br>![image-20220802145933112](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145933112.png)<br><br>![image-20220802145941408](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802145941408.png)<br><br><br><br><br><br><br><br><br><br><br><br>### 10.4   分析RDB文件<br><br><br><br>![image-20220802154810873](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802154810873.png)<br><br><br><br>#### 10.4.1  不包含任何键值对的RDB文件<br><br><br><br><br><br>![image-20220802155054174](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802155054174.png)<br><br>![image-20220802155104151](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802155104151.png)<br><br><br><br><br><br><br><br>#### 10.4.2   包含字符串键的RDB文件<br><br><br><br><br><br>![image-20220802175508642](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802175508642.png)<br><br>![image-20220802175524226](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802175524226.png)<br><br><br><br><br><br><br><br>#### 10.4.3    包含带有过期时间的字符串键的RDB文件<br><br><br><br><br><br>![image-20220802180227942](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802180227942.png)<br><br><br><br>![image-20220802180511412](C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802180511412.png)<br><br><br><br><br><br><br><br><br><br>#### 10.4.4     包含一个集合键的RDB文件<br><br><br><br>~~~redis<br>flushall <br><br>sadd lang &quot;C&quot; &quot;redis&quot; &quot;java&quot;<br><br><br></code></pre></td></tr></table></figure></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802180937716.png" alt="image-20220802180937716"></p>
<h4 id="10-4-5-关于分析-RDB文件的说明"><a href="#10-4-5-关于分析-RDB文件的说明" class="headerlink" title="10.4.5   关于分析  RDB文件的说明"></a>10.4.5   关于分析  RDB文件的说明</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802181304633.png" alt="image-20220802181304633"></p>
<h3 id="10-5-重点回顾"><a href="#10-5-重点回顾" class="headerlink" title="10.5  重点回顾"></a>10.5  重点回顾</h3><ol>
<li><h4 id="RDB文件用于保存和还原redis服务器所有的数据库中的所有键值对数据"><a href="#RDB文件用于保存和还原redis服务器所有的数据库中的所有键值对数据" class="headerlink" title="RDB文件用于保存和还原redis服务器所有的数据库中的所有键值对数据"></a>RDB文件用于保存和还原redis服务器所有的数据库中的所有键值对数据</h4></li>
<li><h4 id="save命令由服务器进程直接执行保存操作，所以该命令会阻塞服务器"><a href="#save命令由服务器进程直接执行保存操作，所以该命令会阻塞服务器" class="headerlink" title="save命令由服务器进程直接执行保存操作，所以该命令会阻塞服务器"></a>save命令由服务器进程直接执行保存操作，所以该命令会阻塞服务器</h4></li>
<li><h4 id="BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器"><a href="#BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器" class="headerlink" title="BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器"></a>BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器</h4></li>
<li><h4 id="服务器状态中会保存所有save选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令"><a href="#服务器状态中会保存所有save选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令" class="headerlink" title="服务器状态中会保存所有save选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令"></a>服务器状态中会保存所有save选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令</h4></li>
<li><h4 id="RDB文件是一个经过压缩的二进制文件，由多个部分组成"><a href="#RDB文件是一个经过压缩的二进制文件，由多个部分组成" class="headerlink" title="RDB文件是一个经过压缩的二进制文件，由多个部分组成"></a>RDB文件是一个经过压缩的二进制文件，由多个部分组成</h4></li>
<li><h4 id="对于不同类型的键值对，RDB文件会使用不同的方式来保存他们。"><a href="#对于不同类型的键值对，RDB文件会使用不同的方式来保存他们。" class="headerlink" title="对于不同类型的键值对，RDB文件会使用不同的方式来保存他们。"></a>对于不同类型的键值对，RDB文件会使用不同的方式来保存他们。</h4></li>
</ol>
<h2 id="Chapter-11-AOF持久化"><a href="#Chapter-11-AOF持久化" class="headerlink" title="Chapter 11    AOF持久化"></a>Chapter 11    AOF持久化</h2><ol>
<li><h4 id="除了RDB持久化功能之外，Redis还提供了AOF（append-only-file）持久化功能，-x3D-x3D-与RDB持久化功能通过保存数据库中的键值对来记录数据库状态不同，AOF持久化通过保存redis服务器所执行的写命令来记录数据库状态-x3D-x3D-。"><a href="#除了RDB持久化功能之外，Redis还提供了AOF（append-only-file）持久化功能，-x3D-x3D-与RDB持久化功能通过保存数据库中的键值对来记录数据库状态不同，AOF持久化通过保存redis服务器所执行的写命令来记录数据库状态-x3D-x3D-。" class="headerlink" title="除了RDB持久化功能之外，Redis还提供了AOF（append only file）持久化功能，&#x3D;&#x3D;与RDB持久化功能通过保存数据库中的键值对来记录数据库状态不同，AOF持久化通过保存redis服务器所执行的写命令来记录数据库状态&#x3D;&#x3D;。"></a>除了RDB持久化功能之外，Redis还提供了AOF（append only file）持久化功能，&#x3D;&#x3D;与RDB持久化功能通过保存数据库中的键值对来记录数据库状态不同，AOF持久化通过保存redis服务器所执行的写命令来记录数据库状态&#x3D;&#x3D;。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802182334304.png" alt="image-20220802182334304"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs redis">set msg &quot;hello<br>sadd fruits &quot;apple&quot; &quot;bannana&quot; &quot;chrry&quot;<br>rpush numbers 128 256 512  <br><br></code></pre></td></tr></table></figure>



<ol>
<li><h4 id="AOF持久化保存数据库状态的方法是将服务器执行的-set-，sadd，rpush-三个命令保存到AOF文件中。"><a href="#AOF持久化保存数据库状态的方法是将服务器执行的-set-，sadd，rpush-三个命令保存到AOF文件中。" class="headerlink" title="AOF持久化保存数据库状态的方法是将服务器执行的 set ，sadd，rpush 三个命令保存到AOF文件中。"></a>AOF持久化保存数据库状态的方法是将服务器执行的 set ，sadd，rpush 三个命令保存到AOF文件中。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802182905328.png" alt="image-20220802182905328"></p>
<ol>
<li><h4 id="服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。以下是服务器载入AOF文件并还原数据库状态时打印的日志。"><a href="#服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。以下是服务器载入AOF文件并还原数据库状态时打印的日志。" class="headerlink" title="服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。以下是服务器载入AOF文件并还原数据库状态时打印的日志。"></a>服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。以下是服务器载入AOF文件并还原数据库状态时打印的日志。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802183129835.png" alt="image-20220802183129835"></p>
<h3 id="11-1-AOF-持久化的实现"><a href="#11-1-AOF-持久化的实现" class="headerlink" title="11.1    AOF 持久化的实现"></a>11.1    AOF 持久化的实现</h3><ol>
<li><h4 id="AOF持久化功能的实现-x3D-x3D-可以追加-append-，文件写入，文件同步，-x3D-x3D-三个步骤。"><a href="#AOF持久化功能的实现-x3D-x3D-可以追加-append-，文件写入，文件同步，-x3D-x3D-三个步骤。" class="headerlink" title="AOF持久化功能的实现&#x3D;&#x3D;可以追加 append  ，文件写入，文件同步，&#x3D;&#x3D;三个步骤。"></a>AOF持久化功能的实现&#x3D;&#x3D;可以追加 append  ，文件写入，文件同步，&#x3D;&#x3D;三个步骤。</h4></li>
</ol>
<h4 id="11-1-1-命令追加"><a href="#11-1-1-命令追加" class="headerlink" title="11.1.1  命令追加"></a>11.1.1  命令追加</h4><ol>
<li><h4 id="当AOF-持久化功能打开时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的-aof-buf-缓冲区的末尾。"><a href="#当AOF-持久化功能打开时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的-aof-buf-缓冲区的末尾。" class="headerlink" title="当AOF 持久化功能打开时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的 aof_buf 缓冲区的末尾。"></a>当AOF 持久化功能打开时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的 aof_buf 缓冲区的末尾。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802183739238.png" alt="image-20220802183739238"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802183745288.png" alt="image-20220802183745288"></p>
<h4 id="11-1-2-AOF文件的写入与同步"><a href="#11-1-2-AOF文件的写入与同步" class="headerlink" title="11.1.2   AOF文件的写入与同步"></a>11.1.2   AOF文件的写入与同步</h4><ul>
<li><h4 id="Redis的-服务器进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。而时间事件则负责执行像serverCron函数这样需要定时运行的函数。"><a href="#Redis的-服务器进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。而时间事件则负责执行像serverCron函数这样需要定时运行的函数。" class="headerlink" title="Redis的 服务器进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。而时间事件则负责执行像serverCron函数这样需要定时运行的函数。"></a>Redis的 服务器进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。而时间事件则负责执行像serverCron函数这样需要定时运行的函数。</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184237561.png" alt="image-20220802184237561"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184300711.png" alt="image-20220802184300711"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184318368.png" alt="image-20220802184318368"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184328303.png" alt="image-20220802184328303"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184335161.png" alt="image-20220802184335161"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802184343972.png" alt="image-20220802184343972"></p>
<h3 id="11-2-AOF文件的载入与数据还原"><a href="#11-2-AOF文件的载入与数据还原" class="headerlink" title="11.2    AOF文件的载入与数据还原"></a>11.2    AOF文件的载入与数据还原</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802185905930.png" alt="image-20220802185905930"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220802185913803.png" alt="image-20220802185913803"></p>
<h3 id="11-3-AOF重写"><a href="#11-3-AOF重写" class="headerlink" title="11.3  AOF重写"></a>11.3  AOF重写</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803104218536.png" alt="image-20220803104218536"></p>
<ol>
<li><h4 id="为了解决AOF文件体积膨胀的问题，Redis-提供了AOF文件重写-rewrite-功能，通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，-x3D-x3D-但新文件AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积小得多。-x3D-x3D"><a href="#为了解决AOF文件体积膨胀的问题，Redis-提供了AOF文件重写-rewrite-功能，通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，-x3D-x3D-但新文件AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积小得多。-x3D-x3D" class="headerlink" title="为了解决AOF文件体积膨胀的问题，Redis 提供了AOF文件重写(rewrite)功能，通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，&#x3D;&#x3D;但新文件AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积小得多。&#x3D;&#x3D;"></a>为了解决AOF文件体积膨胀的问题，Redis 提供了AOF文件重写(rewrite)功能，通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，&#x3D;&#x3D;但新文件AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积小得多。&#x3D;&#x3D;</h4></li>
</ol>
<h4 id="11-3-1-AOF文件重写的实现"><a href="#11-3-1-AOF文件重写的实现" class="headerlink" title="11.3.1  AOF文件重写的实现"></a>11.3.1  AOF文件重写的实现</h4><ol>
<li><h4 id="Redis将生成新的AOF文件替换旧的AOF文件的功能命名为”AOF文件重写”，但实际上，-x3D-x3D-AOF文件重写并不需要对现有的AOF文件进行任何读取，分析，或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。"><a href="#Redis将生成新的AOF文件替换旧的AOF文件的功能命名为”AOF文件重写”，但实际上，-x3D-x3D-AOF文件重写并不需要对现有的AOF文件进行任何读取，分析，或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。" class="headerlink" title="Redis将生成新的AOF文件替换旧的AOF文件的功能命名为”AOF文件重写”，但实际上，&#x3D;&#x3D;AOF文件重写并不需要对现有的AOF文件进行任何读取，分析，或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。"></a>Redis将生成新的AOF文件替换旧的AOF文件的功能命名为”AOF文件重写”，但实际上，&#x3D;&#x3D;AOF文件重写并不需要对现有的AOF文件进行任何读取，分析，或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。</h4></li>
<li><h4 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105025581.png" alt="image-20220803105025581"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105035069.png" alt="image-20220803105035069"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105104651.png" alt="image-20220803105104651"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105304731.png" alt="image-20220803105304731"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105321785.png" alt="image-20220803105321785"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803105458652.png" alt="image-20220803105458652"></p>
<h4 id="11-3-2-AOF-后台重写"><a href="#11-3-2-AOF-后台重写" class="headerlink" title="11.3.2  AOF  后台重写"></a>11.3.2  AOF  后台重写</h4><ol>
<li><h4 id="Redis-服务器使用单个线程来处理命令，如果由服务器直接调用aof-rewrite-函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求："><a href="#Redis-服务器使用单个线程来处理命令，如果由服务器直接调用aof-rewrite-函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求：" class="headerlink" title="Redis 服务器使用单个线程来处理命令，如果由服务器直接调用aof_rewrite 函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求："></a>Redis 服务器使用单个线程来处理命令，如果由服务器直接调用aof_rewrite 函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求：</h4><ol>
<li><h4 id="Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放入到子程序中进行，以达成目的："><a href="#Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放入到子程序中进行，以达成目的：" class="headerlink" title="Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放入到子程序中进行，以达成目的："></a>Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放入到子程序中进行，以达成目的：</h4><ol>
<li><h4 id="子进程进行AOF重写期间，服务器进程-父进程-可以继续处理命令"><a href="#子进程进行AOF重写期间，服务器进程-父进程-可以继续处理命令" class="headerlink" title="子进程进行AOF重写期间，服务器进程(父进程)可以继续处理命令"></a>子进程进行AOF重写期间，服务器进程(父进程)可以继续处理命令</h4></li>
<li><h4 id="子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。"><a href="#子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。" class="headerlink" title="子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。"></a>子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。</h4></li>
</ol>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803110603588.png" alt="image-20220803110603588"></p>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803110622119.png" alt="image-20220803110622119"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803110635060.png" alt="image-20220803110635060"></p>
<ul>
<li><h4 id="为了解决数据不一致问题，Redis-服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用"><a href="#为了解决数据不一致问题，Redis-服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用" class="headerlink" title="为了解决数据不一致问题，Redis 服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用"></a>为了解决数据不一致问题，Redis 服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用</h4></li>
<li><h4 id="当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区"><a href="#当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区" class="headerlink" title="当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区"></a>当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区</h4></li>
<li><h4 id="在子进程执行AOF重写期间，服务器进程需要执行以下三个工作："><a href="#在子进程执行AOF重写期间，服务器进程需要执行以下三个工作：" class="headerlink" title="在子进程执行AOF重写期间，服务器进程需要执行以下三个工作："></a>在子进程执行AOF重写期间，服务器进程需要执行以下三个工作：</h4><ul>
<li><h4 id="执行客户端发来的命令"><a href="#执行客户端发来的命令" class="headerlink" title="执行客户端发来的命令"></a>执行客户端发来的命令</h4></li>
<li><h4 id="将执行后的写命令追加到AOF缓冲区"><a href="#将执行后的写命令追加到AOF缓冲区" class="headerlink" title="将执行后的写命令追加到AOF缓冲区"></a>将执行后的写命令追加到AOF缓冲区</h4></li>
<li><h4 id="将执行后的写命令追加到AOF重写缓冲区。"><a href="#将执行后的写命令追加到AOF重写缓冲区。" class="headerlink" title="将执行后的写命令追加到AOF重写缓冲区。"></a>将执行后的写命令追加到AOF重写缓冲区。</h4></li>
</ul>
</li>
</ul>
<ol>
<li><h4 id="这样一来可以保证："><a href="#这样一来可以保证：" class="headerlink" title="这样一来可以保证："></a>这样一来可以保证：</h4><ol>
<li><h4 id="AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行"><a href="#AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行" class="headerlink" title="AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行"></a>AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行</h4></li>
<li><h4 id="从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面"><a href="#从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面" class="headerlink" title="从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面"></a>从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面</h4></li>
<li><h4 id="当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作："><a href="#当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作：" class="headerlink" title="当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作："></a>当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作：</h4><ol>
<li><h4 id="将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致"><a href="#将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致" class="headerlink" title="将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致"></a>将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致</h4></li>
<li><h4 id="对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换"><a href="#对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换" class="headerlink" title="对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换"></a>对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换</h4></li>
</ol>
</li>
</ol>
</li>
<li><h4 id="这个信号处理函数执行完毕之后，父进程就可以像往常一样接受命令请求了"><a href="#这个信号处理函数执行完毕之后，父进程就可以像往常一样接受命令请求了" class="headerlink" title="这个信号处理函数执行完毕之后，父进程就可以像往常一样接受命令请求了"></a>这个信号处理函数执行完毕之后，父进程就可以像往常一样接受命令请求了</h4></li>
<li><h4 id="在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。"><a href="#在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。" class="headerlink" title="在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。"></a>在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。</h4></li>
<li><h4 id="例子：-1"><a href="#例子：-1" class="headerlink" title="例子："></a>例子：</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803114613406.png" alt="image-20220803114613406"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803114654704.png" alt="image-20220803114654704"></p>
<h3 id="11-4-重点回顾"><a href="#11-4-重点回顾" class="headerlink" title="11.4    重点回顾"></a>11.4    重点回顾</h3><ul>
<li><h4 id="AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态"><a href="#AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态" class="headerlink" title="AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态"></a>AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态</h4></li>
<li><h4 id="AOF文件中的所有命令都以Redis命令请求协议的格式保存"><a href="#AOF文件中的所有命令都以Redis命令请求协议的格式保存" class="headerlink" title="AOF文件中的所有命令都以Redis命令请求协议的格式保存"></a>AOF文件中的所有命令都以Redis命令请求协议的格式保存</h4></li>
<li><h4 id="命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件"><a href="#命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件" class="headerlink" title="命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件"></a>命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件</h4></li>
<li><h4 id="appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器性能有很大的影响。"><a href="#appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器性能有很大的影响。" class="headerlink" title="appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器性能有很大的影响。"></a>appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器性能有很大的影响。</h4></li>
<li><h4 id="服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态"><a href="#服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态" class="headerlink" title="服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态"></a>服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态</h4></li>
<li><h4 id="AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原来的AOF文件所保存的数据库状态是一致的，但体积更小"><a href="#AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原来的AOF文件所保存的数据库状态是一致的，但体积更小" class="headerlink" title="AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原来的AOF文件所保存的数据库状态是一致的，但体积更小"></a>AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原来的AOF文件所保存的数据库状态是一致的，但体积更小</h4></li>
<li><h4 id="AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无需对现有的AOF文件进行任何读入，分析，或者写入操作"><a href="#AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无需对现有的AOF文件进行任何读入，分析，或者写入操作" class="headerlink" title="AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无需对现有的AOF文件进行任何读入，分析，或者写入操作"></a>AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无需对现有的AOF文件进行任何读入，分析，或者写入操作</h4></li>
<li><h4 id="在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令，当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中所有的内容追加到新AOF文件的末尾，这使得新旧两个AOF文件所保存的数据库状态一致，最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。"><a href="#在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令，当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中所有的内容追加到新AOF文件的末尾，这使得新旧两个AOF文件所保存的数据库状态一致，最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。" class="headerlink" title="在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令，当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中所有的内容追加到新AOF文件的末尾，这使得新旧两个AOF文件所保存的数据库状态一致，最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。"></a>在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令，当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中所有的内容追加到新AOF文件的末尾，这使得新旧两个AOF文件所保存的数据库状态一致，最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。</h4></li>
</ul>
<h2 id="Chapter-12-事件"><a href="#Chapter-12-事件" class="headerlink" title="Chapter  12   事件"></a>Chapter  12   事件</h2><ol>
<li><h4 id="Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件："><a href="#Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件：" class="headerlink" title="Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件："></a>Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件：</h4><ol>
<li><h4 id="文件事件：Redis-服务器通过套接字与客户端（或者其他Redis服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或者其他服务器）的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作"><a href="#文件事件：Redis-服务器通过套接字与客户端（或者其他Redis服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或者其他服务器）的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作" class="headerlink" title="文件事件：Redis  服务器通过套接字与客户端（或者其他Redis服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或者其他服务器）的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作"></a>文件事件：Redis  服务器通过套接字与客户端（或者其他Redis服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或者其他服务器）的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作</h4></li>
<li><h4 id="时间事件，Redis服务器中的一些操作，（比如serverCron函数）需要在给定的事件点执行，而时间事件就是服务器对这类定时操作的抽象。"><a href="#时间事件，Redis服务器中的一些操作，（比如serverCron函数）需要在给定的事件点执行，而时间事件就是服务器对这类定时操作的抽象。" class="headerlink" title="时间事件，Redis服务器中的一些操作，（比如serverCron函数）需要在给定的事件点执行，而时间事件就是服务器对这类定时操作的抽象。"></a>时间事件，Redis服务器中的一些操作，（比如serverCron函数）需要在给定的事件点执行，而时间事件就是服务器对这类定时操作的抽象。</h4></li>
</ol>
</li>
</ol>
<h3 id="12-1-文件事件"><a href="#12-1-文件事件" class="headerlink" title="12.1   文件事件"></a>12.1   文件事件</h3><ul>
<li><h4 id="Redis-基础Reactor-模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器（file-event-handler）-："><a href="#Redis-基础Reactor-模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器（file-event-handler）-：" class="headerlink" title="Redis  基础Reactor  模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器（file event handler）  ："></a>Redis  基础Reactor  模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器（file event handler）  ：</h4><ul>
<li><h4 id="文件事件处理器使用-I-x2F-O-多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器"><a href="#文件事件处理器使用-I-x2F-O-多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器" class="headerlink" title="文件事件处理器使用 I&#x2F;O 多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器"></a>文件事件处理器使用 I&#x2F;O 多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器</h4></li>
<li><h4 id="当监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。"><a href="#当监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。" class="headerlink" title="当监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。"></a>当监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。</h4></li>
</ul>
</li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803173544953.png" alt="image-20220803173544953"></p>
<h4 id="12-1-1-文件事件处理器的构成"><a href="#12-1-1-文件事件处理器的构成" class="headerlink" title="12.1.1   文件事件处理器的构成"></a>12.1.1   文件事件处理器的构成</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803173641136.png" alt="image-20220803173641136"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803173656883.png" alt="image-20220803173656883"></p>
<h4 id="12-1-2-I-x2F-O-多路复用程序的实现"><a href="#12-1-2-I-x2F-O-多路复用程序的实现" class="headerlink" title="12.1.2    I&#x2F;O  多路复用程序的实现"></a>12.1.2    I&#x2F;O  多路复用程序的实现</h4><ol>
<li><h4 id="Redis-的I-x2F-O-多路复用程序的所有功能-都是通过包装常见的-select-，epoll，evport，和kqueue-这些I-x2F-O-多路复用函数库来实现的。"><a href="#Redis-的I-x2F-O-多路复用程序的所有功能-都是通过包装常见的-select-，epoll，evport，和kqueue-这些I-x2F-O-多路复用函数库来实现的。" class="headerlink" title="Redis 的I&#x2F;O 多路复用程序的所有功能 都是通过包装常见的 select ，epoll，evport，和kqueue 这些I&#x2F;O 多路复用函数库来实现的。"></a>Redis 的I&#x2F;O 多路复用程序的所有功能 都是通过包装常见的 select ，epoll，evport，和kqueue 这些I&#x2F;O 多路复用函数库来实现的。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803174044136.png" alt="image-20220803174044136"></p>
<h4 id="12-1-13-事件的类型"><a href="#12-1-13-事件的类型" class="headerlink" title="12.1.13  事件的类型"></a>12.1.13  事件的类型</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803174501128.png" alt="image-20220803174501128"></p>
<h4 id="12-1-4-API"><a href="#12-1-4-API" class="headerlink" title="12.1.4   API"></a>12.1.4   API</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803174803360.png" alt="image-20220803174803360"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803174811470.png" alt="image-20220803174811470"></p>
<h4 id="12-1-5-文件事件的处理器"><a href="#12-1-5-文件事件的处理器" class="headerlink" title="12.1.5      文件事件的处理器"></a>12.1.5      文件事件的处理器</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191417715.png" alt="image-20220803191417715"></p>
<ol>
<li><h4 id="连接应答处理器"><a href="#连接应答处理器" class="headerlink" title="连接应答处理器"></a>连接应答处理器</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191531120.png" alt="image-20220803191531120"></p>
<ul>
<li><h4 id="命令请求处理器"><a href="#命令请求处理器" class="headerlink" title="命令请求处理器"></a>命令请求处理器</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191607630.png" alt="image-20220803191607630"></p>
<ul>
<li><h4 id="命令回复处理器"><a href="#命令回复处理器" class="headerlink" title="命令回复处理器"></a>命令回复处理器</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191631132.png" alt="image-20220803191631132"></p>
<ul>
<li><h4 id="一次完整的客户端与服务器连接事件示例"><a href="#一次完整的客户端与服务器连接事件示例" class="headerlink" title="一次完整的客户端与服务器连接事件示例"></a>一次完整的客户端与服务器连接事件示例</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191708213.png" alt="image-20220803191708213"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803191717781.png" alt="image-20220803191717781"></p>
<h3 id="12-2-时间事件"><a href="#12-2-时间事件" class="headerlink" title="12.2   时间事件"></a>12.2   时间事件</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192155324.png" alt="image-20220803192155324"></p>
<h4 id="12-2-1-实现"><a href="#12-2-1-实现" class="headerlink" title="12.2.1  实现"></a>12.2.1  实现</h4><ol>
<li><h4 id="服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有-已到达的时间事件，并调用相应的事件处理器。"><a href="#服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有-已到达的时间事件，并调用相应的事件处理器。" class="headerlink" title="服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有 已到达的时间事件，并调用相应的事件处理器。"></a>服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有 已到达的时间事件，并调用相应的事件处理器。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192349600.png" alt="image-20220803192349600"></p>
<ol>
<li><h4 id="我们说保存的时间事件的链表是无序链表，指的不是链表不按ID排序，而是说，该链表不按when属性的大小排序，正因为链表没有按when属性进行排序，所以当时间事件执行器运行时，它必须遍历链表中的所有时间事件，这样才能保证服务器中所有已到达的事件事件都会被处理。"><a href="#我们说保存的时间事件的链表是无序链表，指的不是链表不按ID排序，而是说，该链表不按when属性的大小排序，正因为链表没有按when属性进行排序，所以当时间事件执行器运行时，它必须遍历链表中的所有时间事件，这样才能保证服务器中所有已到达的事件事件都会被处理。" class="headerlink" title="我们说保存的时间事件的链表是无序链表，指的不是链表不按ID排序，而是说，该链表不按when属性的大小排序，正因为链表没有按when属性进行排序，所以当时间事件执行器运行时，它必须遍历链表中的所有时间事件，这样才能保证服务器中所有已到达的事件事件都会被处理。"></a>我们说保存的时间事件的链表是无序链表，指的不是链表不按ID排序，而是说，该链表不按when属性的大小排序，正因为链表没有按when属性进行排序，所以当时间事件执行器运行时，它必须遍历链表中的所有时间事件，这样才能保证服务器中所有已到达的事件事件都会被处理。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192759866.png" alt="image-20220803192759866"></p>
<h4 id="12-2-2-API"><a href="#12-2-2-API" class="headerlink" title="12.2.2   API"></a>12.2.2   API</h4><h4 id="12-2-3-时间事件应用案例：-serverCron-函数"><a href="#12-2-3-时间事件应用案例：-serverCron-函数" class="headerlink" title="12.2.3  时间事件应用案例： serverCron 函数"></a>12.2.3  时间事件应用案例： serverCron 函数</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192909480.png" alt="image-20220803192909480"></p>
<h3 id="12-3-事件的调度与执行"><a href="#12-3-事件的调度与执行" class="headerlink" title="12.3    事件的调度与执行"></a>12.3    事件的调度与执行</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192945350.png" alt="image-20220803192945350"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803192954947.png" alt="image-20220803192954947"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803193014312.png" alt="image-20220803193014312"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220803193023328.png" alt="image-20220803193023328"></p>
<h3 id="12-4-重点回顾"><a href="#12-4-重点回顾" class="headerlink" title="12.4     重点回顾"></a>12.4     重点回顾</h3><ul>
<li><h4 id="Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件"><a href="#Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件" class="headerlink" title="Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件"></a>Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件</h4></li>
<li><h4 id="文件事件处理器是基于Reactor模式实现的网络通信程序"><a href="#文件事件处理器是基于Reactor模式实现的网络通信程序" class="headerlink" title="文件事件处理器是基于Reactor模式实现的网络通信程序"></a>文件事件处理器是基于Reactor模式实现的网络通信程序</h4></li>
<li><h4 id="文件事件是对套接字操作的抽象：每次套接字变为可应答，可读写，或者可读时，相应的文件事件就会产生"><a href="#文件事件是对套接字操作的抽象：每次套接字变为可应答，可读写，或者可读时，相应的文件事件就会产生" class="headerlink" title="文件事件是对套接字操作的抽象：每次套接字变为可应答，可读写，或者可读时，相应的文件事件就会产生"></a>文件事件是对套接字操作的抽象：每次套接字变为可应答，可读写，或者可读时，相应的文件事件就会产生</h4></li>
<li><h4 id="文件事件分为AE-READABLE-事件（读事件），和AE-WRITABLE（写事件）"><a href="#文件事件分为AE-READABLE-事件（读事件），和AE-WRITABLE（写事件）" class="headerlink" title="文件事件分为AE_READABLE  事件（读事件），和AE_WRITABLE（写事件）"></a>文件事件分为AE_READABLE  事件（读事件），和AE_WRITABLE（写事件）</h4></li>
<li><h4 id="时间事件分为定时事件和周期性事件：定时事件只在指定的事件到达一次，而-周期性事件则隔每一段时间到达一次。"><a href="#时间事件分为定时事件和周期性事件：定时事件只在指定的事件到达一次，而-周期性事件则隔每一段时间到达一次。" class="headerlink" title="时间事件分为定时事件和周期性事件：定时事件只在指定的事件到达一次，而 周期性事件则隔每一段时间到达一次。"></a>时间事件分为定时事件和周期性事件：定时事件只在指定的事件到达一次，而 周期性事件则隔每一段时间到达一次。</h4></li>
<li><h4 id="服务器在一般情况下只执行serverCron函数一个事件，并且这个事件是周期性事件。"><a href="#服务器在一般情况下只执行serverCron函数一个事件，并且这个事件是周期性事件。" class="headerlink" title="服务器在一般情况下只执行serverCron函数一个事件，并且这个事件是周期性事件。"></a>服务器在一般情况下只执行serverCron函数一个事件，并且这个事件是周期性事件。</h4></li>
<li><h4 id="文件事件和时间时间之间是合作关系，服务器会轮流处理这两种事件，并且处理这两种事件的过程中也不会进行抢占"><a href="#文件事件和时间时间之间是合作关系，服务器会轮流处理这两种事件，并且处理这两种事件的过程中也不会进行抢占" class="headerlink" title="文件事件和时间时间之间是合作关系，服务器会轮流处理这两种事件，并且处理这两种事件的过程中也不会进行抢占"></a>文件事件和时间时间之间是合作关系，服务器会轮流处理这两种事件，并且处理这两种事件的过程中也不会进行抢占</h4></li>
<li><h4 id="时间事件的实际处理事件通常会比设定的达到时间晚一些。"><a href="#时间事件的实际处理事件通常会比设定的达到时间晚一些。" class="headerlink" title="时间事件的实际处理事件通常会比设定的达到时间晚一些。"></a>时间事件的实际处理事件通常会比设定的达到时间晚一些。</h4></li>
</ul>
<h2 id="Chapter-13-客户端"><a href="#Chapter-13-客户端" class="headerlink" title="Chapter 13  客户端"></a>Chapter 13  客户端</h2><ul>
<li><h4 id="Redis-服务器是典型的一对多服务器程序：-x3D-x3D-一个服务器可以和多个客户端建立网络连接，每个客户端可以向服务器发送命令请求，而服务器则接收并处理客户端发送的请求命令，并向客户端返回命令回复。-x3D-x3D"><a href="#Redis-服务器是典型的一对多服务器程序：-x3D-x3D-一个服务器可以和多个客户端建立网络连接，每个客户端可以向服务器发送命令请求，而服务器则接收并处理客户端发送的请求命令，并向客户端返回命令回复。-x3D-x3D" class="headerlink" title="Redis 服务器是典型的一对多服务器程序：&#x3D;&#x3D;一个服务器可以和多个客户端建立网络连接，每个客户端可以向服务器发送命令请求，而服务器则接收并处理客户端发送的请求命令，并向客户端返回命令回复。&#x3D;&#x3D;"></a>Redis 服务器是典型的一对多服务器程序：&#x3D;&#x3D;一个服务器可以和多个客户端建立网络连接，每个客户端可以向服务器发送命令请求，而服务器则接收并处理客户端发送的请求命令，并向客户端返回命令回复。&#x3D;&#x3D;</h4></li>
</ul>
<ol>
<li><h4 id="通过使用由I-x2F-O多路复用技术实现的文件事件处理器，-x3D-x3D-Redis服务器使用单线程单进程的方式来处理命令请求，并与多个客户端进行网络通信。-x3D-x3D"><a href="#通过使用由I-x2F-O多路复用技术实现的文件事件处理器，-x3D-x3D-Redis服务器使用单线程单进程的方式来处理命令请求，并与多个客户端进行网络通信。-x3D-x3D" class="headerlink" title="通过使用由I&#x2F;O多路复用技术实现的文件事件处理器，&#x3D;&#x3D;Redis服务器使用单线程单进程的方式来处理命令请求，并与多个客户端进行网络通信。&#x3D;&#x3D;"></a>通过使用由I&#x2F;O多路复用技术实现的文件事件处理器，&#x3D;&#x3D;Redis服务器使用单线程单进程的方式来处理命令请求，并与多个客户端进行网络通信。&#x3D;&#x3D;</h4></li>
</ol>
<ul>
<li><h4 id="对于每个与服务器进行连接的客户端，服务器都为这些客户端建立了相应的redis-h-x2F-redisClient结构——客户端状态，这个结构保存了客户端当前的状态信息，以及执行相关功能时需要用到的数据结构"><a href="#对于每个与服务器进行连接的客户端，服务器都为这些客户端建立了相应的redis-h-x2F-redisClient结构——客户端状态，这个结构保存了客户端当前的状态信息，以及执行相关功能时需要用到的数据结构" class="headerlink" title="对于每个与服务器进行连接的客户端，服务器都为这些客户端建立了相应的redis.h&#x2F;redisClient结构——客户端状态，这个结构保存了客户端当前的状态信息，以及执行相关功能时需要用到的数据结构"></a>对于每个与服务器进行连接的客户端，服务器都为这些客户端建立了相应的redis.h&#x2F;redisClient结构——客户端状态，这个结构保存了客户端当前的状态信息，以及执行相关功能时需要用到的数据结构</h4><ul>
<li><h4 id="。-2"><a href="#。-2" class="headerlink" title="。"></a><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804105213625.png" alt="image-20220804105213625">。</h4></li>
</ul>
</li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804105436306.png" alt="image-20220804105436306"></p>
<h3 id="13-1-客户端属性"><a href="#13-1-客户端属性" class="headerlink" title="13.1   客户端属性"></a>13.1   客户端属性</h3><ul>
<li><h4 id="客户端状态包含的属性可以分为以下两类："><a href="#客户端状态包含的属性可以分为以下两类：" class="headerlink" title="客户端状态包含的属性可以分为以下两类："></a>客户端状态包含的属性可以分为以下两类：</h4></li>
</ul>
<ol>
<li><h4 id="一类是比较通用的属性，这些属性很少与特定功能相关，无论客户端执行的是什么工作，他们都需要用到这些属性"><a href="#一类是比较通用的属性，这些属性很少与特定功能相关，无论客户端执行的是什么工作，他们都需要用到这些属性" class="headerlink" title="一类是比较通用的属性，这些属性很少与特定功能相关，无论客户端执行的是什么工作，他们都需要用到这些属性"></a>一类是比较通用的属性，这些属性很少与特定功能相关，无论客户端执行的是什么工作，他们都需要用到这些属性</h4></li>
<li><h4 id="另外一类是和特定功能线相关的属性，比如操作数据库需要用到的db属性和dictid属性，执行事务时需要用到的matate属性，以及执行watch命令时需要用到的watched-keys属性等。"><a href="#另外一类是和特定功能线相关的属性，比如操作数据库需要用到的db属性和dictid属性，执行事务时需要用到的matate属性，以及执行watch命令时需要用到的watched-keys属性等。" class="headerlink" title="另外一类是和特定功能线相关的属性，比如操作数据库需要用到的db属性和dictid属性，执行事务时需要用到的matate属性，以及执行watch命令时需要用到的watched_keys属性等。"></a>另外一类是和特定功能线相关的属性，比如操作数据库需要用到的db属性和dictid属性，执行事务时需要用到的matate属性，以及执行watch命令时需要用到的watched_keys属性等。</h4></li>
</ol>
<h4 id="13-1-1-套接字描述符"><a href="#13-1-1-套接字描述符" class="headerlink" title="13.1.1   套接字描述符"></a>13.1.1   套接字描述符</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804111840461.png" alt="image-20220804111840461"></p>
<h4 id="13-1-2-名字"><a href="#13-1-2-名字" class="headerlink" title="13.1.2 名字"></a>13.1.2 名字</h4><ol>
<li><h4 id="在默认情况下，一个连接到服务器的客户端是没有名字的。"><a href="#在默认情况下，一个连接到服务器的客户端是没有名字的。" class="headerlink" title="在默认情况下，一个连接到服务器的客户端是没有名字的。"></a>在默认情况下，一个连接到服务器的客户端是没有名字的。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804111955102.png" alt="image-20220804111955102"></p>
<ol>
<li><h4 id="使用client-setname-命令可以为客户端设置一个名字，让客户端身份变得更清晰，"><a href="#使用client-setname-命令可以为客户端设置一个名字，让客户端身份变得更清晰，" class="headerlink" title="使用client  setname 命令可以为客户端设置一个名字，让客户端身份变得更清晰，"></a>使用client  setname 命令可以为客户端设置一个名字，让客户端身份变得更清晰，</h4></li>
<li><h4 id="如果客户端没有为自己设置名字，那么相应客户端状态的name属性指向NULL指针，反之则指向一个字符串对象，该对象保存着客户端的名字。"><a href="#如果客户端没有为自己设置名字，那么相应客户端状态的name属性指向NULL指针，反之则指向一个字符串对象，该对象保存着客户端的名字。" class="headerlink" title="如果客户端没有为自己设置名字，那么相应客户端状态的name属性指向NULL指针，反之则指向一个字符串对象，该对象保存着客户端的名字。"></a>如果客户端没有为自己设置名字，那么相应客户端状态的name属性指向NULL指针，反之则指向一个字符串对象，该对象保存着客户端的名字。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804112104721.png" alt="image-20220804112104721"></p>
<h4 id="13-1-3-标志"><a href="#13-1-3-标志" class="headerlink" title="13.1.3   标志"></a>13.1.3   标志</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804112301616.png" alt="image-20220804112301616"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804112309789.png" alt="image-20220804112309789"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804112323416.png" alt="image-20220804112323416"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804112346571.png" alt="image-20220804112346571"></p>
<h4 id="13-1-4-输入缓冲区"><a href="#13-1-4-输入缓冲区" class="headerlink" title="13.1.4   输入缓冲区"></a>13.1.4   输入缓冲区</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804211856740.png" alt="image-20220804211856740"></p>
<ol>
<li><h4 id="输入缓冲区的大小会根据输入内容动态的缩小或扩大，但它的最大大小不能超过1GB-否则服务器将关闭这个客户端"><a href="#输入缓冲区的大小会根据输入内容动态的缩小或扩大，但它的最大大小不能超过1GB-否则服务器将关闭这个客户端" class="headerlink" title="输入缓冲区的大小会根据输入内容动态的缩小或扩大，但它的最大大小不能超过1GB,否则服务器将关闭这个客户端"></a>输入缓冲区的大小会根据输入内容动态的缩小或扩大，但它的最大大小不能超过1GB,否则服务器将关闭这个客户端</h4></li>
<li><h4 id="。-3"><a href="#。-3" class="headerlink" title="。"></a>。</h4></li>
</ol>
<h4 id="13-1-5-命令与命令参数"><a href="#13-1-5-命令与命令参数" class="headerlink" title="13.1.5   命令与命令参数"></a>13.1.5   命令与命令参数</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804212541854.png" alt="image-20220804212541854"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804212553533.png" alt="image-20220804212553533"></p>
<h4 id="13-1-6-命令的实现函数"><a href="#13-1-6-命令的实现函数" class="headerlink" title="13.1.6      命令的实现函数"></a>13.1.6      命令的实现函数</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804213150514.png" alt="image-20220804213150514"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804213320147.png" alt="image-20220804213320147"></p>
<h4 id="13-1-7-输出缓冲区"><a href="#13-1-7-输出缓冲区" class="headerlink" title="13.1.7 输出缓冲区"></a>13.1.7 输出缓冲区</h4><ol>
<li><h4 id="执行命令所得到的命令回复会被保存在客户端状态的输出缓存区里，每个客户端都有两个输出缓冲区，一个缓冲区的大小是固定的，另一个缓冲区的大小是可变的"><a href="#执行命令所得到的命令回复会被保存在客户端状态的输出缓存区里，每个客户端都有两个输出缓冲区，一个缓冲区的大小是固定的，另一个缓冲区的大小是可变的" class="headerlink" title="执行命令所得到的命令回复会被保存在客户端状态的输出缓存区里，每个客户端都有两个输出缓冲区，一个缓冲区的大小是固定的，另一个缓冲区的大小是可变的"></a>执行命令所得到的命令回复会被保存在客户端状态的输出缓存区里，每个客户端都有两个输出缓冲区，一个缓冲区的大小是固定的，另一个缓冲区的大小是可变的</h4><ul>
<li><h4 id="x3D-x3D-固定大小的缓冲区用于保存那些长度比较小的回复-x3D-x3D-，比如OK，简短的字符串值，整数值，错误的回复等"><a href="#x3D-x3D-固定大小的缓冲区用于保存那些长度比较小的回复-x3D-x3D-，比如OK，简短的字符串值，整数值，错误的回复等" class="headerlink" title="&#x3D;&#x3D;固定大小的缓冲区用于保存那些长度比较小的回复&#x3D;&#x3D;，比如OK，简短的字符串值，整数值，错误的回复等"></a>&#x3D;&#x3D;固定大小的缓冲区用于保存那些长度比较小的回复&#x3D;&#x3D;，比如OK，简短的字符串值，整数值，错误的回复等</h4></li>
<li><h4 id="可变大小的缓冲区用于保存那些长度较长的回复，比如一个非常长的字符串值，一个由很多项组成的列表，一个包含了很多元素的集合。"><a href="#可变大小的缓冲区用于保存那些长度较长的回复，比如一个非常长的字符串值，一个由很多项组成的列表，一个包含了很多元素的集合。" class="headerlink" title="可变大小的缓冲区用于保存那些长度较长的回复，比如一个非常长的字符串值，一个由很多项组成的列表，一个包含了很多元素的集合。"></a>可变大小的缓冲区用于保存那些长度较长的回复，比如一个非常长的字符串值，一个由很多项组成的列表，一个包含了很多元素的集合。</h4></li>
</ul>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804214429579.png" alt="image-20220804214429579"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804214509948.png" alt="image-20220804214509948"></p>
<h4 id="13-1-8-身份验证"><a href="#13-1-8-身份验证" class="headerlink" title="13.1.8   身份验证"></a>13.1.8   身份验证</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisClient</span>&#123;</span><br>    <span class="hljs-type">int</span> authenticated ;<br>&#125;redisClient;<br></code></pre></td></tr></table></figure>



<ol>
<li><h4 id="如果authenticated-的值为0则验证未通过，如果为1则验证通过"><a href="#如果authenticated-的值为0则验证未通过，如果为1则验证通过" class="headerlink" title="如果authenticated 的值为0则验证未通过，如果为1则验证通过"></a>如果authenticated 的值为0则验证未通过，如果为1则验证通过</h4></li>
<li><h4 id="。-4"><a href="#。-4" class="headerlink" title="。"></a><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804214913586.png" alt="image-20220804214913586">。</h4></li>
<li><h4 id="通过auth-命令进行身份验证"><a href="#通过auth-命令进行身份验证" class="headerlink" title="通过auth 命令进行身份验证"></a>通过auth 命令进行身份验证</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804214938146.png" alt="image-20220804214938146"></p>
<ul>
<li><h4 id="仅在服务器启用了身份验证功能时使用，-x3D-x3D-如果服务器没有启用身份验证功能，那么即使authenticated为0，服务器也不会拒绝执行客户端发生的命令请求。-x3D-x3D"><a href="#仅在服务器启用了身份验证功能时使用，-x3D-x3D-如果服务器没有启用身份验证功能，那么即使authenticated为0，服务器也不会拒绝执行客户端发生的命令请求。-x3D-x3D" class="headerlink" title="仅在服务器启用了身份验证功能时使用，&#x3D;&#x3D;如果服务器没有启用身份验证功能，那么即使authenticated为0，服务器也不会拒绝执行客户端发生的命令请求。&#x3D;&#x3D;"></a>仅在服务器启用了身份验证功能时使用，&#x3D;&#x3D;如果服务器没有启用身份验证功能，那么即使authenticated为0，服务器也不会拒绝执行客户端发生的命令请求。&#x3D;&#x3D;</h4></li>
</ul>
<h4 id="13-1-9-时间"><a href="#13-1-9-时间" class="headerlink" title="13.1.9      时间"></a>13.1.9      时间</h4><ul>
<li><h4 id="客户端与时间相关的属性。"><a href="#客户端与时间相关的属性。" class="headerlink" title="客户端与时间相关的属性。"></a>客户端与时间相关的属性。</h4></li>
</ul>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804215203911.png" alt="image-20220804215203911"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804215457926.png" alt="image-20220804215457926"></p>
<ol>
<li><h4 id="ctime"><a href="#ctime" class="headerlink" title="ctime"></a>ctime</h4></li>
<li><h4 id="lastinteraction。"><a href="#lastinteraction。" class="headerlink" title="lastinteraction。"></a>lastinteraction。</h4></li>
</ol>
<h3 id="13-2-客户端的创建与关闭"><a href="#13-2-客户端的创建与关闭" class="headerlink" title="13.2   客户端的创建与关闭"></a>13.2   客户端的创建与关闭</h3><ul>
<li><h4 id="服务器使用不同的方式来创建和关闭不同类型的客户端。"><a href="#服务器使用不同的方式来创建和关闭不同类型的客户端。" class="headerlink" title="服务器使用不同的方式来创建和关闭不同类型的客户端。"></a>服务器使用不同的方式来创建和关闭不同类型的客户端。</h4></li>
</ul>
<h4 id="13-2-1-创建普通客户端"><a href="#13-2-1-创建普通客户端" class="headerlink" title="13.2.1   创建普通客户端"></a>13.2.1   创建普通客户端</h4><ol>
<li><h4 id="通过connect函数连接服务器"><a href="#通过connect函数连接服务器" class="headerlink" title="通过connect函数连接服务器"></a>通过connect函数连接服务器</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804220020419.png" alt="image-20220804220020419"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804220028578.png" alt="image-20220804220028578"></p>
<h4 id="13-2-2-关闭普通客户端"><a href="#13-2-2-关闭普通客户端" class="headerlink" title="13.2.2  关闭普通客户端"></a>13.2.2  关闭普通客户端</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804222219110.png" alt="image-20220804222219110"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220804222733125.png" alt="image-20220804222733125"></p>
<p>13.2.3  Lua脚本的伪客户端</p>
<ol>
<li><h4 id="服务器会在初始化时创建负责执行lua脚本中包含的Redis命令的为客户端，并将这个伪客户端关联在服务器状态结构的lua-client属性中。"><a href="#服务器会在初始化时创建负责执行lua脚本中包含的Redis命令的为客户端，并将这个伪客户端关联在服务器状态结构的lua-client属性中。" class="headerlink" title="服务器会在初始化时创建负责执行lua脚本中包含的Redis命令的为客户端，并将这个伪客户端关联在服务器状态结构的lua_client属性中。"></a>服务器会在初始化时创建负责执行lua脚本中包含的Redis命令的为客户端，并将这个伪客户端关联在服务器状态结构的lua_client属性中。</h4></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisServer</span>&#123;</span><br>    redisClient  * lua_client ;<br>&#125;;<br></code></pre></td></tr></table></figure>



<ol>
<li><h4 id="lua-client-伪客户端在服务器运行的整个生命周期中会一直存在，只有服务器关闭时，这个客户端才会被关闭。"><a href="#lua-client-伪客户端在服务器运行的整个生命周期中会一直存在，只有服务器关闭时，这个客户端才会被关闭。" class="headerlink" title="lua_client 伪客户端在服务器运行的整个生命周期中会一直存在，只有服务器关闭时，这个客户端才会被关闭。"></a>lua_client 伪客户端在服务器运行的整个生命周期中会一直存在，只有服务器关闭时，这个客户端才会被关闭。</h4></li>
</ol>
<h4 id="13-2-4-AOF文件的为客户端"><a href="#13-2-4-AOF文件的为客户端" class="headerlink" title="13.2.4  AOF文件的为客户端"></a>13.2.4  AOF文件的为客户端</h4><ul>
<li><h4 id="服务器在载入AOF文件时，会创建用于执行AOF文件包含的Redis命令的为客户端，并在载入完成之后，关闭这个为客户端。"><a href="#服务器在载入AOF文件时，会创建用于执行AOF文件包含的Redis命令的为客户端，并在载入完成之后，关闭这个为客户端。" class="headerlink" title="服务器在载入AOF文件时，会创建用于执行AOF文件包含的Redis命令的为客户端，并在载入完成之后，关闭这个为客户端。"></a>服务器在载入AOF文件时，会创建用于执行AOF文件包含的Redis命令的为客户端，并在载入完成之后，关闭这个为客户端。</h4></li>
</ul>
<h3 id="13-3-重点回顾"><a href="#13-3-重点回顾" class="headerlink" title="13.3   重点回顾"></a>13.3   重点回顾</h3><ul>
<li><h4 id="服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾"><a href="#服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾" class="headerlink" title="服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾"></a>服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾</h4></li>
<li><h4 id="客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态"><a href="#客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态" class="headerlink" title="客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态"></a>客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态</h4></li>
<li><h4 id="输入缓冲回区记录了客户端发送的请求命令，这个缓冲区的大小不能超过1GB"><a href="#输入缓冲回区记录了客户端发送的请求命令，这个缓冲区的大小不能超过1GB" class="headerlink" title="输入缓冲回区记录了客户端发送的请求命令，这个缓冲区的大小不能超过1GB"></a>输入缓冲回区记录了客户端发送的请求命令，这个缓冲区的大小不能超过1GB</h4></li>
<li><h4 id="命令的参数和参数个数会被记录在客户端状态的argv和argc属性里面，而cmd属性则记录了客户端要执行命令的实现函数"><a href="#命令的参数和参数个数会被记录在客户端状态的argv和argc属性里面，而cmd属性则记录了客户端要执行命令的实现函数" class="headerlink" title="命令的参数和参数个数会被记录在客户端状态的argv和argc属性里面，而cmd属性则记录了客户端要执行命令的实现函数"></a>命令的参数和参数个数会被记录在客户端状态的argv和argc属性里面，而cmd属性则记录了客户端要执行命令的实现函数</h4></li>
<li><h4 id="客户端由固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大量大小不能超过服务器设置的硬性限制值"><a href="#客户端由固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大量大小不能超过服务器设置的硬性限制值" class="headerlink" title="客户端由固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大量大小不能超过服务器设置的硬性限制值"></a>客户端由固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大量大小不能超过服务器设置的硬性限制值</h4></li>
<li><h4 id="输出缓冲区限制有两种，如果输出缓冲区的大小超过了服务区设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务区设置的软性限制，那么客户端也会被关闭"><a href="#输出缓冲区限制有两种，如果输出缓冲区的大小超过了服务区设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务区设置的软性限制，那么客户端也会被关闭" class="headerlink" title="输出缓冲区限制有两种，如果输出缓冲区的大小超过了服务区设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务区设置的软性限制，那么客户端也会被关闭"></a>输出缓冲区限制有两种，如果输出缓冲区的大小超过了服务区设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务区设置的软性限制，那么客户端也会被关闭</h4></li>
<li><h4 id="当一个客户端通过网络连接连上了服务器，服务器就会为这个客户端创建相应的客户端状态，网络连接关闭，发送了不合协议格式的命令请求，称为CLient-kill-命令的目标，空间时间超时，输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭"><a href="#当一个客户端通过网络连接连上了服务器，服务器就会为这个客户端创建相应的客户端状态，网络连接关闭，发送了不合协议格式的命令请求，称为CLient-kill-命令的目标，空间时间超时，输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭" class="headerlink" title="当一个客户端通过网络连接连上了服务器，服务器就会为这个客户端创建相应的客户端状态，网络连接关闭，发送了不合协议格式的命令请求，称为CLient kill 命令的目标，空间时间超时，输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭"></a>当一个客户端通过网络连接连上了服务器，服务器就会为这个客户端创建相应的客户端状态，网络连接关闭，发送了不合协议格式的命令请求，称为CLient kill 命令的目标，空间时间超时，输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭</h4></li>
<li><h4 id="处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，知道服务器关闭"><a href="#处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，知道服务器关闭" class="headerlink" title="处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，知道服务器关闭"></a>处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，知道服务器关闭</h4></li>
<li><h4 id="载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭。"><a href="#载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭。" class="headerlink" title="载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭。"></a>载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭。</h4></li>
</ul>
<h2 id="Chapter-14-服务器"><a href="#Chapter-14-服务器" class="headerlink" title="Chapter 14   服务器"></a>Chapter 14   服务器</h2><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805122613197.png" alt="image-20220805122613197"></p>
<h3 id="14-1-命令请求的执行过程"><a href="#14-1-命令请求的执行过程" class="headerlink" title="14.1   命令请求的执行过程"></a>14.1   命令请求的执行过程</h3><ol>
<li><h4 id="以set操作为例"><a href="#以set操作为例" class="headerlink" title="以set操作为例"></a>以set操作为例</h4></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs redis">set key value <br><br></code></pre></td></tr></table></figure>



<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805122806620.png" alt="image-20220805122806620"></p>
<h4 id="14-1-1-发送命令请求"><a href="#14-1-1-发送命令请求" class="headerlink" title="14.1.1  发送命令请求"></a>14.1.1  发送命令请求</h4><ol>
<li><h4 id="Redis服务器的命令请求来自Redis客户端，当用户在客户端中键入一个命令时，-x3D-x3D-客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器-x3D-x3D-。"><a href="#Redis服务器的命令请求来自Redis客户端，当用户在客户端中键入一个命令时，-x3D-x3D-客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器-x3D-x3D-。" class="headerlink" title="Redis服务器的命令请求来自Redis客户端，当用户在客户端中键入一个命令时，&#x3D;&#x3D;客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器&#x3D;&#x3D;。"></a>Redis服务器的命令请求来自Redis客户端，当用户在客户端中键入一个命令时，&#x3D;&#x3D;客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器&#x3D;&#x3D;。</h4></li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805123837853.png" alt="image-20220805123837853"></p>
<h4 id="14-1-2-读取命令请求"><a href="#14-1-2-读取命令请求" class="headerlink" title="14.1.2  读取命令请求"></a>14.1.2  读取命令请求</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124050254.png" alt="image-20220805124050254"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124225177.png" alt="image-20220805124225177"></p>
<h4 id="14-1-3-命令执行器（1）：-查找命令实现"><a href="#14-1-3-命令执行器（1）：-查找命令实现" class="headerlink" title="14.1.3     命令执行器（1）： 查找命令实现"></a>14.1.3     命令执行器（1）： 查找命令实现</h4><ol>
<li><h4 id="命令执行器要做的第一件事激素根据客户端状态的argv-0-参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里。"><a href="#命令执行器要做的第一件事激素根据客户端状态的argv-0-参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里。" class="headerlink" title="命令执行器要做的第一件事激素根据客户端状态的argv[0]参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里。"></a>命令执行器要做的第一件事激素根据客户端状态的argv[0]参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里。</h4></li>
<li><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124730106.png" alt="image-20220805124730106"></p>
</li>
</ol>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124739252.png" alt="image-20220805124739252"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124805222.png" alt="image-20220805124805222"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124819284.png" alt="image-20220805124819284"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124829221.png" alt="image-20220805124829221"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124848094.png" alt="image-20220805124848094"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124901514.png" alt="image-20220805124901514"></p>
<h4 id="14-1-4-命令执行器（2）-：-执行预备操作"><a href="#14-1-4-命令执行器（2）-：-执行预备操作" class="headerlink" title="14.1.4   命令执行器（2） ： 执行预备操作"></a>14.1.4   命令执行器（2） ： 执行预备操作</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124939500.png" alt="image-20220805124939500"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805124951206.png" alt="image-20220805124951206"></p>
<ol>
<li><h4 id="以上只列出了服务器在单机模式下执行命令时的价差操作，当服务器在复制或者集群模式下执行命令时，预备操作还会更多一点"><a href="#以上只列出了服务器在单机模式下执行命令时的价差操作，当服务器在复制或者集群模式下执行命令时，预备操作还会更多一点" class="headerlink" title="以上只列出了服务器在单机模式下执行命令时的价差操作，当服务器在复制或者集群模式下执行命令时，预备操作还会更多一点.."></a>以上只列出了服务器在单机模式下执行命令时的价差操作，当服务器在复制或者集群模式下执行命令时，预备操作还会更多一点..</h4></li>
</ol>
<h4 id="14-1-5-命令执行器-3-调用命令的实现函数"><a href="#14-1-5-命令执行器-3-调用命令的实现函数" class="headerlink" title="14.1.5    命令执行器(3): 调用命令的实现函数"></a>14.1.5    命令执行器(3): 调用命令的实现函数</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805130159750.png" alt="image-20220805130159750"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805130301102.png" alt="image-20220805130301102"></p>
<h4 id="14-1-6-执行后续工作"><a href="#14-1-6-执行后续工作" class="headerlink" title="14.1.6    执行后续工作"></a>14.1.6    执行后续工作</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805130627044.png" alt="image-20220805130627044"></p>
<h4 id="14-1-7-将命令回复发送给客户端"><a href="#14-1-7-将命令回复发送给客户端" class="headerlink" title="14.1.7  将命令回复发送给客户端"></a>14.1.7  将命令回复发送给客户端</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805130658111.png" alt="image-20220805130658111"></p>
<h4 id="14-1-8-客户端接收并打印命令回复"><a href="#14-1-8-客户端接收并打印命令回复" class="headerlink" title="14.1.8  客户端接收并打印命令回复"></a>14.1.8  客户端接收并打印命令回复</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805130940734.png" alt="image-20220805130940734"></p>
<h3 id="14-2-serverCron-函数"><a href="#14-2-serverCron-函数" class="headerlink" title="14.2  serverCron  函数"></a>14.2  serverCron  函数</h3><ol>
<li><h4 id="Redis服务器中的serverCron函数默认每隔100ms执行一次-这个函数负责管理服务器的资源-并保持服务器自身的良好运转"><a href="#Redis服务器中的serverCron函数默认每隔100ms执行一次-这个函数负责管理服务器的资源-并保持服务器自身的良好运转" class="headerlink" title="Redis服务器中的serverCron函数默认每隔100ms执行一次,这个函数负责管理服务器的资源,并保持服务器自身的良好运转."></a>Redis服务器中的serverCron函数默认每隔100ms执行一次,这个函数负责管理服务器的资源,并保持服务器自身的良好运转.</h4></li>
</ol>
<h4 id="14-2-1-更新服务器时间缓存"><a href="#14-2-1-更新服务器时间缓存" class="headerlink" title="14.2.1     更新服务器时间缓存"></a>14.2.1     更新服务器时间缓存</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805132335117.png" alt="image-20220805132335117"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805132348564.png" alt="image-20220805132348564"></p>
<h4 id="14-2-2-更新LRU-时钟"><a href="#14-2-2-更新LRU-时钟" class="headerlink" title="14.2.2  更新LRU 时钟"></a>14.2.2  更新LRU 时钟</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805132623723.png" alt="image-20220805132623723"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805132659536.png" alt="image-20220805132659536"></p>
<h4 id="14-2-3-更新服务器每秒执行次数"><a href="#14-2-3-更新服务器每秒执行次数" class="headerlink" title="14.2.3  更新服务器每秒执行次数"></a>14.2.3  更新服务器每秒执行次数</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805132835186.png" alt="image-20220805132835186"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805133012355.png" alt="image-20220805133012355"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805133025283.png" alt="image-20220805133025283"></p>
<h4 id="14-2-4-更新服务器内存峰值记录"><a href="#14-2-4-更新服务器内存峰值记录" class="headerlink" title="14.2.4   更新服务器内存峰值记录"></a>14.2.4   更新服务器内存峰值记录</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805133141176.png" alt="image-20220805133141176"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805133148159.png" alt="image-20220805133148159"></p>
<h4 id="14-2-5-处理sigterm-信号"><a href="#14-2-5-处理sigterm-信号" class="headerlink" title="14.2.5  处理sigterm 信号"></a>14.2.5  处理sigterm 信号</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805135042951.png" alt="image-20220805135042951"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805135055790.png" alt="image-20220805135055790"></p>
<h4 id="14-2-6-管理客户端资源"><a href="#14-2-6-管理客户端资源" class="headerlink" title="14.2.6  管理客户端资源"></a>14.2.6  管理客户端资源</h4><ol>
<li><h4 id="serverCron函数每次执行都会调用clientsCron函数-clientsCron函数会对一定数量的客户端进行以下两个检查"><a href="#serverCron函数每次执行都会调用clientsCron函数-clientsCron函数会对一定数量的客户端进行以下两个检查" class="headerlink" title="serverCron函数每次执行都会调用clientsCron函数,clientsCron函数会对一定数量的客户端进行以下两个检查:"></a>serverCron函数每次执行都会调用clientsCron函数,clientsCron函数会对一定数量的客户端进行以下两个检查:</h4><ol>
<li><h4 id="如果客户端与服务器之间的连接已经超时-很长一段时间里客户端和服务器都没有互动-那么程序释放这个客户端"><a href="#如果客户端与服务器之间的连接已经超时-很长一段时间里客户端和服务器都没有互动-那么程序释放这个客户端" class="headerlink" title="如果客户端与服务器之间的连接已经超时,很长一段时间里客户端和服务器都没有互动,那么程序释放这个客户端"></a>如果客户端与服务器之间的连接已经超时,很长一段时间里客户端和服务器都没有互动,那么程序释放这个客户端</h4></li>
<li><h4 id="如果客户端在上一次执行命令请求之后-输入缓冲区的大小超过了一定的长度-那么程序会释放客户端当前的输入缓冲区-并重新创建一个默认大小的输入缓冲区-从而防止客户端的输入缓冲区耗费了过多的内存"><a href="#如果客户端在上一次执行命令请求之后-输入缓冲区的大小超过了一定的长度-那么程序会释放客户端当前的输入缓冲区-并重新创建一个默认大小的输入缓冲区-从而防止客户端的输入缓冲区耗费了过多的内存" class="headerlink" title="如果客户端在上一次执行命令请求之后,输入缓冲区的大小超过了一定的长度,那么程序会释放客户端当前的输入缓冲区,并重新创建一个默认大小的输入缓冲区,从而防止客户端的输入缓冲区耗费了过多的内存."></a>如果客户端在上一次执行命令请求之后,输入缓冲区的大小超过了一定的长度,那么程序会释放客户端当前的输入缓冲区,并重新创建一个默认大小的输入缓冲区,从而防止客户端的输入缓冲区耗费了过多的内存.</h4></li>
</ol>
</li>
</ol>
<h4 id="14-2-7-管理数据库资源"><a href="#14-2-7-管理数据库资源" class="headerlink" title="14.2.7   管理数据库资源"></a>14.2.7   管理数据库资源</h4><ol>
<li><h4 id="serverCron函数每次执行都会调用databasesCron函数-这个函数会对服务器中的一部分数据库进行检查-删除其中的过期键-并在有需要的时候-对字典进行伸缩"><a href="#serverCron函数每次执行都会调用databasesCron函数-这个函数会对服务器中的一部分数据库进行检查-删除其中的过期键-并在有需要的时候-对字典进行伸缩" class="headerlink" title="serverCron函数每次执行都会调用databasesCron函数,这个函数会对服务器中的一部分数据库进行检查,删除其中的过期键,并在有需要的时候,对字典进行伸缩."></a>serverCron函数每次执行都会调用databasesCron函数,这个函数会对服务器中的一部分数据库进行检查,删除其中的过期键,并在有需要的时候,对字典进行伸缩.</h4></li>
</ol>
<h4 id="14-2-8-执行被延迟的BGREWRITEAOF"><a href="#14-2-8-执行被延迟的BGREWRITEAOF" class="headerlink" title="14.2.8   执行被延迟的BGREWRITEAOF"></a>14.2.8   执行被延迟的BGREWRITEAOF</h4><h4 id="-1"><a href="#-1" class="headerlink" title=""></a><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805143838370.png" alt="image-20220805143838370"></h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805143846180.png" alt="image-20220805143846180"></p>
<h4 id="14-2-9-检查持久化操作的运行状态"><a href="#14-2-9-检查持久化操作的运行状态" class="headerlink" title="14.2.9      检查持久化操作的运行状态"></a>14.2.9      检查持久化操作的运行状态</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805205724248.png" alt="image-20220805205724248"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805205738675.png" alt="image-20220805205738675"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805211230573.png" alt="image-20220805211230573"></p>
<h4 id="14-2-10-将AOF缓冲区的内容写入AOF文件"><a href="#14-2-10-将AOF缓冲区的内容写入AOF文件" class="headerlink" title="14.2.10    将AOF缓冲区的内容写入AOF文件"></a>14.2.10    将AOF缓冲区的内容写入AOF文件</h4><ol>
<li><h4 id="如果服务器开启了AOF持久化功能-并且AOF缓冲区里面还有待写入数据-那么serverCron函数会调用相应的程序-将AOF缓冲区的内容写入到AOF文件里面"><a href="#如果服务器开启了AOF持久化功能-并且AOF缓冲区里面还有待写入数据-那么serverCron函数会调用相应的程序-将AOF缓冲区的内容写入到AOF文件里面" class="headerlink" title="如果服务器开启了AOF持久化功能,并且AOF缓冲区里面还有待写入数据,那么serverCron函数会调用相应的程序,将AOF缓冲区的内容写入到AOF文件里面,"></a>如果服务器开启了AOF持久化功能,并且AOF缓冲区里面还有待写入数据,那么serverCron函数会调用相应的程序,将AOF缓冲区的内容写入到AOF文件里面,</h4></li>
</ol>
<h4 id="14-2-11-关闭异步客户端"><a href="#14-2-11-关闭异步客户端" class="headerlink" title="14.2.11   关闭异步客户端."></a>14.2.11   关闭异步客户端.</h4><ol>
<li><h4 id="在这一步-服务器会关闭那些输出缓冲区大小超出限制的客户端"><a href="#在这一步-服务器会关闭那些输出缓冲区大小超出限制的客户端" class="headerlink" title="在这一步,服务器会关闭那些输出缓冲区大小超出限制的客户端,"></a>在这一步,服务器会关闭那些输出缓冲区大小超出限制的客户端,</h4></li>
</ol>
<h4 id="14-2-12-增加cronloops-计数器的值"><a href="#14-2-12-增加cronloops-计数器的值" class="headerlink" title="14.2.12    增加cronloops 计数器的值."></a>14.2.12    增加cronloops 计数器的值.</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805221007083.png"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220805221016935.png" alt="image-20220805221016935"></p>
<h3 id="14-3-初始化服务器"><a href="#14-3-初始化服务器" class="headerlink" title="14.3     初始化服务器"></a>14.3     初始化服务器</h3><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144006702.png" alt="image-20220806144006702"></p>
<h4 id="14-3-1-初始化服务器的状态结构"><a href="#14-3-1-初始化服务器的状态结构" class="headerlink" title="14.3.1  初始化服务器的状态结构"></a>14.3.1  初始化服务器的状态结构</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144031896.png" alt="image-20220806144031896"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144036894.png" alt="image-20220806144036894"></p>
<h4 id="14-3-2-载入配置选项"><a href="#14-3-2-载入配置选项" class="headerlink" title="14.3.2  载入配置选项"></a>14.3.2  载入配置选项</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144055348.png" alt="image-20220806144055348"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144150592.png" alt="image-20220806144150592"></p>
<h4 id="14-3-3-初始化服务器数据结构"><a href="#14-3-3-初始化服务器数据结构" class="headerlink" title="14.3.3  初始化服务器数据结构"></a>14.3.3  初始化服务器数据结构</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144247068.png"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144425958.png" alt="image-20220806144425958"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144433835.png" alt="image-20220806144433835"></p>
<h4 id="14-3-4-还原数据库状态"><a href="#14-3-4-还原数据库状态" class="headerlink" title="14.3.4  还原数据库状态"></a>14.3.4  还原数据库状态</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144503473.png" alt="image-20220806144503473"></p>
<p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144512270.png" alt="image-20220806144512270"></p>
<h4 id="14-3-5-执行事件循环"><a href="#14-3-5-执行事件循环" class="headerlink" title="14.3.5     执行事件循环"></a>14.3.5     执行事件循环</h4><p><img src="C:\Users\86189\AppData\Roaming\Typora\typora-user-images\image-20220806144701518.png" alt="image-20220806144701518"></p>
<h3 id="14-4-重点回顾"><a href="#14-4-重点回顾" class="headerlink" title="14.4     重点回顾"></a>14.4     重点回顾</h3><ol>
<li><h4 id="一个命令请求从发送到完成主要包括以下步骤：1-客户端将执行的命令请求发送给服务器。2。服务器读取命令请求，并分析出命令参数，3、命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复。4-服务器将命令回复返回给客户端"><a href="#一个命令请求从发送到完成主要包括以下步骤：1-客户端将执行的命令请求发送给服务器。2。服务器读取命令请求，并分析出命令参数，3、命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复。4-服务器将命令回复返回给客户端" class="headerlink" title="一个命令请求从发送到完成主要包括以下步骤：1.客户端将执行的命令请求发送给服务器。2。服务器读取命令请求，并分析出命令参数，3、命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复。4.服务器将命令回复返回给客户端"></a>一个命令请求从发送到完成主要包括以下步骤：1.客户端将执行的命令请求发送给服务器。2。服务器读取命令请求，并分析出命令参数，3、命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复。4.服务器将命令回复返回给客户端</h4></li>
<li><h4 id="serverCron函数默认每隔100ms执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的sigtrem信号，管理客户端资源和数据库状态，执行并检查持久化操作等。"><a href="#serverCron函数默认每隔100ms执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的sigtrem信号，管理客户端资源和数据库状态，执行并检查持久化操作等。" class="headerlink" title="serverCron函数默认每隔100ms执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的sigtrem信号，管理客户端资源和数据库状态，执行并检查持久化操作等。"></a>serverCron函数默认每隔100ms执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的sigtrem信号，管理客户端资源和数据库状态，执行并检查持久化操作等。</h4></li>
<li><h4 id="服务器从启动到能够处理客户端的命令请求需要执行以下步骤，1-初始化服务器状态，2-载入服务器配置，3-初始化服务器数据结构，4-还原数据库状态。5-执行事件循环。。"><a href="#服务器从启动到能够处理客户端的命令请求需要执行以下步骤，1-初始化服务器状态，2-载入服务器配置，3-初始化服务器数据结构，4-还原数据库状态。5-执行事件循环。。" class="headerlink" title="服务器从启动到能够处理客户端的命令请求需要执行以下步骤，1.初始化服务器状态，2.载入服务器配置，3.初始化服务器数据结构，4.还原数据库状态。5.执行事件循环。。"></a>服务器从启动到能够处理客户端的命令请求需要执行以下步骤，1.初始化服务器状态，2.载入服务器配置，3.初始化服务器数据结构，4.还原数据库状态。5.执行事件循环。。</h4></li>
</ol>
<h2 id="第三部分-多数据库的实现"><a href="#第三部分-多数据库的实现" class="headerlink" title="第三部分   多数据库的实现"></a>第三部分   多数据库的实现</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Ovesh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/10/15/Redis/">http://example.com/2022/10/15/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Ovesh's home</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="/image/suzy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/16/Redis%E9%9D%A2%E8%AF%95/"><img class="prev-cover" src="/image/suzy.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis面试</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/15/MySQL/"><img class="next-cover" src="/image/suzy.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/16/Redis%E9%9D%A2%E8%AF%95/" title="Redis面试"><img class="cover" src="/image/suzy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-16</div><div class="title">Redis面试</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Gitalk</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/background.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ovesh</div><div class="author-info__description">Let me be your cape~</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Oveshh"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Oveshh" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1057642402&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Welcome to Ovesh's Home</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.0.1.</span> <span class="toc-text">Redis设计与实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">第一部分  数据结构与对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-2-%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.2.</span> <span class="toc-text">Chapter 2    简单动态字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-0-redis-%E7%9A%84%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.0 redis 的简单动态字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDS%EF%BC%88simple-dynamic-string%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">SDS（simple dynamic string）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93Redis%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E5%8F%AF%E4%BB%A5%E8%A2%AB%E4%BF%AE%E6%94%B9%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%80%BC%E6%97%B6%EF%BC%8C%E5%B0%B1%E4%BC%9A%E4%BD%BF%E7%94%A8SDS%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%93%A6%E3%80%82"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">当Redis需要一个可以被修改的字符串值时，就会使用SDS来表示哦。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key-%E6%98%AFfruits-SDS-%EF%BC%8C-value-%E6%98%AF%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8D%B3%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B0%B4%E6%9E%9C%E3%80%82"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">key 是fruits  SDS  ， value 是列表对象，即上面的三种水果。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SDS%E8%BF%98%E8%A2%AB%E7%94%A8%E4%BD%9C%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%88buffer%EF%BC%89%EF%BC%9AAOF%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84-x3D-x3D-AOF%E7%BC%93%E5%86%B2%E5%8C%BA-x3D-x3D-%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E4%B8%AD%E7%9A%84-x3D-x3D-%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA-x3D-x3D-%EF%BC%8C%E9%83%BD%E6%98%AF%E7%94%B1SDS%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82-AOF%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E5%86%8D%E5%B1%95%E5%BC%80%E3%80%82"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">SDS还被用作缓冲区（buffer）：AOF模块中的&#x3D;&#x3D;AOF缓冲区&#x3D;&#x3D;，以及客户端状态中的&#x3D;&#x3D;输入缓冲区&#x3D;&#x3D;，都是由SDS实现的。  AOF持久化，客户端状态再展开。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-SDS-%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.1   SDS 的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%8F%E4%B8%AAsds-h-x2F-sdshadr-%E7%BB%93%E6%9E%84%E8%A1%A8%E7%A4%BA%E4%B8%80%E4%B8%AAsds%E5%80%BC%E3%80%82"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">每个sds.h&#x2F;sdshadr 结构表示一个sds值。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%93%88%E5%B8%8C%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.4.</span> <span class="toc-text">4.1.2   哈希表节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E5%AD%97%E5%85%B8"><span class="toc-number">1.2.5.</span> <span class="toc-text">4.1.3 字典</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E4%B8%AD%E7%9A%84%E5%AD%97%E5%85%B8%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">1.2.6.</span> <span class="toc-text">Redis 中的字典结构：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E7%8A%B6%E6%80%81%E4%B8%8B%E7%9A%84%E5%AD%97%E5%85%B8-%EF%BC%88%E6%B2%A1%E6%9C%89%E8%BF%9B%E8%A1%8Crehash%EF%BC%89"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">普通状态下的字典 （没有进行rehash）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95"><span class="toc-number">1.2.7.</span> <span class="toc-text">4.2  哈希算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%AD%97%E5%85%B8%E9%87%8C%E9%9D%A2%E6%97%B6%EF%BC%8C-x3D-x3D-%E7%A8%8B%E5%BA%8F%E9%9C%80%E8%A6%81%E5%85%88%E6%A0%B9%E6%8D%AE%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E5%BB%BA%E8%AE%A1%E7%AE%97%E5%87%BA%E5%93%88%E5%B8%8C%E5%80%BC%E5%92%8C%E7%B4%A2%E5%BC%95%E5%80%BC-x3D-x3D-%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E6%A0%B9%E6%8D%AE%E7%B4%A2%E5%BC%95%E5%80%BC%EF%BC%8C%E5%B0%86%E5%8C%85%E5%90%AB%E6%96%B0%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8%E8%8A%82%E7%82%B9%E6%94%BE%E5%88%B0%E5%93%88%E5%B8%8C%E8%A1%A8%E6%95%B0%E7%BB%84%E6%8C%87%E5%AE%9A%E7%9A%84%E7%B4%A2%E5%BC%95%E4%B8%8A%E9%9D%A2%E3%80%82"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">当需要一个新的键值对添加到字典里面时，&#x3D;&#x3D;程序需要先根据键值对的建计算出哈希值和索引值&#x3D;&#x3D;，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组指定的索引上面。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.8.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E5%AD%97%E5%85%B8%E8%A2%AB%E7%94%A8%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%8C%E6%88%96%E8%80%85%E5%93%88%E5%B8%8C%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E6%97%B6%EF%BC%8C-x3D-x3D-Redis%E4%BD%BF%E7%94%A8MurmurHash2%E7%AE%97%E6%B3%95%E6%9D%A5%E8%AE%A1%E7%AE%97%E9%94%AE%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC-x3D-x3D-%E3%80%82"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">当字典被用作数据库的底层实现，或者哈希键的底层实现时，&#x3D;&#x3D;Redis使用MurmurHash2算法来计算键的哈希值&#x3D;&#x3D;。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MurmurHash2%E7%AE%97%E6%B3%95%E8%AF%A6%E6%83%85%E7%99%BE%E5%BA%A6%E6%88%96google%E3%80%82"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">MurmurHash2算法详情百度或google。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%A7%A3%E5%86%B3%E9%94%AE%E5%86%B2%E7%AA%81"><span class="toc-number">1.2.9.</span> <span class="toc-text">4.3   解决键冲突</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x3D-x3D-%E5%BD%93%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%88%96%E4%BB%A5%E4%B8%8A%E6%95%B0%E9%87%8F%E7%9A%84%E9%94%AE%E8%A2%AB%E5%88%86%E9%85%8D%E5%88%B0%E4%BA%86%E5%93%88%E5%B8%8C%E8%A1%A8%E6%95%B0%E7%BB%84%E7%9A%84%E5%90%8C%E4%B8%80%E4%B8%AA%E7%B4%A2%E5%BC%95%E4%B8%8A%E9%9D%A2%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E7%A7%B0%E8%BF%99%E4%BA%9B%E9%94%AE%E5%8F%91%E7%94%9F%E4%BA%86%E5%86%B2%E7%AA%81%E3%80%82-x3D-x3D"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">&#x3D;&#x3D;当有两个或以上数量的键被分配到了哈希表数组的同一个索引上面时，我们称这些键发生了冲突。&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8-x3D-x3D-%E4%BD%BF%E7%94%A8%E9%93%BE%E5%9C%B0%E5%9D%80%E6%B3%95-x3D-x3D-%E6%9D%A5%E8%A7%A3%E5%86%B3%E9%94%AE%E5%86%B2%E7%AA%81%EF%BC%8C%E6%AF%8F%E4%B8%AA%E5%93%88%E5%B8%8C%E8%A1%A8%E8%8A%82%E7%82%B9%E9%83%BD%E6%B2%A1%E6%9C%89%E4%B8%80%E4%B8%AAnext%E6%8C%87%E9%92%88%EF%BC%8C%E5%A4%9A%E4%B8%AA%E5%93%88%E5%B8%8C%E8%A1%A8%E8%8A%82%E7%82%B9%E5%8F%AF%E4%BB%A5%E7%94%A8next%E6%8C%87%E9%92%88%E6%9E%84%E6%88%90%E4%B8%80%E4%B8%AA%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8%EF%BC%8C%E8%A2%AB%E5%88%86%E9%85%8D%E5%88%B0%E5%90%8C%E4%B8%80%E4%B8%AA%E7%B4%A2%E5%BC%95%E4%B8%8A%E7%9A%84%E5%A4%9A%E4%B8%AA%E8%8A%82%E7%82%B9%E5%8F%AF%E4%BB%A5%E7%94%A8%E8%BF%99%E4%B8%AA%E5%8D%95%E5%90%91%E9%93%BE%E8%A1%A8%E8%BF%9E%E6%8E%A5%E8%B5%B7%E6%9D%A5%EF%BC%8C%E8%BF%99%E5%B0%B1%E8%A7%A3%E5%86%B3%E4%BA%86%E9%94%AE%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98%E3%80%82"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">Redis的哈希表&#x3D;&#x3D;使用链地址法&#x3D;&#x3D;来解决键冲突，每个哈希表节点都没有一个next指针，多个哈希表节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.2.10.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-rehash"><span class="toc-number">1.2.11.</span> <span class="toc-text">4.4    rehash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%86%E8%AE%A9%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9B%A0%E5%AD%90%EF%BC%88load-factor%EF%BC%89%E7%BB%B4%E6%8C%81%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%90%88%E7%90%86%E7%9A%84%E8%8C%83%E5%9B%B4%E4%B9%8B%E5%86%85%EF%BC%8C%E5%BD%93%E5%93%88%E5%B8%8C%E8%A1%A8%E4%BF%9D%E5%AD%98%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%E6%95%B0%E9%87%8F%E5%A4%AA%E5%A4%9A%E6%88%96%E5%A4%AA%E5%B0%91%E6%97%B6%EF%BC%8C%E7%A8%8B%E5%BA%8F%E9%9C%80%E8%A6%81%E5%AF%B9%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%BF%9B%E8%A1%8C%E7%9B%B8%E5%BA%94%E7%9A%84%E6%89%A9%E5%B1%95%E5%92%8C%E6%94%B6%E7%BC%A9%E3%80%82"><span class="toc-number">1.2.11.1.</span> <span class="toc-text">为了让哈希表的负载因子（load factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展和收缩。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%92%8C%E6%94%B6%E7%BC%A9%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8F%AF%E4%BB%A5-x3D-x3D-%E9%80%9A%E8%BF%87rehash%EF%BC%88%E9%87%8D%E6%96%B0%E6%95%A3%E5%88%97%EF%BC%89%E6%93%8D%E4%BD%9C-x3D-x3D-%E6%9D%A5%E5%AE%8C%E6%88%90%EF%BC%8CRedis%E5%AF%B9%E5%AD%97%E5%85%B8%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8%E6%89%A7%E8%A1%8Crehash%E7%9A%84%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.2.11.2.</span> <span class="toc-text">扩展和收缩哈希表的工作可以&#x3D;&#x3D;通过rehash（重新散列）操作&#x3D;&#x3D;来完成，Redis对字典的哈希表执行rehash的步骤如下：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.2.11.3.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E6%89%A9%E5%B1%95%E4%B8%8E%E6%94%B6%E7%BC%A9"><span class="toc-number">1.2.12.</span> <span class="toc-text">哈希表的扩展与收缩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E4%BB%A5%E4%B8%8B%E6%9D%A1%E4%BB%B6%E4%B8%AD%E7%9A%84%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%A2%AB%E6%BB%A1%E8%B6%B3%E6%97%B6%EF%BC%8C%E7%A8%8B%E5%BA%8F%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%BC%80%E5%A7%8B%E5%AF%B9%E5%93%88%E5%B8%8C%E8%A1%A8%E6%89%A7%E8%A1%8C%E6%89%A9%E5%B1%95%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">1.2.12.1.</span> <span class="toc-text">当以下条件中的任意一个被满足时，程序会自动开始对哈希表执行扩展操作：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%AE%E5%89%8D%E6%B2%A1%E6%9C%89%E5%9C%A8%E6%89%A7%E8%A1%8CBGSAVE%E5%91%BD%E4%BB%A4%E6%88%96%E8%80%85BGREWRITEAOF%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9B%A0%E5%AD%90%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E1%E3%80%82"><span class="toc-number">1.2.12.2.</span> <span class="toc-text">服务器目前没有在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于1。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%AE%E5%89%8D%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8CBGSAVE%E5%91%BD%E4%BB%A4%E6%88%96%E8%80%85BGREWRITEAOF%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%93%88%E5%B8%8C%E8%A1%A8%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9B%A0%E5%AD%90%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E5%E3%80%82"><span class="toc-number">1.2.12.3.</span> <span class="toc-text">服务器目前正在执行BGSAVE命令或者BGREWRITEAOF命令，并且哈希表的负载因子大于等于5。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%8D%87%E7%BA%A7"><span class="toc-number">1.2.13.</span> <span class="toc-text">6.2 升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%8D%87%E7%BA%A7%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">1.2.14.</span> <span class="toc-text">6.3  升级的好处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E7%9A%84%E5%8D%87%E7%BA%A7%E7%AD%96%E7%95%A5%E6%9C%89%E4%B8%A4%E4%B8%AA%E7%AD%96%E7%95%A5%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%98%AF%E6%8F%90%E5%8D%87%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E7%9A%84%E7%81%B5%E6%B4%BB%E6%80%A7%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%98%AF%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%9C%B0%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98%E3%80%82"><span class="toc-number">1.2.15.</span> <span class="toc-text">整数集合的升级策略有两个策略，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-%E6%8F%90%E5%8D%87%E7%81%B5%E6%B4%BB%E6%80%A7"><span class="toc-number">1.2.15.1.</span> <span class="toc-text">6.3.1   提升灵活性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%A0%E4%B8%BAC%E8%AF%AD%E8%A8%80%E6%98%AF%E9%9D%99%E6%80%81%E8%AF%AD%E8%A8%80%EF%BC%8C%E4%B8%BA%E4%BA%86%E9%81%BF%E5%85%8D%E7%B1%BB%E5%9E%8B%E9%94%99%E8%AF%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E5%B8%B8%E4%B8%8D%E4%BC%9A%E5%B0%86%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%80%BC%E6%94%BE%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%87%8C%E9%9D%A2%E3%80%82"><span class="toc-number">1.2.15.2.</span> <span class="toc-text">因为C语言是静态语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98"><span class="toc-number">1.2.15.3.</span> <span class="toc-text">6.3.2   节约内存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%99%8D%E7%BA%A7"><span class="toc-number">1.2.16.</span> <span class="toc-text">6.4  降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88API"><span class="toc-number">1.2.17.</span> <span class="toc-text">6.5    整数集合API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.2.18.</span> <span class="toc-text">6.6    重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E6%98%AF%E9%9B%86%E5%90%88%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B9%8B%E4%B8%80"><span class="toc-number">1.2.18.1.</span> <span class="toc-text">整数集合是集合键的底层实现之一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%BA%E6%95%B0%E7%BB%84%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%95%B0%E7%BB%84%E4%BB%A5%E6%9C%89%E5%BA%8F%EF%BC%8C%E6%97%A0%E9%87%8D%E5%A4%8D%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BF%9D%E5%AD%98%E9%9B%86%E5%90%88%E5%85%83%E7%B4%A0%EF%BC%8C%E5%9C%A8%E6%9C%89%E9%9C%80%E8%A6%81%E6%97%B6%EF%BC%8C%E7%A8%8B%E5%BA%8F%E4%BC%9A%E6%A0%B9%E6%8D%AE%E6%96%B0%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%85%83%E7%B4%A0%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%8C%E6%94%B9%E5%8F%98%E8%BF%99%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.18.2.</span> <span class="toc-text">整数集合的底层实现为数组，这个数组以有序，无重复的方式保存集合元素，在有需要时，程序会根据新添加的元素的类型，改变这个数组的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E6%93%8D%E4%BD%9C%E4%B8%BA%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E5%B8%A6%E6%9D%A5%E4%BA%86%E6%93%8D%E4%BD%9C%E4%B8%8A%E7%9A%84%E7%81%B5%E6%B4%BB%E6%80%A7%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%9C%B0%E8%8A%82%E7%BA%A6%E4%BA%86%E5%86%85%E5%AD%98"><span class="toc-number">1.2.18.3.</span> <span class="toc-text">升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E5%8F%AA%E6%94%AF%E6%8C%81%E5%8D%87%E7%BA%A7%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%B8%8D%E6%94%AF%E6%8C%81%E9%99%8D%E7%BA%A7%E6%93%8D%E4%BD%9C%E3%80%82"><span class="toc-number">1.2.18.4.</span> <span class="toc-text">整数集合只支持升级操作，不支持降级操作。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-7-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">Chapter 7    压缩列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E6%98%AF%E5%88%97%E8%A1%A8%E9%94%AE%E5%92%8C%E5%93%88%E5%B8%8C%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B9%8B%E4%B8%80%E3%80%82%E5%BD%93%E4%B8%80%E4%B8%AA%E5%88%97%E6%A0%87%E9%94%AE%E5%8F%AA%E5%8C%85%E5%90%AB%E5%B0%91%E9%87%8F%E5%88%97%E8%A1%A8%E9%A1%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%AF%8F%E4%B8%AA%E5%88%97%E8%A1%A8%E9%A1%B9%E8%A6%81%E4%B9%88%E5%B0%B1%E6%98%AF%E6%9C%80%E5%B0%8F%E6%95%B4%E6%95%B0%E5%80%BC%EF%BC%8C%E8%A6%81%E4%B9%88%E5%B0%B1%E6%98%AF%E9%95%BF%E5%BA%A6%E6%AF%94%E8%BE%83%E7%9F%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E9%82%A3%E4%B9%88Redis%E5%B0%B1%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E6%9D%A5%E5%9D%90%E5%88%97%E6%A0%87%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E3%80%82"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">压缩列表是列表键和哈希键的底层实现之一。当一个列标键只包含少量列表项，并且每个列表项要么就是最小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来坐列标键的底层实现。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%BD%93%E4%B8%80%E4%B8%AA%E5%93%88%E5%B8%8C%E9%94%AE%E5%8F%AA%E5%8C%85%E5%90%AB%E5%B0%91%E9%87%8F%E9%94%AE%E5%80%BC%E5%AF%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%AF%8F%E4%B8%AA%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E9%94%AE%E5%92%8C%E5%80%BC%E8%A6%81%E4%B9%88%E5%B0%B1%E6%98%AF%E5%B0%8F%E6%95%B4%E6%95%B0%E5%80%BC%EF%BC%8C%E8%A6%81%E4%B9%88%E5%B0%B1%E6%98%AF%E9%95%BF%E5%BA%A6%E6%AF%94%E8%BE%83%E7%9F%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E9%82%A3%E4%B9%88Redis%E5%B0%B1%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%8E%8B%E7%BC%A9%E5%88%97%E6%A0%87%E6%9D%A5%E5%81%9A%E5%93%88%E5%B8%8C%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%8C"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">另外，当一个哈希键只包含少量键值对，并且每个键值对的键和值要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列标来做哈希键的底层实现，</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">7.1   压缩列表的构成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E6%98%AFRedis%E4%B8%BA%E4%BA%86%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98%E8%80%8C%E5%BC%80%E5%8F%91%E7%9A%84%EF%BC%8C%E6%98%AF%E7%94%B1%E4%B8%80%E7%B3%BB%E5%88%97%E7%89%B9%E6%AE%8A%E7%BC%96%E7%A0%81%E7%9A%84%E8%BF%9E%E7%BB%AD%E5%86%85%E5%AD%98%E7%BB%84%E6%88%90%E7%9A%84%E9%A1%BA%E5%BA%8F%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%82%E4%B8%80%E4%B8%AA%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E5%8F%AF%E4%BB%A5%E5%8C%85%E5%90%AB%E4%BB%BB%E6%84%8F%E5%A4%9A%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%88entry%EF%BC%89%EF%BC%8C%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E5%8F%AF%E4%BB%A5%E4%BF%9D%E5%AD%98%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E6%88%96%E8%80%85%E4%B8%80%E4%B8%AA%E6%95%B4%E6%95%B0%E5%80%BC%E3%80%82"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">压缩列表是Redis为了节约内存而开发的，是由一系列特殊编码的连续内存组成的顺序型数据结构。一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">1.3.2.</span> <span class="toc-text">7.2   压缩列表节点的构成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%8F%E4%B8%AA%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9%E5%8F%AF%E4%BB%A5%E4%BF%9D%E5%AD%98%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E6%88%96%E8%80%85%E4%B8%80%E4%B8%AA%E6%95%B4%E6%95%B0%E5%80%BC%EF%BC%8C%E5%85%B6%E4%B8%AD%EF%BC%8C%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E5%8F%AF%E4%BB%A5%E6%98%AF%E4%B8%80%E4%B8%8B%E4%B8%89%E7%A7%8D%E9%95%BF%E5%BA%A6%E7%9A%84%E5%85%B6%E4%B8%AD%E4%B8%80%E7%A7%8D%EF%BC%9A"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">每个压缩列表节点可以保存一个字节数组或者一个整数值，其中，字节数组可以是一下三种长度的其中一种：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-previous-entry-length"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">7.2.1    previous_entry_length</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E7%9A%84previous-entry-length-%E5%B1%9E%E6%80%A7%E4%BB%A5%E5%AD%97%E8%8A%82%E4%B8%BA%E5%8D%95%E4%BD%8D%EF%BC%8C%E8%AE%B0%E5%BD%95%E4%BA%86%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E4%B8%AD%E5%89%8D%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E9%95%BF%E5%BA%A6%E3%80%82"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">节点的previous_entry_length 属性以字节为单位，记录了压缩列表中前一个节点的长度。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-encoding"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">7.2.2  encoding</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-content"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">7.2.3  content</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">7.3   连锁更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8API"><span class="toc-number">1.3.4.</span> <span class="toc-text">7.4  压缩列表API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.3.5.</span> <span class="toc-text">7.5 重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E6%98%AF%E4%B8%80%E7%A7%8D%E4%B8%BA%E4%BA%86%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98%E8%80%8C%E5%BC%80%E5%8F%91%E7%9A%84%E9%A1%BA%E5%BA%8F%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">压缩列表是一种为了节约内存而开发的顺序型数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%A2%AB%E7%94%A8%E4%BD%9C%E5%88%97%E8%A1%A8%E9%94%AE%E5%92%8C%E5%93%88%E5%B8%8C%E9%94%AE%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B9%8B%E4%B8%80"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">压缩列表被用作列表键和哈希键的底层实现之一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E5%8F%AF%E4%BB%A5%E5%8C%85%E5%90%AB%E5%A4%9A%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E5%8F%AF%E4%BB%A5%E4%BF%9D%E5%AD%98%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%E6%95%B0%E7%BB%84%E6%88%96%E8%80%85%E6%95%B4%E6%95%B0%E5%80%BC"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E8%8A%82%E7%82%B9%E5%88%B0%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%EF%BC%8C%E6%88%96%E8%80%85%E4%BB%8E%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E4%B8%AD%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BD%86%E8%BF%99%E7%A7%8D%E6%93%8D%E4%BD%9C%E5%87%BA%E7%8E%B0%E7%9A%84%E5%87%A0%E7%8E%87%E5%B9%B6%E4%B8%8D%E9%AB%98%E3%80%82"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引起连锁更新操作，但这种操作出现的几率并不高。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-8-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.</span> <span class="toc-text">Chapter  8     对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E9%9D%A2%E4%BA%86%E8%A7%A3%E4%BA%86Redis%E7%94%A8%E5%88%B0%E7%9A%84%E6%89%80%E6%9C%89%E4%B8%BB%E8%A6%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E6%AF%94%E5%A6%82%E7%AE%80%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88SDS%EF%BC%89%EF%BC%8C%E5%8F%8C%E7%AB%AF%E9%93%BE%E8%A1%A8%EF%BC%8C%E5%AD%97%E5%85%B8%EF%BC%8C%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%EF%BC%8C%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88%E7%AD%89%E7%AD%89"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">前面了解了Redis用到的所有主要数据结构，比如简单字符串（SDS），双端链表，字典，压缩列表，整数集合等等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E5%AF%B9%E8%B1%A1%E7%B3%BB%E7%BB%9F%EF%BC%9A-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%93%88%E5%B8%8C%E5%AF%B9%E8%B1%A1%EF%BC%8C%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%92%8C%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1-%E4%BA%94%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">Redis对象系统： 字符串对象，列表对象，哈希对象，集合对象，和有序集合对象 五种不同类型的对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E5%9C%A8%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%89%8D%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%9D%A5%E5%88%A4%E6%96%AD%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E7%BB%99%E5%AE%9A%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%A5%BD%E5%A4%84%E5%B0%B1%E6%98%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%92%88%E5%AF%B9%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%BA%E5%AF%B9%E8%B1%A1%E8%AE%BE%E7%BD%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E4%BB%8E%E8%80%8C%E4%BC%98%E5%8C%96%E5%AF%B9%E8%B1%A1%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8%E6%95%88%E7%8E%87"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">Redis在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令，使用对象的另一个好处就是，我们可以针对不同的使用场景为对象设置不同的数据结构实现，从而优化对象在不同场景下的使用效率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E6%AC%A1%E4%B9%8B%E5%A4%96%EF%BC%8CRedis%E5%AF%B9%E8%B1%A1%E7%B3%BB%E7%BB%9F%E8%BF%98%E5%AE%9E%E7%8E%B0%E4%BA%86-x3D-x3D-%E5%9F%BA%E4%BA%8E%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%8A%80%E6%9C%AF%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%EF%BC%8C%E5%BD%93%E5%9C%BA%E6%99%AF%E4%B8%8D%E5%9C%A8%E4%BD%BF%E7%94%A8%E6%9F%90%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%89%80%E5%8D%A0%E6%9C%89%E7%9A%84%E5%86%85%E5%AD%98%E5%B0%B1%E4%BC%9A%E8%A2%AB%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E3%80%82"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">初次之外，Redis对象系统还实现了&#x3D;&#x3D;基于引用计数技术的内存回收机制，当场景不在使用某个对象时，这个对象所占有的内存就会被自动释放。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%A6%E5%A4%96Redis%E8%BF%98%E9%80%9A%E8%BF%87%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E4%BA%86%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB%E6%9C%BA%E5%88%B6%EF%BC%8C%E8%BF%99%E4%B8%80%E6%9C%BA%E5%88%B6%E5%8F%AF%E4%BB%A5%E5%9C%A8%E9%80%82%E5%BD%93%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%B8%8B%EF%BC%8C%E9%80%9A%E8%BF%87%E8%AE%A9%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%B1%E4%BA%AB%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E6%9D%A5%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98%E3%80%82"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">另外Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库共享同一个对象来节约内存。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%90%8ERedis%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%B8%A6%E6%9C%89%E8%AE%BF%E9%97%AE%E6%97%B6%E9%97%B4%E8%AE%B0%E5%BD%95%E4%BF%A1%E6%81%AF%EF%BC%8C%E8%AF%A5%E4%BF%A1%E6%81%AF%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%BA%8E%E8%AE%A1%E7%AE%97%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE%E7%9A%84%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%95%BF%EF%BC%8C%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E7%94%A8%E4%BA%86maxmemory%E5%8A%9F%E8%83%BD%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%95%BF%E8%BE%83%E5%A4%A7%E7%9A%84%E9%82%A3%E4%BA%9B%E9%94%AE%E5%8F%AF%E8%83%BD%E4%BC%9A%E4%BC%98%E5%85%88%E8%A2%AB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%A0%E9%99%A4%E3%80%82"><span class="toc-number">1.4.0.6.</span> <span class="toc-text">最后Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%BC%96%E7%A0%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">8.1  对象的类型与编码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%9D%A5%E8%A1%A8%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%EF%BC%8C%E5%BD%93%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%94%AE%E5%80%BC%E5%AF%B9%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E8%87%B3%E5%B0%91%E4%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%A4%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%94%A8%E4%BD%9C%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E9%94%AE%EF%BC%8Ckey%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%94%A8%E4%BD%9C%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E5%80%BC%EF%BC%8C%E5%80%BC%E5%AF%B9%E8%B1%A1%E3%80%82"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Redis 使用对象来表示数据库中的键值对，当在数据库中创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键，key对象，另一个对象用作键值对的值，值对象。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">8.1.1   类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-3"><span class="toc-number">1.4.2.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-%E7%BC%96%E7%A0%81%E5%92%8C%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">8.1.2   编码和底层实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84ptr-%E6%8C%87%E9%92%88%E6%8C%87%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E8%80%8C%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%94%B1%E5%AF%B9%E8%B1%A1%E7%9A%84encoding%E5%B1%9E%E6%80%A7%E5%86%B3%E5%AE%9A%E3%80%82"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">对象的ptr 指针指向对象的底层实现数据结构，而这些数据结构由对象的encoding属性决定。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%82"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.3.</span> <span class="toc-text">8.2  字符串对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BC%96%E7%A0%81%E5%8F%AF%E4%BB%A5%E6%98%AFint%EF%BC%8Craw%EF%BC%8C%E6%88%96%E8%80%85embstr"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">字符串对象的编码可以是int，raw，或者embstr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E4%BF%9D%E5%AD%98%E7%9A%84%E6%98%AF%E6%95%B4%E6%95%B0%E5%80%BC%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%99%E4%B8%AA%E6%95%B4%E6%95%B0%E5%80%BC%E5%8F%AF%E4%BB%A5%E7%94%A8long%E7%B1%BB%E5%9E%8B%E6%9D%A5%E8%A1%A8%E7%A4%BA%EF%BC%8C%E9%82%A3%E4%B9%88%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E4%BC%9A%E5%B0%86%E6%95%B4%E6%95%B0%E5%80%BC%E4%BF%9D%E5%AD%98%E5%9C%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84%E7%9A%84ptr%E5%B1%9E%E6%80%A7%E9%87%8C%E9%9D%A2%EF%BC%88%E5%B0%86void-%E6%8D%A2%E6%88%90long%EF%BC%89%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BC%96%E7%A0%81%E8%AE%BE%E7%BD%AE%E4%B8%BAint"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void * 换成long），并将字符串对象的编码设置为int</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%80%BC%E5%BE%97%E9%95%BF%E5%BA%A6%E5%A4%A7%E4%BA%8E32%E5%AD%97%E8%8A%82%EF%BC%8C%E7%BC%96%E7%A0%81%E5%B0%86%E4%BC%9A%E6%98%AFraw%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%B0%8F%E4%BA%8E%E7%AD%89%E4%BA%8E32%E5%AD%97%E8%8A%82%EF%BC%8C%E9%82%A3%E4%B9%88%E5%B0%86%E4%BC%9A%E4%BD%BF%E7%94%A8embstr%E7%BC%96%E7%A0%81%E6%9D%A5%E4%BF%9D%E5%AD%98%E8%BF%99%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%80%BC%E3%80%82"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">如果字符串值得长度大于32字节，编码将会是raw，如果小于等于32字节，那么将会使用embstr编码来保存这个字符串值。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-%E7%BC%96%E7%A0%81%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">8.2.1      编码的转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#int-%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E5%92%8Cembstr%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E5%9C%A8%E6%9D%A1%E4%BB%B6%E6%BB%A1%E8%B6%B3%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%BC%9A%E8%A2%AB%E8%BD%AC%E6%8D%A2%E4%B8%BAraw%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">int 编码的字符串对象和embstr编码的字符串对象在条件满足的情况下，会被转换为raw编码的字符串对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%82-1"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">8.2.2   字符串命令的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%A0%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%94%AE%E7%9A%84%E5%80%BC%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%89%80%E4%BB%A5%E7%94%A8%E4%BA%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%94%AE%E7%9A%84%E6%89%80%E6%9C%89%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.3.8.</span> <span class="toc-text">因为字符串键的值为字符串对象，所以用于字符串键的所有命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.4.</span> <span class="toc-text">8.3    列表对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BC%96%E7%A0%81%E5%8F%AF%E4%BB%A5%E6%98%AFziplist%E6%88%96%E8%80%85linkedlist"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">列表对象的编码可以是ziplist或者linkedlist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ziplist%E7%BC%96%E7%A0%81%E7%9A%84%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%E4%BD%BF%E7%94%A8-x3D-x3D-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E4%BD%9C%E4%B8%BA%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0-x3D-x3D-%EF%BC%8C%E6%AF%8F%E4%B8%AA%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9%E4%BF%9D%E5%AD%98%E4%BA%86%E4%B8%80%E4%B8%AA%E5%88%97%E8%A1%A8%E5%85%83%E7%B4%A0%EF%BC%8C%E3%80%82%E3%80%81"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">ziplist编码的列表对象使用&#x3D;&#x3D;压缩列表作为底层实现&#x3D;&#x3D;，每个压缩列表节点保存了一个列表元素，。、</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-1-%E7%BC%96%E7%A0%81%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">8.5.1     编码的转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E6%BB%A1%E8%B6%B3%E4%BB%A5%E4%B8%8B%E4%B8%A4%E4%B8%AA%E6%9D%A1%E4%BB%B6%E6%97%B6%EF%BC%8C%E5%AF%B9%E8%B1%A1%E4%BD%BF%E7%94%A8intset%E7%BC%96%E7%A0%81%EF%BC%9A"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">当集合对象可以同时满足以下两个条件时，对象使用intset编码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1%E4%BF%9D%E5%AD%98%E7%9A%84%E6%89%80%E6%9C%89%E5%85%83%E7%B4%A0%E9%83%BD%E6%98%AF%E6%95%B4%E6%95%B0%E5%80%BC"><span class="toc-number">1.4.4.5.</span> <span class="toc-text">集合对象保存的所有元素都是整数值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1%E4%BF%9D%E5%AD%98%E7%9A%84%E5%85%83%E7%B4%A0%E4%B8%8D%E8%B6%85%E8%BF%87512%E4%B8%AA%E3%80%82"><span class="toc-number">1.4.4.6.</span> <span class="toc-text">集合对象保存的元素不超过512个。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E6%BB%A1%E8%B6%B3%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%9D%A1%E4%BB%B6%E7%9A%84%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8hashtable%E7%BC%96%E7%A0%81"><span class="toc-number">1.4.4.7.</span> <span class="toc-text">不能满足这两个条件的集合对象需要使用hashtable编码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.5.</span> <span class="toc-text">8.6    有序集合对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%E4%B8%8E%E5%91%BD%E4%BB%A4%E5%A4%9A%E6%80%81"><span class="toc-number">1.4.6.</span> <span class="toc-text">8.7        类型检查与命令多态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E4%B8%AD%E7%94%A8%E4%BA%8E%E6%93%8D%E4%BD%9C%E9%94%AE%E7%9A%84%E5%91%BD%E4%BB%A4%E5%9F%BA%E6%9C%AC%E4%B8%8A%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">Redis 中用于操作键的命令基本上可以分为两种类型:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%B8%AD%E4%B8%80%E7%A7%8D%E5%91%BD%E4%BB%A4%E5%8F%AF%E4%BB%A5%E5%AF%B9%E4%BB%BB%E4%BD%95%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%94%AE%E6%89%A7%E8%A1%8C-x3D-x3D-%E6%AF%94%E5%A6%82%E8%AF%B4-DEL%E5%91%BD%E4%BB%A4-EXPIRE%E5%91%BD%E4%BB%A4-rename%E5%91%BD%E4%BB%A4-type%E5%91%BD%E4%BB%A4-object-%E5%91%BD%E4%BB%A4%E3%80%82"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">其中一种命令可以对任何类型的键执行:  &#x3D;&#x3D;比如说 DEL命令,EXPIRE命令,rename命令,type命令,object 命令。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FOR-example"><span class="toc-number">1.4.6.3.</span> <span class="toc-text">FOR example</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-7-1-%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.6.4.</span> <span class="toc-text">8.7.1   类型检查的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%89%A7%E8%A1%8C%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%9E%8B%E7%89%B9%E5%AE%9A%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%89%8D%EF%BC%8CRedis-%E4%BC%9A%E5%85%88-%E6%A3%80%E6%9F%A5%E6%8F%92%E5%85%A5%E9%94%AE%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E5%86%B3%E5%AE%9A%E6%98%AF%E5%90%A6%E6%89%A7%E8%A1%8C%E7%BB%99%E5%AE%9A%E7%9A%84%E5%91%BD%E4%BB%A4%E3%80%82"><span class="toc-number">1.4.6.5.</span> <span class="toc-text">在执行一个类型特定命令之前，Redis 会先 检查插入键的类型是否正确，然后再决定是否执行给定的命令。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E7%89%B9%E5%AE%9A%E5%91%BD%E4%BB%A4%E6%89%80%E8%BF%9B%E8%A1%8C%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%E6%98%AF%E9%80%9A%E8%BF%87redisObject-%E7%BB%93%E6%9E%84%E7%9A%84type%E5%AE%9E%E8%A1%8C%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9A"><span class="toc-number">1.4.6.6.</span> <span class="toc-text">类型特定命令所进行的类型检查是通过redisObject 结构的type实行来实现的：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.4.6.7.</span> <span class="toc-text">.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-7-2-%E5%A4%9A%E6%80%81%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.6.8.</span> <span class="toc-text">8.7.2     多态命令的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E9%99%A4%E4%BA%86%E4%BC%9A%E6%A0%B9%E6%8D%AE%E5%AF%B9%E5%83%8F%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%9D%A5%E5%88%A4%E6%96%AD%E9%94%AE%E6%98%AF%E5%90%A6%E8%83%BD%E5%A4%9F%E6%89%A7%E8%A1%8C%E6%8C%87%E5%AE%9A%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E4%BC%9A%E6%A0%B9%E6%8D%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%EF%BC%8C%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%9D%A5%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E3%80%82"><span class="toc-number">1.4.6.9.</span> <span class="toc-text">Redis 除了会根据对像的类型来判断键是否能够执行指定命令之外，还会根据对象的编码方式，选择正确的命令实现代码来执行命令。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6"><span class="toc-number">1.4.7.</span> <span class="toc-text">8.8     内存回收</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%A0%E4%B8%BAC%E8%AF%AD%E8%A8%80%E5%B9%B6%E4%B8%8D%E5%85%B7%E5%A4%87%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%8A%9F%E8%83%BD%EF%BC%8C%E6%89%80%E4%BB%A5-x3D-x3D-Redis-%E5%9C%A8%E8%87%AA%E5%B7%B1%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E6%9E%84%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E8%AE%A1%E6%95%B0%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6-x3D-x3D-%EF%BC%8C%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%80%E6%9C%BA%E5%88%B6%EF%BC%8C%E7%A8%8B%E5%BA%8F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%B7%9F%E8%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8%E6%8A%80%E6%9C%AF%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%9C%A8%E9%80%82%E5%BD%93%E7%9A%84%E6%97%B6%E5%80%99%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E3%80%82"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">因为C语言并不具备自动内存回收功能，所以&#x3D;&#x3D;Redis 在自己的对象系统中构建了一个计数技术实现的内存回收机制&#x3D;&#x3D;，通过这一机制，程序可以通过跟踪对象的引用技术信息，在适当的时候自动释放对象，并进行内存回收。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB"><span class="toc-number">1.4.8.</span> <span class="toc-text">8.9    对象共享</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%A4%E4%BA%86%E7%94%A8%E4%BA%8E%E5%AE%9E%E7%8E%B0%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E4%B9%8B%E5%A4%96%EF%BC%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%B1%9E%E6%80%A7%E8%BF%98%E5%B8%A6%E6%9C%89%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB%E7%9A%84%E4%BD%9C%E7%94%A8%E3%80%82"><span class="toc-number">1.4.8.1.</span> <span class="toc-text">除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用。</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E5%A6%82%EF%BC%8C%E5%81%87%E8%AE%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E4%B8%AD%E4%BF%9D%E5%AD%98%E4%BA%86%E6%95%B4%E6%95%B0%E5%80%BC100%E7%9A%84%E9%94%AE%E4%B8%8D%E5%8F%AA%E6%98%AF%E9%94%AEA%E5%92%8C%E9%94%AEB%E4%B8%A4%E4%B8%AA%EF%BC%8C%E8%80%8C%E6%98%AF100%E4%B8%AA%EF%BC%8C%E9%82%A3%E4%B9%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%AA%E9%9C%80%E8%A6%81%E7%94%A8%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BF%9D%E5%AD%98%E5%8E%9F%E6%9C%AC%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E4%B8%80%E7%99%BE%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E6%89%8D%E8%83%BD%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.8.1.1.</span> <span class="toc-text">例如，假设数据库中中保存了整数值100的键不只是键A和键B两个，而是100个，那么服务器只需要用一个字符串对象的内存就可以保存原本需要使用一百个字符串对象的内存才能保存数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E6%9D%A5%E8%AF%B4-Redis%E4%BC%9A%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%B6-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%87%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1-%E8%BF%99%E4%BA%9B%E5%AF%B9%E8%B1%A1%E5%8C%85%E5%90%AB%E4%BA%86%E9%BB%98%E8%AE%A4%E4%BB%8E0-9999-%E7%9A%84%E6%89%80%E6%9C%89%E6%95%B4%E6%95%B0%E5%80%BC-%E5%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E5%80%BC%E4%B8%BA-0-9999-%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E6%97%B6-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%B1%E4%BC%9A%E4%BD%BF%E7%94%A8%E8%BF%99%E4%BA%9B%E5%85%B1%E4%BA%AB%E5%AF%B9%E8%B1%A1-%E8%80%8C%E4%B8%8D%E6%98%AF%E6%96%B0%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.8.1.2.</span> <span class="toc-text">目前来说,Redis会在初始化服务器时,创建一万个字符串对象,这些对象包含了默认从0-9999 的所有整数值,当服务器需要用到值为 0 -9999 的字符串对象时,服务器就会使用这些共享对象, 而不是新创建对象.</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-10-%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%95%BF"><span class="toc-number">1.4.9.</span> <span class="toc-text">8.10     对象的空转时长</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-11-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.4.10.</span> <span class="toc-text">8.11  重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%AA%E9%94%AE%E5%80%BC%E5%AF%B9%E7%9A%84%E9%94%AE%E5%92%8C%E5%80%BC%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.10.1.</span> <span class="toc-text">Redis数据库中的每个键值对的键和值都是一个对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E5%85%B1%E6%9C%89%E5%AD%97%E7%AC%A6%E4%B8%B2-%E5%88%97%E8%A1%A8-%E5%93%88%E5%B8%8C-%E9%9B%86%E5%90%88-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E4%BA%94%E7%A7%8D%E7%B1%BB%E5%9E%8B%E5%AF%B9%E8%B1%A1-%E6%AF%8F%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AF%B9%E8%B1%A1%E8%87%B3%E5%B0%91%E9%83%BD%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%88%96%E4%BB%A5%E4%B8%8A%E7%9A%84%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F-%E4%B8%8D%E5%90%8C%E7%9A%84%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E4%B8%8A%E4%BC%98%E5%8C%96%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BD%BF%E7%94%A8%E6%95%88%E7%8E%87"><span class="toc-number">1.4.10.2.</span> <span class="toc-text">Redis共有字符串,列表,哈希,集合,有序集合五种类型对象,每种类型的对象至少都有两种或以上的编码方式,不同的编码方式可以在不同的使用场景上优化对象的使用效率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E6%89%A7%E8%A1%8C%E6%9F%90%E4%BA%9B%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%89%8D-%E4%BC%9A%E5%85%88%E6%A3%80%E6%9F%A5%E7%BB%99%E5%AE%9A%E9%94%AE%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%83%BD%E5%90%A6%E6%89%A7%E8%A1%8C%E6%8C%87%E5%AE%9A%E7%9A%84%E5%91%BD%E4%BB%A4-%E8%80%8C%E6%A3%80%E6%9F%A5%E4%B8%80%E4%B8%AA%E9%94%AE%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%B0%B1%E6%98%AF%E6%A3%80%E6%9F%A5%E9%94%AE%E7%9A%84%E5%80%BC%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.10.3.</span> <span class="toc-text">服务器在执行某些命令之前,会先检查给定键的类型能否执行指定的命令,而检查一个键的类型就是检查键的值对象类型.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%9A%84%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%B8%A6%E6%9C%89%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6-%E5%BD%93%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E4%B8%8D%E5%86%8D%E8%A2%AB%E4%BD%BF%E7%94%A8%E6%97%B6-%E8%AF%A5%E5%AF%B9%E8%B1%A1%E6%89%80%E5%8D%A0%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98%E5%B0%B1%E4%BC%9A%E8%A2%AB%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE"><span class="toc-number">1.4.10.4.</span> <span class="toc-text">Redis的的对象带有引用计数实现的内存回收机制,当一个对象不再被使用时,该对象所占用的内存就会被自动释放.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E4%BC%9A%E5%85%B1%E4%BA%AB%E5%80%BC-%E4%B8%BA-0-9999-%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.10.5.</span> <span class="toc-text">Redis 会共享值 为 0-9999 的字符串对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BC%9A%E8%AE%B0%E5%BD%95%E8%87%AA%E5%B7%B1%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E6%AC%A1%E8%A2%AB%E8%AE%BF%E9%97%AE%E7%9A%84%E6%97%B6%E9%97%B4-%E8%BF%99%E4%B8%AA%E6%97%B6%E9%97%B4%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%BA%8E%E8%AE%A1%E7%AE%97%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%97%B4"><span class="toc-number">1.4.10.6.</span> <span class="toc-text">对象会记录自己的最后一次被访问的时间,这个时间可以用于计算对象的空转时间.</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">第二部分   单机数据库的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-9-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.6.</span> <span class="toc-text">Chapter  9    数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.6.1.</span> <span class="toc-text">9.1 服务器中的数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%BD%E4%BF%9D%E5%AD%98%E5%86%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81-redis-h-x2F-redisServer-%E7%BB%93%E6%9E%84%E7%9A%84db%E6%95%B0%E7%BB%84%E4%B8%AD-db%E6%95%B0%E7%BB%84%E7%9A%84%E6%AF%8F%E4%B8%AA%E9%A1%B9%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AAredis-h-x2F-redisDb%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">Redis 服务器将所有数据库都保存再服务器状态 redis.h&#x2F;redisServer 结构的db数组中,db数组的每个项都是一个redis.h&#x2F;redisDb结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.6.2.</span> <span class="toc-text">9.2   切换数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%8F%E4%B8%AARedis%E5%AE%A2%E6%88%B7%E7%AB%AF-%E9%83%BD%E6%9C%89%E8%87%AA%E5%B7%B1%E7%9A%84%E7%9B%AE%E6%A0%87%E6%95%B0%E6%8D%AE%E5%BA%93-%E6%AF%8F%E5%BD%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%A7%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%99%E5%91%BD%E4%BB%A4%E6%88%96%E8%80%85%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BB%E5%91%BD%E4%BB%A4%E7%9A%84%E6%97%B6%E5%80%99-%E7%9B%AE%E6%A0%87%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B0%B1%E4%BC%9A%E6%88%90%E4%B8%BA%E8%BF%99%E4%BA%9B%E5%91%BD%E4%BB%A4%E7%9A%84%E6%93%8D%E4%BD%9C%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">每个Redis客户端 都有自己的目标数据库,每当客户端执行数据库写命令或者数据库读命令的时候,目标数据库就会成为这些命令的操作对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B-Redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%9B%AE%E6%A0%87%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BA0%E5%8F%B7%E6%95%B0%E6%8D%AE%E5%BA%93-%E4%BD%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87select-%E5%91%BD%E4%BB%A4%E6%9D%A5%E5%88%87%E6%8D%A2%E7%9B%AE%E6%A0%87%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">默认情况下,Redis客户端的目标数据库为0号数据库,但客户端可以通过select  命令来切换目标数据库.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%A8%E6%85%8E%E5%A4%84%E7%90%86%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">谨慎处理多数据库程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE%E7%A9%BA%E9%97%B4"><span class="toc-number">1.6.3.</span> <span class="toc-text">9.3  数据库键空间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E6%98%AF%E4%B8%80%E4%B8%AA%E9%94%AE%E5%80%BC%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%BD%E7%94%B1%E4%B8%80%E5%93%A5redis-h-x2F-redisDb-%E7%BB%93%E6%9E%84%E8%A1%A8%E7%A4%BA"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">Redis 是一个键值对数据库服务器,服务器中的每个数据库都由一哥redis.h&#x2F;redisDb 结构表示,</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-1-%E6%B7%BB%E5%8A%A0%E6%96%B0%E9%94%AE"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">9.3.1   添加新键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E9%94%AE%E5%80%BC%E5%AF%B9%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E5%B0%86%E4%B8%80%E4%B8%AA%E6%96%B0%E9%94%AE%E5%80%BC%E5%AF%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%94%AE%E7%A9%BA%E9%97%B4%E5%AD%97%E5%85%B8%E9%87%8C%E9%9D%A2%EF%BC%8C%E5%85%B6%E4%B8%AD%E9%94%AE%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%80%8C%E5%80%BC%E5%88%99%E4%B8%BA%E4%BA%BA%E4%BB%A5%E4%B8%80%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84Redis%E5%AF%B9%E8%B1%A1%E3%80%82"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">添加一个新键值对到数据库，实际上就是将一个新键值对添加到键空间字典里面，其中键为字符串对象，而值则为人以一种类型的Redis对象。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-2-%E5%88%A0%E9%99%A4%E9%94%AE"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">9.3.2  删除键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E9%94%AE%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E5%9C%A8%E9%94%AE%E7%A9%BA%E9%97%B4%E9%87%8C%E9%9D%A2%E5%88%A0%E9%99%A4%E9%94%AE%E5%AF%B9%E5%BA%94%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%E5%AF%B9%E8%B1%A1%E3%80%81"><span class="toc-number">1.6.3.5.</span> <span class="toc-text">删除数据库中的一个键，实际上就是在键空间里面删除键对应的键值对对象、</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-4-%E5%AF%B9%E9%94%AE%E5%8F%96%E5%80%BC"><span class="toc-number">1.6.3.6.</span> <span class="toc-text">9.3.4     对键取值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E5%8F%96%E5%80%BC%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E5%9C%A8%E9%94%AE%E7%A9%BA%E9%97%B4%E4%B8%AD%E5%8F%96%E5%87%BA%E9%94%AE%E6%89%80%E5%AF%B9%E5%BA%94%E7%9A%84%E5%80%BC%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%80%BC%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%85%B7%E4%BD%93%E7%9A%84%E5%8F%96%E5%80%BC%E6%96%B9%E6%B3%95%E4%B9%9F%E4%BC%9A%E6%9C%89%E6%89%80%E4%B8%8D%E5%90%8C%E3%80%82"><span class="toc-number">1.6.3.7.</span> <span class="toc-text">对一个数据库进行取值，实际上就是在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LRANGE-%E5%91%BD%E4%BB%A4%E5%B0%86%E9%A6%96%E5%85%88%E5%9C%A8%E9%94%AE%E7%A9%BA%E9%97%B4%E4%B8%AD%E6%9F%A5%E6%89%BEalphabet%EF%BC%8C%E6%89%BE%E5%88%B0%E9%94%AE%E4%B9%8B%E5%90%8E%E6%8E%A5%E7%9D%80%E5%8F%96%E5%BE%97%E8%AF%A5%E9%94%AE%E6%89%80%E5%AF%B9%E5%BA%94%E7%9A%84%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%E5%80%BC%EF%BC%8C%E4%B9%8B%E5%90%8E%E5%86%8D%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%89%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%80%BC%E3%80%82"><span class="toc-number">1.6.3.8.</span> <span class="toc-text">LRANGE 命令将首先在键空间中查找alphabet，找到键之后接着取得该键所对应的列表对象值，之后再返回列表对象中包含的三个字符串对象的值。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-5-%E5%85%B6%E4%BB%96%E9%94%AE%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.3.9.</span> <span class="toc-text">9.3.5    其他键空间操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-6-%E8%AF%BB%E5%86%99%E9%94%AE%E7%A9%BA%E9%97%B4%E6%97%B6%E7%9A%84%E7%BB%B4%E6%8A%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">1.6.3.10.</span> <span class="toc-text">9.3.6    读写键空间时的维护操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E8%AE%BE%E7%BD%AE%E9%94%AE%E7%9A%84%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4%E6%88%96%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">1.6.4.</span> <span class="toc-text">9.4   设置键的生存时间或过期时间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87expire%E5%91%BD%E4%BB%A4%E6%88%96pexpire%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%AF%E4%BB%A5%E4%BB%A5%E7%A7%92%E6%88%96%E8%80%85%E6%AF%AB%E7%A7%92%E7%B2%BE%E5%BA%A6%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%9F%90%E4%B8%AA%E9%94%AE%E8%AE%BE%E7%BD%AE%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4%EF%BC%8C%E5%9C%A8%E7%BB%8F%E8%BF%87%E6%8C%87%E5%AE%9A%E7%9A%84%E7%A7%92%E6%95%B0%E6%88%96%E8%80%85%E6%AF%AB%E7%A7%92%E6%95%B0%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4%E4%B8%BA0%E7%9A%84%E9%94%AE%E3%80%82"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">通过expire命令或pexpire命令，客户端可以以秒或者毫秒精度为数据库中的某个键设置生存时间，在经过指定的秒数或者毫秒数之后，服务器就会自动删除生存时间为0的键。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-4-4-%E8%AE%A1%E7%AE%97%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%89%A9%E4%BD%99%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">9.4.4      计算并返回剩余生存时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TTL%E5%91%BD%E4%BB%A4%E4%BB%A5%E7%A7%92%E4%B8%BA%E5%8D%95%E4%BD%8D%E8%BF%94%E5%9B%9E%E9%94%AE%E7%9A%84%E5%89%A9%E4%BD%99%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4%EF%BC%8C%E8%80%8CPTTL%E5%91%BD%E4%BB%A4%E5%88%99%E4%BB%A5%E6%AF%AB%E7%A7%92%E4%B8%BA%E5%8D%95%E4%BD%8D%E8%BF%94%E5%9B%9E%E9%94%AE%E7%9A%84%E5%89%A9%E4%BD%99%E7%94%9F%E5%AD%98%E6%97%B6%E9%97%B4%E3%80%82"><span class="toc-number">1.6.4.3.</span> <span class="toc-text">TTL命令以秒为单位返回键的剩余生存时间，而PTTL命令则以毫秒为单位返回键的剩余生存时间。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-4-5-%E5%85%B3%E4%BA%8E%E5%88%86%E6%9E%90-RDB%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="toc-number">1.6.4.4.</span> <span class="toc-text">10.4.5   关于分析  RDB文件的说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.6.5.</span> <span class="toc-text">10.5  重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E4%BF%9D%E5%AD%98%E5%92%8C%E8%BF%98%E5%8E%9Fredis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%80%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E9%94%AE%E5%80%BC%E5%AF%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">RDB文件用于保存和还原redis服务器所有的数据库中的所有键值对数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save%E5%91%BD%E4%BB%A4%E7%94%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%E4%BF%9D%E5%AD%98%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%89%80%E4%BB%A5%E8%AF%A5%E5%91%BD%E4%BB%A4%E4%BC%9A%E9%98%BB%E5%A1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">save命令由服务器进程直接执行保存操作，所以该命令会阻塞服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BGSAVE%E5%91%BD%E4%BB%A4%E7%94%B1%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%BF%9D%E5%AD%98%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%89%80%E4%BB%A5%E8%AF%A5%E5%91%BD%E4%BB%A4%E4%B8%8D%E4%BC%9A%E9%98%BB%E5%A1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E4%B8%AD%E4%BC%9A%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89save%E9%80%89%E9%A1%B9%E8%AE%BE%E7%BD%AE%E7%9A%84%E4%BF%9D%E5%AD%98%E6%9D%A1%E4%BB%B6%EF%BC%8C%E5%BD%93%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E4%BF%9D%E5%AD%98%E6%9D%A1%E4%BB%B6%E8%A2%AB%E6%BB%A1%E8%B6%B3%E6%97%B6%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%89%A7%E8%A1%8CBGSAVE%E5%91%BD%E4%BB%A4"><span class="toc-number">1.6.5.4.</span> <span class="toc-text">服务器状态中会保存所有save选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB%E6%96%87%E4%BB%B6%E6%98%AF%E4%B8%80%E4%B8%AA%E7%BB%8F%E8%BF%87%E5%8E%8B%E7%BC%A9%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%EF%BC%8C%E7%94%B1%E5%A4%9A%E4%B8%AA%E9%83%A8%E5%88%86%E7%BB%84%E6%88%90"><span class="toc-number">1.6.5.5.</span> <span class="toc-text">RDB文件是一个经过压缩的二进制文件，由多个部分组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%EF%BC%8CRDB%E6%96%87%E4%BB%B6%E4%BC%9A%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E4%BF%9D%E5%AD%98%E4%BB%96%E4%BB%AC%E3%80%82"><span class="toc-number">1.6.5.6.</span> <span class="toc-text">对于不同类型的键值对，RDB文件会使用不同的方式来保存他们。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-11-AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">Chapter 11    AOF持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%A4%E4%BA%86RDB%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%E4%B9%8B%E5%A4%96%EF%BC%8CRedis%E8%BF%98%E6%8F%90%E4%BE%9B%E4%BA%86AOF%EF%BC%88append-only-file%EF%BC%89%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%EF%BC%8C-x3D-x3D-%E4%B8%8ERDB%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%E9%80%9A%E8%BF%87%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%E6%9D%A5%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E4%B8%8D%E5%90%8C%EF%BC%8CAOF%E6%8C%81%E4%B9%85%E5%8C%96%E9%80%9A%E8%BF%87%E4%BF%9D%E5%AD%98redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%80%E6%89%A7%E8%A1%8C%E7%9A%84%E5%86%99%E5%91%BD%E4%BB%A4%E6%9D%A5%E8%AE%B0%E5%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81-x3D-x3D-%E3%80%82"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">除了RDB持久化功能之外，Redis还提供了AOF（append only file）持久化功能，&#x3D;&#x3D;与RDB持久化功能通过保存数据库中的键值对来记录数据库状态不同，AOF持久化通过保存redis服务器所执行的写命令来记录数据库状态&#x3D;&#x3D;。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E7%9A%84%E6%96%B9%E6%B3%95%E6%98%AF%E5%B0%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9A%84-set-%EF%BC%8Csadd%EF%BC%8Crpush-%E4%B8%89%E4%B8%AA%E5%91%BD%E4%BB%A4%E4%BF%9D%E5%AD%98%E5%88%B0AOF%E6%96%87%E4%BB%B6%E4%B8%AD%E3%80%82"><span class="toc-number">1.7.0.2.</span> <span class="toc-text">AOF持久化保存数据库状态的方法是将服务器执行的 set ，sadd，rpush 三个命令保存到AOF文件中。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%BD%BD%E5%85%A5%E5%92%8C%E6%89%A7%E8%A1%8CAOF%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%91%BD%E4%BB%A4%E6%9D%A5%E8%BF%98%E5%8E%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%97%AD%E4%B9%8B%E5%89%8D%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E3%80%82%E4%BB%A5%E4%B8%8B%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BD%BD%E5%85%A5AOF%E6%96%87%E4%BB%B6%E5%B9%B6%E8%BF%98%E5%8E%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E6%97%B6%E6%89%93%E5%8D%B0%E7%9A%84%E6%97%A5%E5%BF%97%E3%80%82"><span class="toc-number">1.7.0.3.</span> <span class="toc-text">服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。以下是服务器载入AOF文件并还原数据库状态时打印的日志。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-AOF-%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.1.</span> <span class="toc-text">11.1    AOF 持久化的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0-x3D-x3D-%E5%8F%AF%E4%BB%A5%E8%BF%BD%E5%8A%A0-append-%EF%BC%8C%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%EF%BC%8C%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%EF%BC%8C-x3D-x3D-%E4%B8%89%E4%B8%AA%E6%AD%A5%E9%AA%A4%E3%80%82"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">AOF持久化功能的实现&#x3D;&#x3D;可以追加 append  ，文件写入，文件同步，&#x3D;&#x3D;三个步骤。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-1-%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">11.1.1  命令追加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93AOF-%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%E6%89%93%E5%BC%80%E6%97%B6%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E4%B8%80%E4%B8%AA%E5%86%99%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BC%9A%E4%BB%A5%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%E5%B0%86%E8%A2%AB%E6%89%A7%E8%A1%8C%E7%9A%84%E5%86%99%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E7%9A%84-aof-buf-%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%9C%AB%E5%B0%BE%E3%80%82"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">当AOF 持久化功能打开时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的 aof_buf 缓冲区的末尾。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-2-AOF%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E4%B8%8E%E5%90%8C%E6%AD%A5"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">11.1.2   AOF文件的写入与同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%9A%84-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E8%B4%9F%E8%B4%A3%E6%8E%A5%E6%94%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E3%80%82%E8%80%8C%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%88%99%E8%B4%9F%E8%B4%A3%E6%89%A7%E8%A1%8C%E5%83%8FserverCron%E5%87%BD%E6%95%B0%E8%BF%99%E6%A0%B7%E9%9C%80%E8%A6%81%E5%AE%9A%E6%97%B6%E8%BF%90%E8%A1%8C%E7%9A%84%E5%87%BD%E6%95%B0%E3%80%82"><span class="toc-number">1.7.1.5.</span> <span class="toc-text">Redis的 服务器进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。而时间事件则负责执行像serverCron函数这样需要定时运行的函数。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-AOF%E6%96%87%E4%BB%B6%E7%9A%84%E8%BD%BD%E5%85%A5%E4%B8%8E%E6%95%B0%E6%8D%AE%E8%BF%98%E5%8E%9F"><span class="toc-number">1.7.2.</span> <span class="toc-text">11.2    AOF文件的载入与数据还原</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-AOF%E9%87%8D%E5%86%99"><span class="toc-number">1.7.3.</span> <span class="toc-text">11.3  AOF重写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3AOF%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF%E8%86%A8%E8%83%80%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8CRedis-%E6%8F%90%E4%BE%9B%E4%BA%86AOF%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99-rewrite-%E5%8A%9F%E8%83%BD%EF%BC%8C%E9%80%9A%E8%BF%87%E8%AF%A5%E5%8A%9F%E8%83%BD%EF%BC%8CRedis%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%AF%E4%BB%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%E6%9D%A5%E6%9B%BF%E4%BB%A3%E7%8E%B0%E6%9C%89%E7%9A%84AOF%E6%96%87%E4%BB%B6%EF%BC%8C%E6%96%B0%E6%97%A7%E4%B8%A4%E4%B8%AAAOF%E6%96%87%E4%BB%B6%E6%89%80%E4%BF%9D%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E7%9B%B8%E5%90%8C%EF%BC%8C-x3D-x3D-%E4%BD%86%E6%96%B0%E6%96%87%E4%BB%B6AOF%E6%96%87%E4%BB%B6%E4%B8%8D%E4%BC%9A%E5%8C%85%E5%90%AB%E4%BB%BB%E4%BD%95%E6%B5%AA%E8%B4%B9%E7%A9%BA%E9%97%B4%E7%9A%84%E5%86%97%E4%BD%99%E5%91%BD%E4%BB%A4%EF%BC%8C%E6%89%80%E4%BB%A5%E6%96%B0AOF%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%93%E7%A7%AF%E9%80%9A%E5%B8%B8%E4%BC%9A%E6%AF%94%E6%97%A7AOF%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%93%E7%A7%AF%E5%B0%8F%E5%BE%97%E5%A4%9A%E3%80%82-x3D-x3D"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">为了解决AOF文件体积膨胀的问题，Redis 提供了AOF文件重写(rewrite)功能，通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，&#x3D;&#x3D;但新文件AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积小得多。&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-1-AOF%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">11.3.1  AOF文件重写的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E5%B0%86%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%E6%9B%BF%E6%8D%A2%E6%97%A7%E7%9A%84AOF%E6%96%87%E4%BB%B6%E7%9A%84%E5%8A%9F%E8%83%BD%E5%91%BD%E5%90%8D%E4%B8%BA%E2%80%9DAOF%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99%E2%80%9D%EF%BC%8C%E4%BD%86%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C-x3D-x3D-AOF%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%AF%B9%E7%8E%B0%E6%9C%89%E7%9A%84AOF%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E4%BB%BB%E4%BD%95%E8%AF%BB%E5%8F%96%EF%BC%8C%E5%88%86%E6%9E%90%EF%BC%8C%E6%88%96%E8%80%85%E5%86%99%E5%85%A5%E6%93%8D%E4%BD%9C%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%8A%9F%E8%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E8%AF%BB%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BD%93%E5%89%8D%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">Redis将生成新的AOF文件替换旧的AOF文件的功能命名为”AOF文件重写”，但实际上，&#x3D;&#x3D;AOF文件重写并不需要对现有的AOF文件进行任何读取，分析，或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">例子：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-2-AOF-%E5%90%8E%E5%8F%B0%E9%87%8D%E5%86%99"><span class="toc-number">1.7.3.5.</span> <span class="toc-text">11.3.2  AOF  后台重写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8%E5%8D%95%E4%B8%AA%E7%BA%BF%E7%A8%8B%E6%9D%A5%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8aof-rewrite-%E5%87%BD%E6%95%B0%E7%9A%84%E8%AF%9D%EF%BC%8C%E9%82%A3%E4%B9%88%E5%9C%A8%E9%87%8D%E5%86%99AOF%E6%96%87%E4%BB%B6%E6%9C%9F%E9%97%B4%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86%E6%97%A0%E6%B3%95%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E6%9D%A5%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%9A"><span class="toc-number">1.7.3.6.</span> <span class="toc-text">Redis 服务器使用单个线程来处理命令，如果由服务器直接调用aof_rewrite 函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E4%B8%8D%E5%B8%8C%E6%9C%9BAOF%E9%87%8D%E5%86%99%E9%80%A0%E6%88%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%A0%E6%B3%95%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%EF%BC%8C%E6%89%80%E4%BB%A5Redis%E5%86%B3%E5%AE%9A%E5%B0%86AOF%E9%87%8D%E5%86%99%E7%A8%8B%E5%BA%8F%E6%94%BE%E5%85%A5%E5%88%B0%E5%AD%90%E7%A8%8B%E5%BA%8F%E4%B8%AD%E8%BF%9B%E8%A1%8C%EF%BC%8C%E4%BB%A5%E8%BE%BE%E6%88%90%E7%9B%AE%E7%9A%84%EF%BC%9A"><span class="toc-number">1.7.3.7.</span> <span class="toc-text">Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放入到子程序中进行，以达成目的：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%BF%9B%E8%A1%8CAOF%E9%87%8D%E5%86%99%E6%9C%9F%E9%97%B4%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B-%E7%88%B6%E8%BF%9B%E7%A8%8B-%E5%8F%AF%E4%BB%A5%E7%BB%A7%E7%BB%AD%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.3.8.</span> <span class="toc-text">子进程进行AOF重写期间，服务器进程(父进程)可以继续处理命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%B8%A6%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E5%89%AF%E6%9C%AC%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%80%8C%E4%B8%8D%E6%98%AF%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E9%94%81%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E3%80%82"><span class="toc-number">1.7.3.9.</span> <span class="toc-text">子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4%E9%97%AE%E9%A2%98%EF%BC%8CRedis-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE%E4%BA%86%E4%B8%80%E4%B8%AAAOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%8C%E8%BF%99%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%B9%8B%E5%90%8E%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.3.10.</span> <span class="toc-text">为了解决数据不一致问题，Redis 服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E4%B8%80%E4%B8%AA%E5%86%99%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%90%8C%E6%97%B6%E5%B0%86%E8%BF%99%E4%B8%AA%E5%86%99%E5%91%BD%E4%BB%A4%E5%8F%91%E9%80%81%E7%BB%99AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E5%92%8CAOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.7.3.11.</span> <span class="toc-text">当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8CAOF%E9%87%8D%E5%86%99%E6%9C%9F%E9%97%B4%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E7%A8%8B%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%B8%89%E4%B8%AA%E5%B7%A5%E4%BD%9C%EF%BC%9A"><span class="toc-number">1.7.3.12.</span> <span class="toc-text">在子进程执行AOF重写期间，服务器进程需要执行以下三个工作：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E6%9D%A5%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.3.13.</span> <span class="toc-text">执行客户端发来的命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E5%86%99%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0%E5%88%B0AOF%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.7.3.14.</span> <span class="toc-text">将执行后的写命令追加到AOF缓冲区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E5%86%99%E5%91%BD%E4%BB%A4%E8%BF%BD%E5%8A%A0%E5%88%B0AOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%E3%80%82"><span class="toc-number">1.7.3.15.</span> <span class="toc-text">将执行后的写命令追加到AOF重写缓冲区。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%99%E6%A0%B7%E4%B8%80%E6%9D%A5%E5%8F%AF%E4%BB%A5%E4%BF%9D%E8%AF%81%EF%BC%9A"><span class="toc-number">1.7.3.16.</span> <span class="toc-text">这样一来可以保证：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%86%85%E5%AE%B9%E4%BC%9A%E5%AE%9A%E6%9C%9F%E8%A2%AB%E5%86%99%E5%85%A5%E5%92%8C%E5%90%8C%E6%AD%A5%E5%88%B0AOF%E6%96%87%E4%BB%B6%EF%BC%8C%E5%AF%B9%E7%8E%B0%E6%9C%89AOF%E6%96%87%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86%E5%B7%A5%E4%BD%9C%E4%BC%9A%E5%A6%82%E5%B8%B8%E8%BF%9B%E8%A1%8C"><span class="toc-number">1.7.3.17.</span> <span class="toc-text">AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%BC%80%E5%A7%8B%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E6%89%80%E6%9C%89%E5%86%99%E5%91%BD%E4%BB%A4%E9%83%BD%E4%BC%9A%E8%A2%AB%E8%AE%B0%E5%BD%95%E5%88%B0AOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%E9%87%8C%E9%9D%A2"><span class="toc-number">1.7.3.18.</span> <span class="toc-text">从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%AE%8C%E6%88%90AOF%E9%87%8D%E5%86%99%E5%B7%A5%E4%BD%9C%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%90%91%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%E4%BF%A1%E5%8F%B7%EF%BC%8C%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%9C%A8%E6%8E%A5%E5%88%B0%E8%AF%A5%E4%BF%A1%E5%8F%B7%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BC%9A%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%EF%BC%8C%E5%B9%B6%E6%89%A7%E8%A1%8C%E4%BB%A5%E4%B8%8B%E5%B7%A5%E4%BD%9C%EF%BC%9A"><span class="toc-number">1.7.3.19.</span> <span class="toc-text">当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86AOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5%E5%88%B0%E6%96%B0AOF%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E8%BF%99%E6%97%B6%E6%96%B0AOF%E6%96%87%E4%BB%B6%E6%89%80%E4%BF%9D%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E5%B0%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BD%93%E5%89%8D%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4"><span class="toc-number">1.7.3.20.</span> <span class="toc-text">将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%94%B9%E5%90%8D%EF%BC%8C%E5%8E%9F%E5%AD%90%E5%9C%B0%EF%BC%88atomic%EF%BC%89%E8%A6%86%E7%9B%96%E7%8E%B0%E6%9C%89%E7%9A%84AOF%E6%96%87%E4%BB%B6%EF%BC%8C%E5%AE%8C%E6%88%90%E6%96%B0%E6%97%A7%E4%B8%A4%E4%B8%AAAOF%E6%96%87%E4%BB%B6%E7%9A%84%E6%9B%BF%E6%8D%A2"><span class="toc-number">1.7.3.21.</span> <span class="toc-text">对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%99%E4%B8%AA%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E4%B9%8B%E5%90%8E%EF%BC%8C%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%83%8F%E5%BE%80%E5%B8%B8%E4%B8%80%E6%A0%B7%E6%8E%A5%E5%8F%97%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E4%BA%86"><span class="toc-number">1.7.3.22.</span> <span class="toc-text">这个信号处理函数执行完毕之后，父进程就可以像往常一样接受命令请求了</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%95%B4%E4%B8%AAAOF%E5%90%8E%E5%8F%B0%E9%87%8D%E5%86%99%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E5%8F%AA%E6%9C%89%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%E4%BC%9A%E5%AF%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E7%88%B6%E8%BF%9B%E7%A8%8B%EF%BC%89%E9%80%A0%E6%88%90%E9%98%BB%E5%A1%9E%EF%BC%8C%E5%9C%A8%E5%85%B6%E4%BB%96%E6%97%B6%E5%80%99%EF%BC%8CAOF%E5%90%8E%E5%8F%B0%E9%87%8D%E5%86%99%E9%83%BD%E4%B8%8D%E4%BC%9A%E9%98%BB%E5%A1%9E%E7%88%B6%E8%BF%9B%E7%A8%8B%EF%BC%8C%E8%BF%99%E5%B0%86AOF%E9%87%8D%E5%86%99%E5%AF%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E9%80%A0%E6%88%90%E7%9A%84%E5%BD%B1%E5%93%8D%E9%99%8D%E5%88%B0%E4%BA%86%E6%9C%80%E4%BD%8E%E3%80%82"><span class="toc-number">1.7.3.23.</span> <span class="toc-text">在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A-1"><span class="toc-number">1.7.3.24.</span> <span class="toc-text">例子：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.7.4.</span> <span class="toc-text">11.4    重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E6%96%87%E4%BB%B6%E9%80%9A%E8%BF%87%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%86%99%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E6%9D%A5%E8%AE%B0%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E5%91%BD%E4%BB%A4%E9%83%BD%E4%BB%A5Redis%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%A0%BC%E5%BC%8F%E4%BF%9D%E5%AD%98"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">AOF文件中的所有命令都以Redis命令请求协议的格式保存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E4%BC%9A%E5%85%88%E4%BF%9D%E5%AD%98%E5%88%B0AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E9%87%8C%E9%9D%A2%EF%BC%8C%E4%B9%8B%E5%90%8E%E5%86%8D%E5%AE%9A%E6%9C%9F%E5%86%99%E5%85%A5%E5%B9%B6%E5%90%8C%E6%AD%A5%E5%88%B0AOF%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#appendfsync%E9%80%89%E9%A1%B9%E7%9A%84%E4%B8%8D%E5%90%8C%E5%80%BC%E5%AF%B9AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E4%BB%A5%E5%8F%8ARedis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E6%9C%89%E5%BE%88%E5%A4%A7%E7%9A%84%E5%BD%B1%E5%93%8D%E3%80%82"><span class="toc-number">1.7.4.4.</span> <span class="toc-text">appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器性能有很大的影响。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%AA%E8%A6%81%E8%BD%BD%E5%85%A5%E5%B9%B6%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E4%BF%9D%E5%AD%98%E5%9C%A8AOF%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%98%E5%8E%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%AC%E6%9D%A5%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">1.7.4.5.</span> <span class="toc-text">服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E9%87%8D%E5%86%99%E5%8F%AF%E4%BB%A5%E4%BA%A7%E7%94%9F%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%E5%92%8C%E5%8E%9F%E6%9D%A5%E7%9A%84AOF%E6%96%87%E4%BB%B6%E6%89%80%E4%BF%9D%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E6%98%AF%E4%B8%80%E8%87%B4%E7%9A%84%EF%BC%8C%E4%BD%86%E4%BD%93%E7%A7%AF%E6%9B%B4%E5%B0%8F"><span class="toc-number">1.7.4.6.</span> <span class="toc-text">AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原来的AOF文件所保存的数据库状态是一致的，但体积更小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E9%87%8D%E5%86%99%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%AD%A7%E4%B9%89%E7%9A%84%E5%90%8D%E5%AD%97%EF%BC%8C%E8%AF%A5%E5%8A%9F%E8%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E9%94%AE%E5%80%BC%E5%AF%B9%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%8C%E7%A8%8B%E5%BA%8F%E6%97%A0%E9%9C%80%E5%AF%B9%E7%8E%B0%E6%9C%89%E7%9A%84AOF%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E4%BB%BB%E4%BD%95%E8%AF%BB%E5%85%A5%EF%BC%8C%E5%88%86%E6%9E%90%EF%BC%8C%E6%88%96%E8%80%85%E5%86%99%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">1.7.4.7.</span> <span class="toc-text">AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无需对现有的AOF文件进行任何读入，分析，或者写入操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%89%A7%E8%A1%8CBGREWRITEAOF%E5%91%BD%E4%BB%A4%E6%97%B6%EF%BC%8CRedis%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E7%BB%B4%E6%8A%A4%E4%B8%80%E4%B8%AAAOF%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%8C%E8%AF%A5%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BC%9A%E5%9C%A8%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%96%B0AOF%E6%96%87%E4%BB%B6%E6%9C%9F%E9%97%B4%EF%BC%8C%E8%AE%B0%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E6%89%80%E6%9C%89%E5%86%99%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%BD%93%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%AE%8C%E6%88%90%E5%88%9B%E5%BB%BA%E6%96%B0AOF%E6%96%87%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E5%B0%86%E9%87%8D%E5%86%99%E7%BC%93%E5%86%B2%E5%8C%BA%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E5%86%85%E5%AE%B9%E8%BF%BD%E5%8A%A0%E5%88%B0%E6%96%B0AOF%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%AB%E5%B0%BE%EF%BC%8C%E8%BF%99%E4%BD%BF%E5%BE%97%E6%96%B0%E6%97%A7%E4%B8%A4%E4%B8%AAAOF%E6%96%87%E4%BB%B6%E6%89%80%E4%BF%9D%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%EF%BC%8C%E6%9C%80%E5%90%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%94%A8%E6%96%B0%E7%9A%84AOF%E6%96%87%E4%BB%B6%E6%9B%BF%E6%8D%A2%E6%97%A7%E7%9A%84AOF%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BB%A5%E6%AD%A4%E6%9D%A5%E5%AE%8C%E6%88%90AOF%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99%E6%93%8D%E4%BD%9C%E3%80%82"><span class="toc-number">1.7.4.8.</span> <span class="toc-text">在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令，当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中所有的内容追加到新AOF文件的末尾，这使得新旧两个AOF文件所保存的数据库状态一致，最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-12-%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.8.</span> <span class="toc-text">Chapter  12   事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E4%BB%A5%E4%B8%8B%E4%B8%A4%E7%B1%BB%E4%BA%8B%E4%BB%B6%EF%BC%9A"><span class="toc-number">1.8.0.1.</span> <span class="toc-text">Redis服务器是一个事件驱动程序，服务器需要处理以下两类事件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%EF%BC%9ARedis-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E8%BF%87%E5%A5%97%E6%8E%A5%E5%AD%97%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88%E6%88%96%E8%80%85%E5%85%B6%E4%BB%96Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89%E8%BF%9B%E8%A1%8C%E8%BF%9E%E6%8E%A5%EF%BC%8C%E8%80%8C%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%B0%B1%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9%E5%A5%97%E6%8E%A5%E5%AD%97%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8A%BD%E8%B1%A1%E3%80%82%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88%E6%88%96%E8%80%85%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89%E7%9A%84%E9%80%9A%E4%BF%A1%E4%BC%9A%E4%BA%A7%E7%94%9F%E7%9B%B8%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%EF%BC%8C%E8%80%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%99%E9%80%9A%E8%BF%87%E7%9B%91%E5%90%AC%E5%B9%B6%E5%A4%84%E7%90%86%E8%BF%99%E4%BA%9B%E4%BA%8B%E4%BB%B6%E6%9D%A5%E5%AE%8C%E6%88%90%E4%B8%80%E7%B3%BB%E5%88%97%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">1.8.0.2.</span> <span class="toc-text">文件事件：Redis  服务器通过套接字与客户端（或者其他Redis服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或者其他服务器）的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%EF%BC%8CRedis%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%EF%BC%8C%EF%BC%88%E6%AF%94%E5%A6%82serverCron%E5%87%BD%E6%95%B0%EF%BC%89%E9%9C%80%E8%A6%81%E5%9C%A8%E7%BB%99%E5%AE%9A%E7%9A%84%E4%BA%8B%E4%BB%B6%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%80%8C%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%B0%B1%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9%E8%BF%99%E7%B1%BB%E5%AE%9A%E6%97%B6%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8A%BD%E8%B1%A1%E3%80%82"><span class="toc-number">1.8.0.3.</span> <span class="toc-text">时间事件，Redis服务器中的一些操作，（比如serverCron函数）需要在给定的事件点执行，而时间事件就是服务器对这类定时操作的抽象。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.8.1.</span> <span class="toc-text">12.1   文件事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E5%9F%BA%E7%A1%80Reactor-%E6%A8%A1%E5%BC%8F%E5%BC%80%E5%8F%91%E4%BA%86%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%9A%E8%BF%99%E4%B8%AA%E5%A4%84%E7%90%86%E5%99%A8%E8%A2%AB%E7%A7%B0%E4%B8%BA%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88file-event-handler%EF%BC%89-%EF%BC%9A"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">Redis  基础Reactor  模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器（file event handler）  ：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%BF%E7%94%A8-I-x2F-O-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%9D%A5%E5%90%8C%E6%97%B6%E7%9B%91%E5%90%AC%E5%A4%9A%E4%B8%AA%E5%A5%97%E6%8E%A5%E5%AD%97%EF%BC%8C%E5%B9%B6%E6%A0%B9%E6%8D%AE%E5%A5%97%E6%8E%A5%E5%AD%97%E7%9B%AE%E5%89%8D%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%9D%A5%E4%B8%BA%E5%A5%97%E6%8E%A5%E5%AD%97%E5%85%B3%E8%81%94%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">文件事件处理器使用 I&#x2F;O 多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E7%9B%91%E5%90%AC%E7%9A%84%E5%A5%97%E6%8E%A5%E5%AD%97%E5%87%86%E5%A4%87%E5%A5%BD%E6%89%A7%E8%A1%8C%E8%BF%9E%E6%8E%A5%E5%BA%94%E7%AD%94%EF%BC%8C%E8%AF%BB%E5%8F%96%EF%BC%8C%E5%86%99%E5%85%A5%EF%BC%8C%E5%85%B3%E9%97%AD%E7%AD%89%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%B0%B1%E4%BC%9A%E4%BA%A7%E7%94%9F%EF%BC%8C%E8%BF%99%E6%97%B6%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E5%B0%B1%E4%BC%9A%E8%B0%83%E7%94%A8%E5%A5%97%E6%8E%A5%E5%AD%97%E4%B9%8B%E5%89%8D%E5%85%B3%E8%81%94%E5%A5%BD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E6%9D%A5%E5%A4%84%E7%90%86%E8%BF%99%E4%BA%9B%E4%BA%8B%E4%BB%B6%E3%80%82"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">当监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-1-%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">1.8.1.4.</span> <span class="toc-text">12.1.1   文件事件处理器的构成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-2-I-x2F-O-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.1.5.</span> <span class="toc-text">12.1.2    I&#x2F;O  多路复用程序的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E7%9A%84I-x2F-O-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%80%E6%9C%89%E5%8A%9F%E8%83%BD-%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E5%8C%85%E8%A3%85%E5%B8%B8%E8%A7%81%E7%9A%84-select-%EF%BC%8Cepoll%EF%BC%8Cevport%EF%BC%8C%E5%92%8Ckqueue-%E8%BF%99%E4%BA%9BI-x2F-O-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%87%BD%E6%95%B0%E5%BA%93%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82"><span class="toc-number">1.8.1.6.</span> <span class="toc-text">Redis 的I&#x2F;O 多路复用程序的所有功能 都是通过包装常见的 select ，epoll，evport，和kqueue 这些I&#x2F;O 多路复用函数库来实现的。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-13-%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.8.1.7.</span> <span class="toc-text">12.1.13  事件的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-4-API"><span class="toc-number">1.8.1.8.</span> <span class="toc-text">12.1.4   API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-5-%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.8.1.9.</span> <span class="toc-text">12.1.5      文件事件的处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%BA%94%E7%AD%94%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.8.1.10.</span> <span class="toc-text">连接应答处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.8.1.11.</span> <span class="toc-text">命令请求处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.8.1.12.</span> <span class="toc-text">命令回复处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9E%E6%8E%A5%E4%BA%8B%E4%BB%B6%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.8.1.13.</span> <span class="toc-text">一次完整的客户端与服务器连接事件示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.8.2.</span> <span class="toc-text">12.2   时间事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-1-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">12.2.1  实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86%E6%89%80%E6%9C%89%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E9%83%BD%E6%94%BE%E5%9C%A8%E4%B8%80%E4%B8%AA%E6%97%A0%E5%BA%8F%E9%93%BE%E8%A1%A8%E4%B8%AD%EF%BC%8C%E6%AF%8F%E5%BD%93%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E6%89%A7%E8%A1%8C%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%AE%83%E5%B0%B1%E9%81%8D%E5%8E%86%E6%95%B4%E4%B8%AA%E9%93%BE%E8%A1%A8%EF%BC%8C%E6%9F%A5%E6%89%BE%E6%89%80%E6%9C%89-%E5%B7%B2%E5%88%B0%E8%BE%BE%E7%9A%84%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8%E7%9B%B8%E5%BA%94%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E3%80%82"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有 已到达的时间事件，并调用相应的事件处理器。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E8%AF%B4%E4%BF%9D%E5%AD%98%E7%9A%84%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E7%9A%84%E9%93%BE%E8%A1%A8%E6%98%AF%E6%97%A0%E5%BA%8F%E9%93%BE%E8%A1%A8%EF%BC%8C%E6%8C%87%E7%9A%84%E4%B8%8D%E6%98%AF%E9%93%BE%E8%A1%A8%E4%B8%8D%E6%8C%89ID%E6%8E%92%E5%BA%8F%EF%BC%8C%E8%80%8C%E6%98%AF%E8%AF%B4%EF%BC%8C%E8%AF%A5%E9%93%BE%E8%A1%A8%E4%B8%8D%E6%8C%89when%E5%B1%9E%E6%80%A7%E7%9A%84%E5%A4%A7%E5%B0%8F%E6%8E%92%E5%BA%8F%EF%BC%8C%E6%AD%A3%E5%9B%A0%E4%B8%BA%E9%93%BE%E8%A1%A8%E6%B2%A1%E6%9C%89%E6%8C%89when%E5%B1%9E%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%EF%BC%8C%E6%89%80%E4%BB%A5%E5%BD%93%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E6%89%A7%E8%A1%8C%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%AE%83%E5%BF%85%E9%A1%BB%E9%81%8D%E5%8E%86%E9%93%BE%E8%A1%A8%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%89%8D%E8%83%BD%E4%BF%9D%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E6%89%80%E6%9C%89%E5%B7%B2%E5%88%B0%E8%BE%BE%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BA%8B%E4%BB%B6%E9%83%BD%E4%BC%9A%E8%A2%AB%E5%A4%84%E7%90%86%E3%80%82"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">我们说保存的时间事件的链表是无序链表，指的不是链表不按ID排序，而是说，该链表不按when属性的大小排序，正因为链表没有按when属性进行排序，所以当时间事件执行器运行时，它必须遍历链表中的所有时间事件，这样才能保证服务器中所有已到达的事件事件都会被处理。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-2-API"><span class="toc-number">1.8.2.4.</span> <span class="toc-text">12.2.2   API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-3-%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A-serverCron-%E5%87%BD%E6%95%B0"><span class="toc-number">1.8.2.5.</span> <span class="toc-text">12.2.3  时间事件应用案例： serverCron 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-3-%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%B0%83%E5%BA%A6%E4%B8%8E%E6%89%A7%E8%A1%8C"><span class="toc-number">1.8.3.</span> <span class="toc-text">12.3    事件的调度与执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-4-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.8.4.</span> <span class="toc-text">12.4     重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%88%86%E4%B8%BA%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%E6%98%AF%E5%9F%BA%E4%BA%8EReactor%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.8.4.2.</span> <span class="toc-text">文件事件处理器是基于Reactor模式实现的网络通信程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E6%98%AF%E5%AF%B9%E5%A5%97%E6%8E%A5%E5%AD%97%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8A%BD%E8%B1%A1%EF%BC%9A%E6%AF%8F%E6%AC%A1%E5%A5%97%E6%8E%A5%E5%AD%97%E5%8F%98%E4%B8%BA%E5%8F%AF%E5%BA%94%E7%AD%94%EF%BC%8C%E5%8F%AF%E8%AF%BB%E5%86%99%EF%BC%8C%E6%88%96%E8%80%85%E5%8F%AF%E8%AF%BB%E6%97%B6%EF%BC%8C%E7%9B%B8%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%B0%B1%E4%BC%9A%E4%BA%A7%E7%94%9F"><span class="toc-number">1.8.4.3.</span> <span class="toc-text">文件事件是对套接字操作的抽象：每次套接字变为可应答，可读写，或者可读时，相应的文件事件就会产生</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%88%86%E4%B8%BAAE-READABLE-%E4%BA%8B%E4%BB%B6%EF%BC%88%E8%AF%BB%E4%BA%8B%E4%BB%B6%EF%BC%89%EF%BC%8C%E5%92%8CAE-WRITABLE%EF%BC%88%E5%86%99%E4%BA%8B%E4%BB%B6%EF%BC%89"><span class="toc-number">1.8.4.4.</span> <span class="toc-text">文件事件分为AE_READABLE  事件（读事件），和AE_WRITABLE（写事件）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E5%88%86%E4%B8%BA%E5%AE%9A%E6%97%B6%E4%BA%8B%E4%BB%B6%E5%92%8C%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BA%8B%E4%BB%B6%EF%BC%9A%E5%AE%9A%E6%97%B6%E4%BA%8B%E4%BB%B6%E5%8F%AA%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%88%B0%E8%BE%BE%E4%B8%80%E6%AC%A1%EF%BC%8C%E8%80%8C-%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BA%8B%E4%BB%B6%E5%88%99%E9%9A%94%E6%AF%8F%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%88%B0%E8%BE%BE%E4%B8%80%E6%AC%A1%E3%80%82"><span class="toc-number">1.8.4.5.</span> <span class="toc-text">时间事件分为定时事件和周期性事件：定时事件只在指定的事件到达一次，而 周期性事件则隔每一段时间到达一次。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E4%B8%80%E8%88%AC%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%AA%E6%89%A7%E8%A1%8CserverCron%E5%87%BD%E6%95%B0%E4%B8%80%E4%B8%AA%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%99%E4%B8%AA%E4%BA%8B%E4%BB%B6%E6%98%AF%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BA%8B%E4%BB%B6%E3%80%82"><span class="toc-number">1.8.4.6.</span> <span class="toc-text">服务器在一般情况下只执行serverCron函数一个事件，并且这个事件是周期性事件。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%97%B6%E9%97%B4%E6%97%B6%E9%97%B4%E4%B9%8B%E9%97%B4%E6%98%AF%E5%90%88%E4%BD%9C%E5%85%B3%E7%B3%BB%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E8%BD%AE%E6%B5%81%E5%A4%84%E7%90%86%E8%BF%99%E4%B8%A4%E7%A7%8D%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%A4%84%E7%90%86%E8%BF%99%E4%B8%A4%E7%A7%8D%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%B9%9F%E4%B8%8D%E4%BC%9A%E8%BF%9B%E8%A1%8C%E6%8A%A2%E5%8D%A0"><span class="toc-number">1.8.4.7.</span> <span class="toc-text">文件事件和时间时间之间是合作关系，服务器会轮流处理这两种事件，并且处理这两种事件的过程中也不会进行抢占</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%AE%9E%E9%99%85%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6%E9%80%9A%E5%B8%B8%E4%BC%9A%E6%AF%94%E8%AE%BE%E5%AE%9A%E7%9A%84%E8%BE%BE%E5%88%B0%E6%97%B6%E9%97%B4%E6%99%9A%E4%B8%80%E4%BA%9B%E3%80%82"><span class="toc-number">1.8.4.8.</span> <span class="toc-text">时间事件的实际处理事件通常会比设定的达到时间晚一些。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-13-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.</span> <span class="toc-text">Chapter 13  客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E5%85%B8%E5%9E%8B%E7%9A%84%E4%B8%80%E5%AF%B9%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A8%8B%E5%BA%8F%EF%BC%9A-x3D-x3D-%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%AF%E4%BB%A5%E5%92%8C%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BB%BA%E7%AB%8B%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%EF%BC%8C%E6%AF%8F%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%AF%E4%BB%A5%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%80%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%99%E6%8E%A5%E6%94%B6%E5%B9%B6%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E7%9A%84%E8%AF%B7%E6%B1%82%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B9%B6%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%94%E5%9B%9E%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E3%80%82-x3D-x3D"><span class="toc-number">1.9.0.1.</span> <span class="toc-text">Redis 服务器是典型的一对多服务器程序：&#x3D;&#x3D;一个服务器可以和多个客户端建立网络连接，每个客户端可以向服务器发送命令请求，而服务器则接收并处理客户端发送的请求命令，并向客户端返回命令回复。&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BD%BF%E7%94%A8%E7%94%B1I-x2F-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%96%87%E4%BB%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%8C-x3D-x3D-Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%8D%95%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8E%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E3%80%82-x3D-x3D"><span class="toc-number">1.9.0.2.</span> <span class="toc-text">通过使用由I&#x2F;O多路复用技术实现的文件事件处理器，&#x3D;&#x3D;Redis服务器使用单线程单进程的方式来处理命令请求，并与多个客户端进行网络通信。&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E6%AF%8F%E4%B8%AA%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E8%A1%8C%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%BD%E4%B8%BA%E8%BF%99%E4%BA%9B%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BB%BA%E7%AB%8B%E4%BA%86%E7%9B%B8%E5%BA%94%E7%9A%84redis-h-x2F-redisClient%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%EF%BC%8C%E8%BF%99%E4%B8%AA%E7%BB%93%E6%9E%84%E4%BF%9D%E5%AD%98%E4%BA%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BD%93%E5%89%8D%E7%9A%84%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%97%B6%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.9.0.3.</span> <span class="toc-text">对于每个与服务器进行连接的客户端，服务器都为这些客户端建立了相应的redis.h&#x2F;redisClient结构——客户端状态，这个结构保存了客户端当前的状态信息，以及执行相关功能时需要用到的数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%82-2"><span class="toc-number">1.9.0.4.</span> <span class="toc-text">。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B1%9E%E6%80%A7"><span class="toc-number">1.9.1.</span> <span class="toc-text">13.1   客户端属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E5%8C%85%E5%90%AB%E7%9A%84%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%BB%A5%E4%B8%8B%E4%B8%A4%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">客户端状态包含的属性可以分为以下两类：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%B1%BB%E6%98%AF%E6%AF%94%E8%BE%83%E9%80%9A%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%B1%9E%E6%80%A7%E5%BE%88%E5%B0%91%E4%B8%8E%E7%89%B9%E5%AE%9A%E5%8A%9F%E8%83%BD%E7%9B%B8%E5%85%B3%EF%BC%8C%E6%97%A0%E8%AE%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%A7%E8%A1%8C%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%E5%B7%A5%E4%BD%9C%EF%BC%8C%E4%BB%96%E4%BB%AC%E9%83%BD%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E8%BF%99%E4%BA%9B%E5%B1%9E%E6%80%A7"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">一类是比较通用的属性，这些属性很少与特定功能相关，无论客户端执行的是什么工作，他们都需要用到这些属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%A6%E5%A4%96%E4%B8%80%E7%B1%BB%E6%98%AF%E5%92%8C%E7%89%B9%E5%AE%9A%E5%8A%9F%E8%83%BD%E7%BA%BF%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E6%AF%94%E5%A6%82%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84db%E5%B1%9E%E6%80%A7%E5%92%8Cdictid%E5%B1%9E%E6%80%A7%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1%E6%97%B6%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84matate%E5%B1%9E%E6%80%A7%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%89%A7%E8%A1%8Cwatch%E5%91%BD%E4%BB%A4%E6%97%B6%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84watched-keys%E5%B1%9E%E6%80%A7%E7%AD%89%E3%80%82"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">另外一类是和特定功能线相关的属性，比如操作数据库需要用到的db属性和dictid属性，执行事务时需要用到的matate属性，以及执行watch命令时需要用到的watched_keys属性等。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-1-%E5%A5%97%E6%8E%A5%E5%AD%97%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">13.1.1   套接字描述符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-2-%E5%90%8D%E5%AD%97"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">13.1.2 名字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E6%B2%A1%E6%9C%89%E5%90%8D%E5%AD%97%E7%9A%84%E3%80%82"><span class="toc-number">1.9.1.6.</span> <span class="toc-text">在默认情况下，一个连接到服务器的客户端是没有名字的。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8client-setname-%E5%91%BD%E4%BB%A4%E5%8F%AF%E4%BB%A5%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E5%90%8D%E5%AD%97%EF%BC%8C%E8%AE%A9%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BA%AB%E4%BB%BD%E5%8F%98%E5%BE%97%E6%9B%B4%E6%B8%85%E6%99%B0%EF%BC%8C"><span class="toc-number">1.9.1.7.</span> <span class="toc-text">使用client  setname 命令可以为客户端设置一个名字，让客户端身份变得更清晰，</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B2%A1%E6%9C%89%E4%B8%BA%E8%87%AA%E5%B7%B1%E8%AE%BE%E7%BD%AE%E5%90%8D%E5%AD%97%EF%BC%8C%E9%82%A3%E4%B9%88%E7%9B%B8%E5%BA%94%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84name%E5%B1%9E%E6%80%A7%E6%8C%87%E5%90%91NULL%E6%8C%87%E9%92%88%EF%BC%8C%E5%8F%8D%E4%B9%8B%E5%88%99%E6%8C%87%E5%90%91%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%AF%A5%E5%AF%B9%E8%B1%A1%E4%BF%9D%E5%AD%98%E7%9D%80%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%90%8D%E5%AD%97%E3%80%82"><span class="toc-number">1.9.1.8.</span> <span class="toc-text">如果客户端没有为自己设置名字，那么相应客户端状态的name属性指向NULL指针，反之则指向一个字符串对象，该对象保存着客户端的名字。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-3-%E6%A0%87%E5%BF%97"><span class="toc-number">1.9.1.9.</span> <span class="toc-text">13.1.3   标志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-4-%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.9.1.10.</span> <span class="toc-text">13.1.4   输入缓冲区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%BC%9A%E6%A0%B9%E6%8D%AE%E8%BE%93%E5%85%A5%E5%86%85%E5%AE%B9%E5%8A%A8%E6%80%81%E7%9A%84%E7%BC%A9%E5%B0%8F%E6%88%96%E6%89%A9%E5%A4%A7%EF%BC%8C%E4%BD%86%E5%AE%83%E7%9A%84%E6%9C%80%E5%A4%A7%E5%A4%A7%E5%B0%8F%E4%B8%8D%E8%83%BD%E8%B6%85%E8%BF%871GB-%E5%90%A6%E5%88%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86%E5%85%B3%E9%97%AD%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.1.11.</span> <span class="toc-text">输入缓冲区的大小会根据输入内容动态的缩小或扩大，但它的最大大小不能超过1GB,否则服务器将关闭这个客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%82-3"><span class="toc-number">1.9.1.12.</span> <span class="toc-text">。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-5-%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="toc-number">1.9.1.13.</span> <span class="toc-text">13.1.5   命令与命令参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-6-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.1.14.</span> <span class="toc-text">13.1.6      命令的实现函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-7-%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.9.1.15.</span> <span class="toc-text">13.1.7 输出缓冲区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%80%E5%BE%97%E5%88%B0%E7%9A%84%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E4%BC%9A%E8%A2%AB%E4%BF%9D%E5%AD%98%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84%E8%BE%93%E5%87%BA%E7%BC%93%E5%AD%98%E5%8C%BA%E9%87%8C%EF%BC%8C%E6%AF%8F%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%83%BD%E6%9C%89%E4%B8%A4%E4%B8%AA%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%8C%E4%B8%80%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E6%98%AF%E5%9B%BA%E5%AE%9A%E7%9A%84%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E6%98%AF%E5%8F%AF%E5%8F%98%E7%9A%84"><span class="toc-number">1.9.1.16.</span> <span class="toc-text">执行命令所得到的命令回复会被保存在客户端状态的输出缓存区里，每个客户端都有两个输出缓冲区，一个缓冲区的大小是固定的，另一个缓冲区的大小是可变的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x3D-x3D-%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA%E7%94%A8%E4%BA%8E%E4%BF%9D%E5%AD%98%E9%82%A3%E4%BA%9B%E9%95%BF%E5%BA%A6%E6%AF%94%E8%BE%83%E5%B0%8F%E7%9A%84%E5%9B%9E%E5%A4%8D-x3D-x3D-%EF%BC%8C%E6%AF%94%E5%A6%82OK%EF%BC%8C%E7%AE%80%E7%9F%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%80%BC%EF%BC%8C%E6%95%B4%E6%95%B0%E5%80%BC%EF%BC%8C%E9%94%99%E8%AF%AF%E7%9A%84%E5%9B%9E%E5%A4%8D%E7%AD%89"><span class="toc-number">1.9.1.17.</span> <span class="toc-text">&#x3D;&#x3D;固定大小的缓冲区用于保存那些长度比较小的回复&#x3D;&#x3D;，比如OK，简短的字符串值，整数值，错误的回复等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E5%8F%98%E5%A4%A7%E5%B0%8F%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA%E7%94%A8%E4%BA%8E%E4%BF%9D%E5%AD%98%E9%82%A3%E4%BA%9B%E9%95%BF%E5%BA%A6%E8%BE%83%E9%95%BF%E7%9A%84%E5%9B%9E%E5%A4%8D%EF%BC%8C%E6%AF%94%E5%A6%82%E4%B8%80%E4%B8%AA%E9%9D%9E%E5%B8%B8%E9%95%BF%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%80%BC%EF%BC%8C%E4%B8%80%E4%B8%AA%E7%94%B1%E5%BE%88%E5%A4%9A%E9%A1%B9%E7%BB%84%E6%88%90%E7%9A%84%E5%88%97%E8%A1%A8%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%8C%85%E5%90%AB%E4%BA%86%E5%BE%88%E5%A4%9A%E5%85%83%E7%B4%A0%E7%9A%84%E9%9B%86%E5%90%88%E3%80%82"><span class="toc-number">1.9.1.18.</span> <span class="toc-text">可变大小的缓冲区用于保存那些长度较长的回复，比如一个非常长的字符串值，一个由很多项组成的列表，一个包含了很多元素的集合。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-8-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.1.19.</span> <span class="toc-text">13.1.8   身份验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9Cauthenticated-%E7%9A%84%E5%80%BC%E4%B8%BA0%E5%88%99%E9%AA%8C%E8%AF%81%E6%9C%AA%E9%80%9A%E8%BF%87%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%BA1%E5%88%99%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87"><span class="toc-number">1.9.1.20.</span> <span class="toc-text">如果authenticated 的值为0则验证未通过，如果为1则验证通过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%82-4"><span class="toc-number">1.9.1.21.</span> <span class="toc-text">。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87auth-%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.1.22.</span> <span class="toc-text">通过auth 命令进行身份验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%85%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E7%94%A8%E4%BA%86%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%8A%9F%E8%83%BD%E6%97%B6%E4%BD%BF%E7%94%A8%EF%BC%8C-x3D-x3D-%E5%A6%82%E6%9E%9C%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B2%A1%E6%9C%89%E5%90%AF%E7%94%A8%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%8A%9F%E8%83%BD%EF%BC%8C%E9%82%A3%E4%B9%88%E5%8D%B3%E4%BD%BFauthenticated%E4%B8%BA0%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%9F%E4%B8%8D%E4%BC%9A%E6%8B%92%E7%BB%9D%E6%89%A7%E8%A1%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E7%94%9F%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E3%80%82-x3D-x3D"><span class="toc-number">1.9.1.23.</span> <span class="toc-text">仅在服务器启用了身份验证功能时使用，&#x3D;&#x3D;如果服务器没有启用身份验证功能，那么即使authenticated为0，服务器也不会拒绝执行客户端发生的命令请求。&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-9-%E6%97%B6%E9%97%B4"><span class="toc-number">1.9.1.24.</span> <span class="toc-text">13.1.9      时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%97%B6%E9%97%B4%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B1%9E%E6%80%A7%E3%80%82"><span class="toc-number">1.9.1.25.</span> <span class="toc-text">客户端与时间相关的属性。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ctime"><span class="toc-number">1.9.1.26.</span> <span class="toc-text">ctime</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lastinteraction%E3%80%82"><span class="toc-number">1.9.1.27.</span> <span class="toc-text">lastinteraction。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%85%B3%E9%97%AD"><span class="toc-number">1.9.2.</span> <span class="toc-text">13.2   客户端的创建与关闭</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%88%9B%E5%BB%BA%E5%92%8C%E5%85%B3%E9%97%AD%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E3%80%82"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">服务器使用不同的方式来创建和关闭不同类型的客户端。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-1-%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">13.2.1   创建普通客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87connect%E5%87%BD%E6%95%B0%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">通过connect函数连接服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-2-%E5%85%B3%E9%97%AD%E6%99%AE%E9%80%9A%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.2.4.</span> <span class="toc-text">13.2.2  关闭普通客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E5%88%9B%E5%BB%BA%E8%B4%9F%E8%B4%A3%E6%89%A7%E8%A1%8Clua%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84Redis%E5%91%BD%E4%BB%A4%E7%9A%84%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%B9%B6%E5%B0%86%E8%BF%99%E4%B8%AA%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E8%81%94%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84%E7%9A%84lua-client%E5%B1%9E%E6%80%A7%E4%B8%AD%E3%80%82"><span class="toc-number">1.9.2.5.</span> <span class="toc-text">服务器会在初始化时创建负责执行lua脚本中包含的Redis命令的为客户端，并将这个伪客户端关联在服务器状态结构的lua_client属性中。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-client-%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E6%95%B4%E4%B8%AA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%AD%E4%BC%9A%E4%B8%80%E7%9B%B4%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%8F%AA%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%97%AD%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%8D%E4%BC%9A%E8%A2%AB%E5%85%B3%E9%97%AD%E3%80%82"><span class="toc-number">1.9.2.6.</span> <span class="toc-text">lua_client 伪客户端在服务器运行的整个生命周期中会一直存在，只有服务器关闭时，这个客户端才会被关闭。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-4-AOF%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.9.2.7.</span> <span class="toc-text">13.2.4  AOF文件的为客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E8%BD%BD%E5%85%A5AOF%E6%96%87%E4%BB%B6%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%88%9B%E5%BB%BA%E7%94%A8%E4%BA%8E%E6%89%A7%E8%A1%8CAOF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84Redis%E5%91%BD%E4%BB%A4%E7%9A%84%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%B9%B6%E5%9C%A8%E8%BD%BD%E5%85%A5%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%85%B3%E9%97%AD%E8%BF%99%E4%B8%AA%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E3%80%82"><span class="toc-number">1.9.2.8.</span> <span class="toc-text">服务器在载入AOF文件时，会创建用于执行AOF文件包含的Redis命令的为客户端，并在载入完成之后，关闭这个为客户端。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.9.3.</span> <span class="toc-text">13.3   重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84%E4%BD%BF%E7%94%A8clients%E9%93%BE%E8%A1%A8%E8%BF%9E%E6%8E%A5%E8%B5%B7%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%EF%BC%8C%E6%96%B0%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E4%BC%9A%E8%A2%AB%E6%94%BE%E5%88%B0%E9%93%BE%E8%A1%A8%E7%9A%84%E6%9C%AB%E5%B0%BE"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84flags%E5%B1%9E%E6%80%A7%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E6%A0%87%E5%BF%97%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%A7%92%E8%89%B2%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BD%93%E5%89%8D%E6%89%80%E5%A4%84%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%9B%9E%E5%8C%BA%E8%AE%B0%E5%BD%95%E4%BA%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E7%9A%84%E8%AF%B7%E6%B1%82%E5%91%BD%E4%BB%A4%EF%BC%8C%E8%BF%99%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%B8%8D%E8%83%BD%E8%B6%85%E8%BF%871GB"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">输入缓冲回区记录了客户端发送的请求命令，这个缓冲区的大小不能超过1GB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%9A%84%E5%8F%82%E6%95%B0%E5%92%8C%E5%8F%82%E6%95%B0%E4%B8%AA%E6%95%B0%E4%BC%9A%E8%A2%AB%E8%AE%B0%E5%BD%95%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84argv%E5%92%8Cargc%E5%B1%9E%E6%80%A7%E9%87%8C%E9%9D%A2%EF%BC%8C%E8%80%8Ccmd%E5%B1%9E%E6%80%A7%E5%88%99%E8%AE%B0%E5%BD%95%E4%BA%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%A6%81%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">命令的参数和参数个数会被记录在客户端状态的argv和argc属性里面，而cmd属性则记录了客户端要执行命令的实现函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%94%B1%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%86%B2%E5%8C%BA%E5%92%8C%E5%8F%AF%E5%8F%98%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%86%B2%E5%8C%BA%E4%B8%A4%E7%A7%8D%E7%BC%93%E5%86%B2%E5%8C%BA%E5%8F%AF%E7%94%A8%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%9C%80%E5%A4%A7%E5%A4%A7%E5%B0%8F%E4%B8%BA16KB%EF%BC%8C%E8%80%8C%E5%8F%AF%E5%8F%98%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%9C%80%E5%A4%A7%E9%87%8F%E5%A4%A7%E5%B0%8F%E4%B8%8D%E8%83%BD%E8%B6%85%E8%BF%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%A1%AC%E6%80%A7%E9%99%90%E5%88%B6%E5%80%BC"><span class="toc-number">1.9.3.5.</span> <span class="toc-text">客户端由固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大量大小不能超过服务器设置的硬性限制值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E9%99%90%E5%88%B6%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%B6%85%E8%BF%87%E4%BA%86%E6%9C%8D%E5%8A%A1%E5%8C%BA%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%A1%AC%E6%80%A7%E9%99%90%E5%88%B6%EF%BC%8C%E9%82%A3%E4%B9%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%9A%E8%A2%AB%E7%AB%8B%E5%8D%B3%E5%85%B3%E9%97%AD%EF%BC%9B%E9%99%A4%E6%AD%A4%E4%B9%8B%E5%A4%96%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E4%B8%80%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%EF%BC%8C%E4%B8%80%E7%9B%B4%E8%B6%85%E8%BF%87%E6%9C%8D%E5%8A%A1%E5%8C%BA%E8%AE%BE%E7%BD%AE%E7%9A%84%E8%BD%AF%E6%80%A7%E9%99%90%E5%88%B6%EF%BC%8C%E9%82%A3%E4%B9%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B9%9F%E4%BC%9A%E8%A2%AB%E5%85%B3%E9%97%AD"><span class="toc-number">1.9.3.6.</span> <span class="toc-text">输出缓冲区限制有两种，如果输出缓冲区的大小超过了服务区设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务区设置的软性限制，那么客户端也会被关闭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E8%BF%9E%E4%B8%8A%E4%BA%86%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%B1%E4%BC%9A%E4%B8%BA%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%EF%BC%8C%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E5%85%B3%E9%97%AD%EF%BC%8C%E5%8F%91%E9%80%81%E4%BA%86%E4%B8%8D%E5%90%88%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%8C%E7%A7%B0%E4%B8%BACLient-kill-%E5%91%BD%E4%BB%A4%E7%9A%84%E7%9B%AE%E6%A0%87%EF%BC%8C%E7%A9%BA%E9%97%B4%E6%97%B6%E9%97%B4%E8%B6%85%E6%97%B6%EF%BC%8C%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%B6%85%E5%87%BA%E9%99%90%E5%88%B6%EF%BC%8C%E4%BB%A5%E4%B8%8A%E5%8E%9F%E5%9B%A0%E9%83%BD%E4%BC%9A%E9%80%A0%E6%88%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%A2%AB%E5%85%B3%E9%97%AD"><span class="toc-number">1.9.3.7.</span> <span class="toc-text">当一个客户端通过网络连接连上了服务器，服务器就会为这个客户端创建相应的客户端状态，网络连接关闭，发送了不合协议格式的命令请求，称为CLient kill 命令的目标，空间时间超时，输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86Lua%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E5%88%9B%E5%BB%BA%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%9A%E4%B8%80%E7%9B%B4%E5%AD%98%E5%9C%A8%EF%BC%8C%E7%9F%A5%E9%81%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%97%AD"><span class="toc-number">1.9.3.8.</span> <span class="toc-text">处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，知道服务器关闭</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BD%E5%85%A5AOF%E6%96%87%E4%BB%B6%E6%97%B6%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E8%BD%BD%E5%85%A5%E5%B7%A5%E4%BD%9C%E5%BC%80%E5%A7%8B%E6%97%B6%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%EF%BC%8C%E8%BD%BD%E5%85%A5%E5%B7%A5%E4%BD%9C%E5%AE%8C%E6%AF%95%E4%B9%8B%E5%90%8E%E5%85%B3%E9%97%AD%E3%80%82"><span class="toc-number">1.9.3.9.</span> <span class="toc-text">载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Chapter-14-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.10.</span> <span class="toc-text">Chapter 14   服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.10.1.</span> <span class="toc-text">14.1   命令请求的执行过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5set%E6%93%8D%E4%BD%9C%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.10.1.1.</span> <span class="toc-text">以set操作为例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-1-%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82"><span class="toc-number">1.10.1.2.</span> <span class="toc-text">14.1.1  发送命令请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E6%9D%A5%E8%87%AARedis%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%BD%93%E7%94%A8%E6%88%B7%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%AD%E9%94%AE%E5%85%A5%E4%B8%80%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%97%B6%EF%BC%8C-x3D-x3D-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%9A%E5%B0%86%E8%BF%99%E4%B8%AA%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E8%BD%AC%E6%8D%A2%E6%88%90%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%A5%97%E6%8E%A5%E5%AD%97%EF%BC%8C%E5%B0%86%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E7%BB%99%E6%9C%8D%E5%8A%A1%E5%99%A8-x3D-x3D-%E3%80%82"><span class="toc-number">1.10.1.3.</span> <span class="toc-text">Redis服务器的命令请求来自Redis客户端，当用户在客户端中键入一个命令时，&#x3D;&#x3D;客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器&#x3D;&#x3D;。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-2-%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82"><span class="toc-number">1.10.1.4.</span> <span class="toc-text">14.1.2  读取命令请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-3-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%99%A8%EF%BC%881%EF%BC%89%EF%BC%9A-%E6%9F%A5%E6%89%BE%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.1.5.</span> <span class="toc-text">14.1.3     命令执行器（1）： 查找命令实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%99%A8%E8%A6%81%E5%81%9A%E7%9A%84%E7%AC%AC%E4%B8%80%E4%BB%B6%E4%BA%8B%E6%BF%80%E7%B4%A0%E6%A0%B9%E6%8D%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84argv-0-%E5%8F%82%E6%95%B0%EF%BC%8C%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%A8%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%8F%82%E6%95%B0%E6%89%80%E6%8C%87%E5%AE%9A%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B9%B6%E5%B0%86%E6%89%BE%E5%88%B0%E7%9A%84%E5%91%BD%E4%BB%A4%E4%BF%9D%E5%AD%98%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84cmd%E5%B1%9E%E6%80%A7%E9%87%8C%E3%80%82"><span class="toc-number">1.10.1.6.</span> <span class="toc-text">命令执行器要做的第一件事激素根据客户端状态的argv[0]参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-4-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%99%A8%EF%BC%882%EF%BC%89-%EF%BC%9A-%E6%89%A7%E8%A1%8C%E9%A2%84%E5%A4%87%E6%93%8D%E4%BD%9C"><span class="toc-number">1.10.1.7.</span> <span class="toc-text">14.1.4   命令执行器（2） ： 执行预备操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8A%E5%8F%AA%E5%88%97%E5%87%BA%E4%BA%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%97%B6%E7%9A%84%E4%BB%B7%E5%B7%AE%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%A8%E5%A4%8D%E5%88%B6%E6%88%96%E8%80%85%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%97%B6%EF%BC%8C%E9%A2%84%E5%A4%87%E6%93%8D%E4%BD%9C%E8%BF%98%E4%BC%9A%E6%9B%B4%E5%A4%9A%E4%B8%80%E7%82%B9"><span class="toc-number">1.10.1.8.</span> <span class="toc-text">以上只列出了服务器在单机模式下执行命令时的价差操作，当服务器在复制或者集群模式下执行命令时，预备操作还会更多一点..</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-5-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%99%A8-3-%E8%B0%83%E7%94%A8%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.1.9.</span> <span class="toc-text">14.1.5    命令执行器(3): 调用命令的实现函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-6-%E6%89%A7%E8%A1%8C%E5%90%8E%E7%BB%AD%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.10.1.10.</span> <span class="toc-text">14.1.6    执行后续工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-7-%E5%B0%86%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E5%8F%91%E9%80%81%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.10.1.11.</span> <span class="toc-text">14.1.7  将命令回复发送给客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-8-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E6%94%B6%E5%B9%B6%E6%89%93%E5%8D%B0%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D"><span class="toc-number">1.10.1.12.</span> <span class="toc-text">14.1.8  客户端接收并打印命令回复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-serverCron-%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.2.</span> <span class="toc-text">14.2  serverCron  函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%9A%84serverCron%E5%87%BD%E6%95%B0%E9%BB%98%E8%AE%A4%E6%AF%8F%E9%9A%94100ms%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1-%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E8%B4%9F%E8%B4%A3%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%B5%84%E6%BA%90-%E5%B9%B6%E4%BF%9D%E6%8C%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%87%AA%E8%BA%AB%E7%9A%84%E8%89%AF%E5%A5%BD%E8%BF%90%E8%BD%AC"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">Redis服务器中的serverCron函数默认每隔100ms执行一次,这个函数负责管理服务器的资源,并保持服务器自身的良好运转.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-1-%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%B6%E9%97%B4%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">14.2.1     更新服务器时间缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-2-%E6%9B%B4%E6%96%B0LRU-%E6%97%B6%E9%92%9F"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">14.2.2  更新LRU 时钟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-3-%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%AF%8F%E7%A7%92%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0"><span class="toc-number">1.10.2.4.</span> <span class="toc-text">14.2.3  更新服务器每秒执行次数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-4-%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98%E5%B3%B0%E5%80%BC%E8%AE%B0%E5%BD%95"><span class="toc-number">1.10.2.5.</span> <span class="toc-text">14.2.4   更新服务器内存峰值记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-5-%E5%A4%84%E7%90%86sigterm-%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.10.2.6.</span> <span class="toc-text">14.2.5  处理sigterm 信号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-6-%E7%AE%A1%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B5%84%E6%BA%90"><span class="toc-number">1.10.2.7.</span> <span class="toc-text">14.2.6  管理客户端资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#serverCron%E5%87%BD%E6%95%B0%E6%AF%8F%E6%AC%A1%E6%89%A7%E8%A1%8C%E9%83%BD%E4%BC%9A%E8%B0%83%E7%94%A8clientsCron%E5%87%BD%E6%95%B0-clientsCron%E5%87%BD%E6%95%B0%E4%BC%9A%E5%AF%B9%E4%B8%80%E5%AE%9A%E6%95%B0%E9%87%8F%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9B%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%B8%A4%E4%B8%AA%E6%A3%80%E6%9F%A5"><span class="toc-number">1.10.2.8.</span> <span class="toc-text">serverCron函数每次执行都会调用clientsCron函数,clientsCron函数会对一定数量的客户端进行以下两个检查:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%B7%B2%E7%BB%8F%E8%B6%85%E6%97%B6-%E5%BE%88%E9%95%BF%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E9%87%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%BD%E6%B2%A1%E6%9C%89%E4%BA%92%E5%8A%A8-%E9%82%A3%E4%B9%88%E7%A8%8B%E5%BA%8F%E9%87%8A%E6%94%BE%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.10.2.9.</span> <span class="toc-text">如果客户端与服务器之间的连接已经超时,很长一段时间里客户端和服务器都没有互动,那么程序释放这个客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E4%B8%8A%E4%B8%80%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E4%B9%8B%E5%90%8E-%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E8%B6%85%E8%BF%87%E4%BA%86%E4%B8%80%E5%AE%9A%E7%9A%84%E9%95%BF%E5%BA%A6-%E9%82%A3%E4%B9%88%E7%A8%8B%E5%BA%8F%E4%BC%9A%E9%87%8A%E6%94%BE%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BD%93%E5%89%8D%E7%9A%84%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA-%E5%B9%B6%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%BB%98%E8%AE%A4%E5%A4%A7%E5%B0%8F%E7%9A%84%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA-%E4%BB%8E%E8%80%8C%E9%98%B2%E6%AD%A2%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%BE%93%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA%E8%80%97%E8%B4%B9%E4%BA%86%E8%BF%87%E5%A4%9A%E7%9A%84%E5%86%85%E5%AD%98"><span class="toc-number">1.10.2.10.</span> <span class="toc-text">如果客户端在上一次执行命令请求之后,输入缓冲区的大小超过了一定的长度,那么程序会释放客户端当前的输入缓冲区,并重新创建一个默认大小的输入缓冲区,从而防止客户端的输入缓冲区耗费了过多的内存.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-7-%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%B5%84%E6%BA%90"><span class="toc-number">1.10.2.11.</span> <span class="toc-text">14.2.7   管理数据库资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#serverCron%E5%87%BD%E6%95%B0%E6%AF%8F%E6%AC%A1%E6%89%A7%E8%A1%8C%E9%83%BD%E4%BC%9A%E8%B0%83%E7%94%A8databasesCron%E5%87%BD%E6%95%B0-%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%BC%9A%E5%AF%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5-%E5%88%A0%E9%99%A4%E5%85%B6%E4%B8%AD%E7%9A%84%E8%BF%87%E6%9C%9F%E9%94%AE-%E5%B9%B6%E5%9C%A8%E6%9C%89%E9%9C%80%E8%A6%81%E7%9A%84%E6%97%B6%E5%80%99-%E5%AF%B9%E5%AD%97%E5%85%B8%E8%BF%9B%E8%A1%8C%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.10.2.12.</span> <span class="toc-text">serverCron函数每次执行都会调用databasesCron函数,这个函数会对服务器中的一部分数据库进行检查,删除其中的过期键,并在有需要的时候,对字典进行伸缩.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-8-%E6%89%A7%E8%A1%8C%E8%A2%AB%E5%BB%B6%E8%BF%9F%E7%9A%84BGREWRITEAOF"><span class="toc-number">1.10.2.13.</span> <span class="toc-text">14.2.8   执行被延迟的BGREWRITEAOF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1"><span class="toc-number">1.10.2.14.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-9-%E6%A3%80%E6%9F%A5%E6%8C%81%E4%B9%85%E5%8C%96%E6%93%8D%E4%BD%9C%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="toc-number">1.10.2.15.</span> <span class="toc-text">14.2.9      检查持久化操作的运行状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-10-%E5%B0%86AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5AOF%E6%96%87%E4%BB%B6"><span class="toc-number">1.10.2.16.</span> <span class="toc-text">14.2.10    将AOF缓冲区的内容写入AOF文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%90%AF%E4%BA%86AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%8A%9F%E8%83%BD-%E5%B9%B6%E4%B8%94AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E9%87%8C%E9%9D%A2%E8%BF%98%E6%9C%89%E5%BE%85%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE-%E9%82%A3%E4%B9%88serverCron%E5%87%BD%E6%95%B0%E4%BC%9A%E8%B0%83%E7%94%A8%E7%9B%B8%E5%BA%94%E7%9A%84%E7%A8%8B%E5%BA%8F-%E5%B0%86AOF%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5%E5%88%B0AOF%E6%96%87%E4%BB%B6%E9%87%8C%E9%9D%A2"><span class="toc-number">1.10.2.17.</span> <span class="toc-text">如果服务器开启了AOF持久化功能,并且AOF缓冲区里面还有待写入数据,那么serverCron函数会调用相应的程序,将AOF缓冲区的内容写入到AOF文件里面,</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-11-%E5%85%B3%E9%97%AD%E5%BC%82%E6%AD%A5%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.10.2.18.</span> <span class="toc-text">14.2.11   关闭异步客户端.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%BF%99%E4%B8%80%E6%AD%A5-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%9A%E5%85%B3%E9%97%AD%E9%82%A3%E4%BA%9B%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F%E8%B6%85%E5%87%BA%E9%99%90%E5%88%B6%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.10.2.19.</span> <span class="toc-text">在这一步,服务器会关闭那些输出缓冲区大小超出限制的客户端,</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2-12-%E5%A2%9E%E5%8A%A0cronloops-%E8%AE%A1%E6%95%B0%E5%99%A8%E7%9A%84%E5%80%BC"><span class="toc-number">1.10.2.20.</span> <span class="toc-text">14.2.12    增加cronloops 计数器的值.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.10.3.</span> <span class="toc-text">14.3     初始化服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">14.3.1  初始化服务器的状态结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3-2-%E8%BD%BD%E5%85%A5%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">1.10.3.2.</span> <span class="toc-text">14.3.2  载入配置选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3-3-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.10.3.3.</span> <span class="toc-text">14.3.3  初始化服务器数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3-4-%E8%BF%98%E5%8E%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81"><span class="toc-number">1.10.3.4.</span> <span class="toc-text">14.3.4  还原数据库状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3-5-%E6%89%A7%E8%A1%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.10.3.5.</span> <span class="toc-text">14.3.5     执行事件循环</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-4-%E9%87%8D%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.10.4.</span> <span class="toc-text">14.4     重点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E4%BB%8E%E5%8F%91%E9%80%81%E5%88%B0%E5%AE%8C%E6%88%90%E4%B8%BB%E8%A6%81%E5%8C%85%E6%8B%AC%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%EF%BC%9A1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%86%E6%89%A7%E8%A1%8C%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E7%BB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%822%E3%80%82%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%B9%B6%E5%88%86%E6%9E%90%E5%87%BA%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%EF%BC%8C3%E3%80%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%99%A8%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E6%9F%A5%E6%89%BE%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%A7%E8%A1%8C%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E5%B9%B6%E5%BE%97%E5%87%BA%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E3%80%824-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E8%BF%94%E5%9B%9E%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">一个命令请求从发送到完成主要包括以下步骤：1.客户端将执行的命令请求发送给服务器。2。服务器读取命令请求，并分析出命令参数，3、命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复。4.服务器将命令回复返回给客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#serverCron%E5%87%BD%E6%95%B0%E9%BB%98%E8%AE%A4%E6%AF%8F%E9%9A%94100ms%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%AE%83%E7%9A%84%E5%B7%A5%E4%BD%9C%E4%B8%BB%E8%A6%81%E5%8C%85%E6%8B%AC%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%A4%84%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A5%E6%94%B6%E7%9A%84sigtrem%E4%BF%A1%E5%8F%B7%EF%BC%8C%E7%AE%A1%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B5%84%E6%BA%90%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%B9%B6%E6%A3%80%E6%9F%A5%E6%8C%81%E4%B9%85%E5%8C%96%E6%93%8D%E4%BD%9C%E7%AD%89%E3%80%82"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">serverCron函数默认每隔100ms执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的sigtrem信号，管理客户端资源和数据库状态，执行并检查持久化操作等。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E8%83%BD%E5%A4%9F%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%EF%BC%8C1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%EF%BC%8C2-%E8%BD%BD%E5%85%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%EF%BC%8C3-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C4-%E8%BF%98%E5%8E%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81%E3%80%825-%E6%89%A7%E8%A1%8C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E3%80%82%E3%80%82"><span class="toc-number">1.10.4.3.</span> <span class="toc-text">服务器从启动到能够处理客户端的命令请求需要执行以下步骤，1.初始化服务器状态，2.载入服务器配置，3.初始化服务器数据结构，4.还原数据库状态。5.执行事件循环。。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86-%E5%A4%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.</span> <span class="toc-text">第三部分   多数据库的实现</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/03/ASMR/" title="ASMR"><img src="/image/suzy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ASMR"/></a><div class="content"><a class="title" href="/2023/06/03/ASMR/" title="ASMR">ASMR</a><time datetime="2023-06-03T09:55:52.000Z" title="发表于 2023-06-03 17:55:52">2023-06-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/25/git/" title="git"><img src="/image/suzy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="git"/></a><div class="content"><a class="title" href="/2022/10/25/git/" title="git">git</a><time datetime="2022-10-25T12:47:34.000Z" title="发表于 2022-10-25 20:47:34">2022-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/19/mybatis/" title="mybatis"><img src="/image/suzy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mybatis"/></a><div class="content"><a class="title" href="/2022/10/19/mybatis/" title="mybatis">mybatis</a><time datetime="2022-10-19T15:32:43.000Z" title="发表于 2022-10-19 23:32:43">2022-10-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/18/Docker/" title="Docker"><img src="/image/suzy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker"/></a><div class="content"><a class="title" href="/2022/10/18/Docker/" title="Docker">Docker</a><time datetime="2022-10-18T03:29:39.000Z" title="发表于 2022-10-18 11:29:39">2022-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95/" title="计算机网络面试"><img src="/image/suzy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络面试"/></a><div class="content"><a class="title" href="/2022/10/17/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95/" title="计算机网络面试">计算机网络面试</a><time datetime="2022-10-17T11:42:27.000Z" title="发表于 2022-10-17 19:42:27">2022-10-17</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ovesh</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'b148acfa2ad0ea4de66f',
      clientSecret: 'ca24ef753b84ddbbe4649e22bceb5d576db878bb',
      repo: 'Oveshh.github.io',
      owner: 'Oveshh',
      admin: ['Oveshh'],
      id: '11bf1ecd1027443553b8e895205d0227',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://example.com/2022/10/15/Redis/'
    this.page.identifier = '/2022/10/15/Redis/'
    this.page.title = 'Redis'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Gitalk' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>